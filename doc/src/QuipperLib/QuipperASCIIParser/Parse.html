<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-2"></a><font color=Blue><i>-- | This module contains the code for parsing the ASCII output from</i></font>
<a name="line-3"></a><font color=Blue><i>-- Quipper, into a GatePlus.</i></font>
<a name="line-4"></a><font color=Blue><i>-- This program is heavily based on, and heavily borrows from the QCLParser.</i></font>
<a name="line-5"></a>
<a name="line-6"></a><font color=Green><u>module</u></font> QuipperLib<font color=Cyan>.</font>QuipperASCIIParser<font color=Cyan>.</font>Parse <font color=Green><u>where</u></font>
<a name="line-7"></a>
<a name="line-8"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Circuit
<a name="line-9"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>IntMap hiding <font color=Cyan>(</font>map<font color=Cyan>)</font>
<a name="line-10"></a>
<a name="line-11"></a><font color=Green><u>import</u></font> Text<font color=Cyan>.</font>ParserCombinators<font color=Cyan>.</font>ReadP
<a name="line-12"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Char <font color=Cyan>(</font>isDigit<font color=Cyan>)</font>
<a name="line-13"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Map <font color=Green><u>as</u></font> Map
<a name="line-14"></a>
<a name="line-15"></a><a name="GatePlus"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-16"></a><a name="GatePlus"></a><font color=Blue><i>-- | A type for gates, plus other circuit output, empty lines, and subroutine defs.</i></font>
<a name="line-17"></a><a name="GatePlus"></a><font color=Green><u>data</u></font> GatePlus <font color=Red>=</font> G Gate <font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-18"></a>              <font color=Red>|</font> I <font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-19"></a>              <font color=Red>|</font> O <font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-20"></a>              <font color=Red>|</font> EmptyLine
<a name="line-21"></a>              <font color=Red>|</font> CommentLine String
<a name="line-22"></a>              <font color=Red>|</font> SubroutineName String
<a name="line-23"></a>	      <font color=Red>|</font> SubroutineShape String
<a name="line-24"></a>              <font color=Red>|</font> Controllable ControllableFlag
<a name="line-25"></a> <font color=Green><u>deriving</u></font> Show
<a name="line-26"></a>
<a name="line-27"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-28"></a><font color=Blue><i>-- * Parsing</i></font>
<a name="line-29"></a>
<a name="line-30"></a><a name="string_literal"></a><font color=Blue><i>-- | Parse a string literal. </i></font>
<a name="line-31"></a><font color=Blue>string_literal</font> <font color=Red>::</font> ReadP String
<a name="line-32"></a><font color=Blue>string_literal</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-33"></a>  char <font color=Magenta>'"'</font>
<a name="line-34"></a>  s <font color=Red>&lt;-</font> string_with_escaped_chars <font color=Magenta>""</font>
<a name="line-35"></a>  char <font color=Magenta>'"'</font>
<a name="line-36"></a>  return s
<a name="line-37"></a> <font color=Green><u>where</u></font>
<a name="line-38"></a>  string_with_escaped_chars <font color=Red>::</font> String <font color=Red>-&gt;</font> ReadP String
<a name="line-39"></a>  string_with_escaped_chars input <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-40"></a>   s <font color=Red>&lt;-</font> munch <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> x <font color=Cyan>/=</font> <font color=Magenta>'\\'</font> <font color=Cyan>&amp;&amp;</font> x <font color=Cyan>/=</font> <font color=Magenta>'"'</font><font color=Cyan>)</font>
<a name="line-41"></a>   <font color=Green><u>let</u></font> s'  <font color=Red>=</font> input <font color=Cyan>++</font> s
<a name="line-42"></a>   rest <font color=Red>&lt;-</font> look
<a name="line-43"></a>   <font color=Green><u>case</u></font> rest <font color=Green><u>of</u></font>
<a name="line-44"></a>    <font color=Magenta>'"'</font> <font color=Red><b>:</b></font> <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> return s'
<a name="line-45"></a>    <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-46"></a>      e <font color=Red>&lt;-</font> escaped_char
<a name="line-47"></a>      string_with_escaped_chars <font color=Cyan>(</font>s' <font color=Cyan>++</font> <font color=Red>[</font>e<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-48"></a>    <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-49"></a>      pfail
<a name="line-50"></a>
<a name="line-51"></a><a name="escaped_char"></a><font color=Blue><i>-- | Parse an escaped character, such as @\0@, @\n@, @\\@, etc.</i></font>
<a name="line-52"></a><font color=Blue>escaped_char</font> <font color=Red>::</font> ReadP Char
<a name="line-53"></a><font color=Blue>escaped_char</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-54"></a>  char <font color=Magenta>'\\'</font>
<a name="line-55"></a>  c <font color=Red>&lt;-</font> get
<a name="line-56"></a>  return <font color=Cyan>(</font>Map<font color=Cyan>.</font>findWithDefault c c map<font color=Cyan>)</font>
<a name="line-57"></a>  <font color=Green><u>where</u></font>
<a name="line-58"></a>    <font color=Blue><i>-- The official escape codes. We allow any other escaped character</i></font>
<a name="line-59"></a>    <font color=Blue><i>-- to denote itself. We do not permit "\&amp;" to denote the empty string.</i></font>
<a name="line-60"></a>    map <font color=Red>=</font> Map<font color=Cyan>.</font>fromList <font color=Red>[</font>
<a name="line-61"></a>      <font color=Cyan>(</font><font color=Magenta>'0'</font><font color=Cyan>,</font> <font color=Magenta>'\0'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-62"></a>      <font color=Cyan>(</font><font color=Magenta>'a'</font><font color=Cyan>,</font> <font color=Magenta>'\a'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-63"></a>      <font color=Cyan>(</font><font color=Magenta>'b'</font><font color=Cyan>,</font> <font color=Magenta>'\b'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-64"></a>      <font color=Cyan>(</font><font color=Magenta>'f'</font><font color=Cyan>,</font> <font color=Magenta>'\f'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-65"></a>      <font color=Cyan>(</font><font color=Magenta>'n'</font><font color=Cyan>,</font> <font color=Magenta>'\n'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-66"></a>      <font color=Cyan>(</font><font color=Magenta>'r'</font><font color=Cyan>,</font> <font color=Magenta>'\r'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-67"></a>      <font color=Cyan>(</font><font color=Magenta>'t'</font><font color=Cyan>,</font> <font color=Magenta>'\t'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-68"></a>      <font color=Cyan>(</font><font color=Magenta>'v'</font><font color=Cyan>,</font> <font color=Magenta>'\v'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-69"></a>      <font color=Cyan>(</font><font color=Magenta>'"'</font><font color=Cyan>,</font> <font color=Magenta>'\"'</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-70"></a>      <font color=Cyan>(</font><font color=Magenta>'\''</font><font color=Cyan>,</font> <font color=Magenta>'\''</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-71"></a>      <font color=Cyan>(</font><font color=Magenta>'\\'</font><font color=Cyan>,</font> <font color=Magenta>'\\'</font><font color=Cyan>)</font>
<a name="line-72"></a>      <font color=Red>]</font>
<a name="line-73"></a>
<a name="line-74"></a><a name="int"></a><font color=Blue><i>-- | Parse a signless integer. We avoid the usual trick ('readS_to_P'</i></font>
<a name="line-75"></a><font color=Blue><i>-- 'reads'), because this introduces backtracking errors.</i></font>
<a name="line-76"></a><font color=Blue>int</font> <font color=Red>::</font> ReadP Int
<a name="line-77"></a><font color=Blue>int</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-78"></a>  s <font color=Red>&lt;-</font> munch1 isDigit
<a name="line-79"></a>  return <font color=Cyan>$</font> <font color=Cyan>(</font>read s <font color=Red>::</font> Int<font color=Cyan>)</font>
<a name="line-80"></a>
<a name="line-81"></a><a name="double"></a><font color=Blue><i>-- | Parse a floating point number. We avoid the usual trick</i></font>
<a name="line-82"></a><font color=Blue><i>-- ('readS_to_P' 'reads'), because this introduces backtracking</i></font>
<a name="line-83"></a><font color=Blue><i>-- errors.</i></font>
<a name="line-84"></a><font color=Blue>double</font> <font color=Red>::</font> ReadP Double
<a name="line-85"></a><font color=Blue>double</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-86"></a>  <font color=Cyan>(</font>s<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>&lt;-</font> gather parse_double
<a name="line-87"></a>  return <font color=Cyan>$</font> <font color=Cyan>(</font>read s <font color=Red>::</font> Double<font color=Cyan>)</font>
<a name="line-88"></a>  <font color=Green><u>where</u></font>
<a name="line-89"></a>    parse_double <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-90"></a>      option <font color=Magenta>'+'</font> <font color=Cyan>(</font>char <font color=Magenta>'+'</font> <font color=Cyan>+++</font> char <font color=Magenta>'-'</font><font color=Cyan>)</font>
<a name="line-91"></a>      munch isDigit
<a name="line-92"></a>      optional <font color=Cyan>(</font>char <font color=Magenta>'.'</font> <font color=Cyan>&gt;&gt;</font> munch1 isDigit<font color=Cyan>)</font>
<a name="line-93"></a>      optional <font color=Cyan>(</font>char <font color=Magenta>'e'</font> <font color=Cyan>&gt;&gt;</font> option <font color=Magenta>'+'</font> <font color=Cyan>(</font>char <font color=Magenta>'+'</font> <font color=Cyan>+++</font> char <font color=Magenta>'-'</font><font color=Cyan>)</font> <font color=Cyan>&gt;&gt;</font> int<font color=Cyan>)</font>
<a name="line-94"></a>      
<a name="line-95"></a><a name="commalist"></a><font color=Blue><i>-- | Parse a comma separated list.</i></font>
<a name="line-96"></a><font color=Blue>commalist</font> <font color=Red>::</font> ReadP a <font color=Red>-&gt;</font> ReadP <font color=Red>[</font>a<font color=Red>]</font>
<a name="line-97"></a><font color=Blue>commalist</font> elt <font color=Red>=</font> sepBy elt <font color=Cyan>(</font>skipSpaces <font color=Cyan>&gt;&gt;</font> char <font color=Magenta>','</font> <font color=Cyan>&gt;&gt;</font> skipSpaces<font color=Cyan>)</font>
<a name="line-98"></a>
<a name="line-99"></a><a name="control"></a><font color=Blue><i>-- | Parse a control structure.</i></font>
<a name="line-100"></a><font color=Blue>control</font> <font color=Red>::</font> ReadP <font color=Cyan>(</font>Signed Wire<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font>
<a name="line-101"></a><font color=Blue>control</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-102"></a>  val <font color=Red>&lt;-</font> choice <font color=Red>[</font>char <font color=Magenta>'+'</font><font color=Cyan>,</font>char <font color=Magenta>'-'</font><font color=Red>]</font>
<a name="line-103"></a>  skipSpaces
<a name="line-104"></a>  w <font color=Red>&lt;-</font> int
<a name="line-105"></a>  c <font color=Red>&lt;-</font> option <font color=Magenta>'q'</font> <font color=Cyan>(</font>char <font color=Magenta>'c'</font><font color=Cyan>)</font>
<a name="line-106"></a>  <font color=Green><u>let</u></font> wt <font color=Red>=</font> <font color=Green><u>case</u></font> c <font color=Green><u>of</u></font>
<a name="line-107"></a>            <font color=Magenta>'c'</font> <font color=Red>-&gt;</font> Cbit
<a name="line-108"></a>            <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> Qbit
<a name="line-109"></a>  return <font color=Cyan>(</font>Signed w <font color=Cyan>(</font>val <font color=Cyan>==</font> <font color=Magenta>'+'</font><font color=Cyan>)</font><font color=Cyan>,</font>wt<font color=Cyan>)</font>
<a name="line-110"></a>
<a name="line-111"></a><a name="controls"></a><font color=Blue><i>-- | Parse a list of controls.</i></font>
<a name="line-112"></a><font color=Blue>controls</font> <font color=Red>::</font> ReadP <font color=Cyan>(</font><font color=Red>[</font>Signed Wire<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-113"></a><font color=Blue>controls</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-114"></a>  skipSpaces
<a name="line-115"></a>  string <font color=Magenta>"with controls=["</font>
<a name="line-116"></a>  cwts <font color=Red>&lt;-</font> commalist control
<a name="line-117"></a>  char <font color=Magenta>']'</font>
<a name="line-118"></a>  <font color=Green><u>let</u></font> cs <font color=Red>=</font> map fst cwts
<a name="line-119"></a>  <font color=Green><u>let</u></font> wts <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>Signed w <font color=Green><u>_</u></font><font color=Cyan>,</font>wt<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>w<font color=Cyan>,</font>wt<font color=Cyan>)</font><font color=Cyan>)</font> cwts
<a name="line-120"></a>  return <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font>
<a name="line-121"></a>
<a name="line-122"></a><a name="wiretype"></a><font color=Blue><i>-- | Parse a 'Wiretype'.</i></font>
<a name="line-123"></a><font color=Blue>wiretype</font> <font color=Red>::</font> ReadP Wiretype
<a name="line-124"></a><font color=Blue>wiretype</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-125"></a>  c <font color=Red>&lt;-</font> choice <font color=Red>[</font>string <font color=Magenta>"Qbit"</font><font color=Cyan>,</font>string <font color=Magenta>"Cbit"</font><font color=Red>]</font>
<a name="line-126"></a>  <font color=Green><u>case</u></font> c <font color=Green><u>of</u></font>
<a name="line-127"></a>    <font color=Magenta>"Qbit"</font> <font color=Red>-&gt;</font> return Qbit
<a name="line-128"></a>    <font color=Magenta>"Cbit"</font> <font color=Red>-&gt;</font> return Cbit
<a name="line-129"></a>    <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> error <font color=Magenta>"The impossible has happened"</font>
<a name="line-130"></a>
<a name="line-131"></a><a name="wire"></a><font color=Blue><i>-- | Parse a wire and its type.</i></font>
<a name="line-132"></a><font color=Blue>wire</font> <font color=Red>::</font> ReadP <font color=Cyan>(</font>Int<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font>
<a name="line-133"></a><font color=Blue>wire</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-134"></a>  skipSpaces
<a name="line-135"></a>  w <font color=Red>&lt;-</font> int
<a name="line-136"></a>  char <font color=Magenta>':'</font>
<a name="line-137"></a>  t <font color=Red>&lt;-</font> wiretype
<a name="line-138"></a>  return <font color=Cyan>(</font>w<font color=Cyan>,</font>t<font color=Cyan>)</font>
<a name="line-139"></a>
<a name="line-140"></a><a name="wires"></a><font color=Blue><i>-- | Parse a list of input/output wires and types.</i></font>
<a name="line-141"></a><font color=Blue>wires</font> <font color=Red>::</font> ReadP <font color=Red>[</font><font color=Cyan>(</font>Int<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-142"></a><font color=Blue>wires</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-143"></a>  skipSpaces
<a name="line-144"></a>  ws <font color=Red>&lt;-</font> commalist wire
<a name="line-145"></a>  return ws
<a name="line-146"></a>
<a name="line-147"></a><a name="none"></a><font color=Blue><i>-- | Parse the string \"none\", </i></font>
<a name="line-148"></a><font color=Blue><i>-- returning an empty list of input/output wires and types.</i></font>
<a name="line-149"></a><font color=Blue>none</font> <font color=Red>::</font> ReadP <font color=Red>[</font><font color=Cyan>(</font>Int<font color=Cyan>,</font>Wiretype<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-150"></a><font color=Blue>none</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-151"></a>  skipSpaces
<a name="line-152"></a>  string <font color=Magenta>"none"</font>
<a name="line-153"></a>  return []
<a name="line-154"></a>
<a name="line-155"></a><a name="inversechar"></a><font color=Blue><i>-- | Consume an optional \"*\". Return 'True' if consumed, and 'False'</i></font>
<a name="line-156"></a><font color=Blue><i>-- otherwise.</i></font>
<a name="line-157"></a><font color=Blue>inversechar</font> <font color=Red>::</font> ReadP Bool  
<a name="line-158"></a><font color=Blue>inversechar</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-159"></a>  c <font color=Red>&lt;-</font> option <font color=Magenta>'+'</font> <font color=Cyan>(</font>char <font color=Magenta>'*'</font><font color=Cyan>)</font>
<a name="line-160"></a>  return <font color=Cyan>(</font>c <font color=Cyan>==</font> <font color=Magenta>'*'</font><font color=Cyan>)</font>
<a name="line-161"></a>
<a name="line-162"></a><a name="label'"></a><font color=Blue><i>-- | Consume a label.</i></font>
<a name="line-163"></a><font color=Blue>label'</font> <font color=Red>::</font> ReadP <font color=Cyan>(</font>Int<font color=Cyan>,</font>String<font color=Cyan>)</font>
<a name="line-164"></a><font color=Blue>label'</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-165"></a>  w <font color=Red>&lt;-</font> int
<a name="line-166"></a>  char <font color=Magenta>':'</font>
<a name="line-167"></a>  lab <font color=Red>&lt;-</font> string_literal
<a name="line-168"></a>  return <font color=Cyan>(</font>w<font color=Cyan>,</font>lab<font color=Cyan>)</font>
<a name="line-169"></a>
<a name="line-170"></a><a name="labelchar"></a><font color=Blue><i>-- | Consumer any character other than \')\', \']\', or \',\'.</i></font>
<a name="line-171"></a><font color=Blue>labelchar</font> <font color=Red>::</font> ReadP String
<a name="line-172"></a><font color=Blue>labelchar</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-173"></a>  c <font color=Red>&lt;-</font> satisfy <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> not <font color=Cyan>(</font>x <font color=Cyan>`elem`</font> <font color=Magenta>")],"</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-174"></a>  return <font color=Red>[</font>c<font color=Red>]</font>
<a name="line-175"></a>
<a name="line-176"></a><a name="labelbracket"></a><font color=Blue><i>-- | Consume an index of the form [...].</i></font>
<a name="line-177"></a><font color=Blue>labelbracket</font> <font color=Red>::</font> ReadP String
<a name="line-178"></a><font color=Blue>labelbracket</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-179"></a>  char <font color=Magenta>'['</font>
<a name="line-180"></a>  s <font color=Red>&lt;-</font> munch <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> not <font color=Cyan>(</font>x <font color=Cyan>`elem`</font> <font color=Magenta>"[]"</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-181"></a>  char <font color=Magenta>']'</font>
<a name="line-182"></a>  return <font color=Cyan>(</font><font color=Magenta>"["</font> <font color=Cyan>++</font> s <font color=Cyan>++</font> <font color=Magenta>"]"</font><font color=Cyan>)</font>
<a name="line-183"></a>
<a name="line-184"></a><a name="labels"></a><font color=Blue><i>-- | Consume a list of labels.</i></font>
<a name="line-185"></a><font color=Blue>labels</font> <font color=Red>::</font> ReadP <font color=Red>[</font><font color=Cyan>(</font>Int<font color=Cyan>,</font>String<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-186"></a><font color=Blue>labels</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-187"></a>    skipSpaces
<a name="line-188"></a>    char <font color=Magenta>'('</font>
<a name="line-189"></a>    ls <font color=Red>&lt;-</font> commalist label'
<a name="line-190"></a>    char <font color=Magenta>')'</font>
<a name="line-191"></a>    return ls
<a name="line-192"></a>
<a name="line-193"></a><a name="box_id"></a><font color=Blue><i>-- | Consume a 'BoxId' followed by a \']\' character.</i></font>
<a name="line-194"></a><font color=Blue><i>{-
<a name="line-195"></a>ascii_of_boxid (BoxId name shape) = show name ++ ", shape " ++ show shape
<a name="line-196"></a>-}</i></font>
<a name="line-197"></a><font color=Blue>box_id</font> <font color=Red>::</font> ReadP BoxId
<a name="line-198"></a><font color=Blue>box_id</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-199"></a>   name <font color=Red>&lt;-</font> string_literal
<a name="line-200"></a>   skipSpaces
<a name="line-201"></a>   char <font color=Magenta>','</font>
<a name="line-202"></a>   skipSpaces
<a name="line-203"></a>   string <font color=Magenta>"shape"</font>
<a name="line-204"></a>   skipSpaces
<a name="line-205"></a>   shape <font color=Red>&lt;-</font> string_literal
<a name="line-206"></a>   return <font color=Cyan>(</font>BoxId name shape<font color=Cyan>)</font>
<a name="line-207"></a>
<a name="line-208"></a><a name="nocontrolflag"></a><font color=Blue><i>-- | Consume an optional 'NoControlFlag', returning 'False' if it isn't present.</i></font>
<a name="line-209"></a><font color=Blue>nocontrolflag</font> <font color=Red>::</font> ReadP NoControlFlag
<a name="line-210"></a><font color=Blue>nocontrolflag</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-211"></a> skipSpaces
<a name="line-212"></a> ncf <font color=Red>&lt;-</font> option <font color=Magenta>""</font> <font color=Cyan>(</font>string <font color=Magenta>"with nocontrol"</font><font color=Cyan>)</font>
<a name="line-213"></a> return <font color=Cyan>(</font>ncf <font color=Cyan>==</font> <font color=Magenta>"with nocontrol"</font><font color=Cyan>)</font>
<a name="line-214"></a>
<a name="line-215"></a><a name="ascii_line"></a><font color=Blue><i>-- | Parse a single line of ASCII output into a 'Gate'. This function needs to be</i></font>
<a name="line-216"></a><font color=Blue><i>-- kept in line with Quipper's 'ascii_render_gate' function.</i></font>
<a name="line-217"></a><font color=Blue>ascii_line</font> <font color=Red>::</font> ReadP GatePlus
<a name="line-218"></a><font color=Blue>ascii_line</font> <font color=Red>=</font> choice <font color=Red>[</font>
<a name="line-219"></a>    <font color=Green><u>do</u></font> <font color=Blue><i>-- Inputs: w:Type, w:Type ...</i></font>
<a name="line-220"></a>    string <font color=Magenta>"Inputs:"</font>
<a name="line-221"></a>    ws <font color=Red>&lt;-</font> choice <font color=Red>[</font>wires<font color=Cyan>,</font>none<font color=Red>]</font>
<a name="line-222"></a>    eof
<a name="line-223"></a>    return <font color=Cyan>(</font>I ws<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-224"></a>    <font color=Green><u>do</u></font> <font color=Blue><i>-- Outputs: w:Type, w:Type ...</i></font>
<a name="line-225"></a>    string <font color=Magenta>"Outputs:"</font>
<a name="line-226"></a>    ws <font color=Red>&lt;-</font> choice <font color=Red>[</font>wires<font color=Cyan>,</font>none<font color=Red>]</font>
<a name="line-227"></a>    eof
<a name="line-228"></a>    return <font color=Cyan>(</font>O ws<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-229"></a>    <font color=Green><u>do</u></font> <font color=Blue><i>-- An empty line can be parsed as an EmptyLine</i></font>
<a name="line-230"></a>    skipSpaces
<a name="line-231"></a>    eof
<a name="line-232"></a>    return EmptyLine<font color=Cyan>,</font>
<a name="line-233"></a>    <font color=Green><u>do</u></font> <font color=Blue><i>-- "A comment in a circuit is any line beginnning with a # character"</i></font>
<a name="line-234"></a>    <font color=Blue><i>-- The comment is stored for later use as a CommentLine</i></font>
<a name="line-235"></a>    skipSpaces
<a name="line-236"></a>    char <font color=Magenta>'#'</font>
<a name="line-237"></a>    skipSpaces
<a name="line-238"></a>    comment <font color=Red>&lt;-</font> manyTill <font color=Cyan>(</font>satisfy <font color=Cyan>(</font><font color=Red>\</font><font color=Green><u>_</u></font> <font color=Red>-&gt;</font> True<font color=Cyan>)</font><font color=Cyan>)</font> eof
<a name="line-239"></a>    eof
<a name="line-240"></a>    return <font color=Cyan>(</font>CommentLine comment<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-241"></a>    <font color=Green><u>do</u></font> <font color=Blue><i>-- Subroutine: "name" (keeping unquoted version for backward comp.)</i></font>
<a name="line-242"></a>    string <font color=Magenta>"Subroutine: "</font>
<a name="line-243"></a>    name <font color=Red>&lt;-</font> string_literal <font color=Cyan>+++</font> manyTill <font color=Cyan>(</font>satisfy <font color=Cyan>(</font><font color=Red>\</font><font color=Green><u>_</u></font> <font color=Red>-&gt;</font> True<font color=Cyan>)</font><font color=Cyan>)</font> eof
<a name="line-244"></a>    eof
<a name="line-245"></a>    return <font color=Cyan>(</font>SubroutineName name<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-246"></a>    <font color=Green><u>do</u></font> <font color=Blue><i>-- Shape: "shape" (keeping unquoted version for backward comp.)</i></font>
<a name="line-247"></a>    string <font color=Magenta>"Shape: "</font>
<a name="line-248"></a>    shape <font color=Red>&lt;-</font> string_literal <font color=Cyan>+++</font> manyTill <font color=Cyan>(</font>satisfy <font color=Cyan>(</font><font color=Red>\</font><font color=Green><u>_</u></font> <font color=Red>-&gt;</font> True<font color=Cyan>)</font><font color=Cyan>)</font> eof
<a name="line-249"></a>    eof
<a name="line-250"></a>    return <font color=Cyan>(</font>SubroutineShape shape<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-251"></a>    <font color=Green><u>do</u></font> <font color=Blue><i>-- Controllable: yes/no/classically</i></font>
<a name="line-252"></a>    string <font color=Magenta>"Controllable: "</font>
<a name="line-253"></a>    val_string <font color=Red>&lt;-</font> choice <font color=Red>[</font>string <font color=Magenta>"yes"</font><font color=Cyan>,</font>string <font color=Magenta>"no"</font><font color=Cyan>,</font> string <font color=Magenta>"classically"</font><font color=Red>]</font>
<a name="line-254"></a>    <font color=Green><u>let</u></font> val <font color=Red>=</font> <font color=Green><u>case</u></font> val_string <font color=Green><u>of</u></font>
<a name="line-255"></a>               <font color=Magenta>"yes"</font> <font color=Red>-&gt;</font> AllCtl
<a name="line-256"></a>               <font color=Magenta>"no"</font> <font color=Red>-&gt;</font> NoCtl
<a name="line-257"></a>               <font color=Magenta>"classically"</font> <font color=Red>-&gt;</font> OnlyClassicalCtl
<a name="line-258"></a>               <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> error <font color=Magenta>"The impossible happened"</font>
<a name="line-259"></a>    eof
<a name="line-260"></a>    return <font color=Cyan>(</font>Controllable val<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-261"></a><font color=Blue><i>{-
<a name="line-262"></a>For backward compatibility:
<a name="line-263"></a>ascii_render_gate (QNot w c ncf) = 
<a name="line-264"></a>  "QNot(" ++ show w ++ ")" 
<a name="line-265"></a>  ++ ascii_render_controls wtm c 
<a name="line-266"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-267"></a>-}</i></font>
<a name="line-268"></a>    <font color=Green><u>do</u></font> 
<a name="line-269"></a>    string <font color=Magenta>"QNot("</font>
<a name="line-270"></a>    w <font color=Red>&lt;-</font> int
<a name="line-271"></a>    char <font color=Magenta>')'</font>
<a name="line-272"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-273"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-274"></a>    eof
<a name="line-275"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QGate <font color=Magenta>"not"</font> False <font color=Red>[</font>w<font color=Red>]</font> [] cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-276"></a><font color=Blue><i>{-
<a name="line-277"></a>For backward compatibility:
<a name="line-278"></a>ascii_render_gate (QMultinot ws c ncf) = 
<a name="line-279"></a>  "QMultinot(" ++ string_of_list "" ", " "" "" show ws ++ ")" 
<a name="line-280"></a>  ++ ascii_render_controls wtm c 
<a name="line-281"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-282"></a>-}</i></font>
<a name="line-283"></a>    <font color=Green><u>do</u></font>
<a name="line-284"></a>    string <font color=Magenta>"QMultinot("</font>
<a name="line-285"></a>    ws <font color=Red>&lt;-</font> commalist int
<a name="line-286"></a>    char <font color=Magenta>')'</font>
<a name="line-287"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-288"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-289"></a>    eof
<a name="line-290"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QGate <font color=Magenta>"multinot"</font> False ws [] cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>    
<a name="line-291"></a><font color=Blue><i>{-
<a name="line-292"></a>For backward compatibility:
<a name="line-293"></a>ascii_render_gate (QHad w c ncf) = 
<a name="line-294"></a>  "QHad(" ++ show w ++ ")" 
<a name="line-295"></a>  ++ ascii_render_controls wtm c 
<a name="line-296"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-297"></a>-}</i></font>
<a name="line-298"></a>    <font color=Green><u>do</u></font>
<a name="line-299"></a>    string <font color=Magenta>"QHad("</font>
<a name="line-300"></a>    w <font color=Red>&lt;-</font> int
<a name="line-301"></a>    char <font color=Magenta>')'</font>
<a name="line-302"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-303"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-304"></a>    eof
<a name="line-305"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QGate <font color=Magenta>"H"</font> False <font color=Red>[</font>w<font color=Red>]</font> [] cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-306"></a><font color=Blue><i>{-
<a name="line-307"></a>For backward compatibility:
<a name="line-308"></a>ascii_render_gate (QSwap w1 w2 c ncf) = 
<a name="line-309"></a>  "QSwap(" ++ show w1 ++ "," ++ show w2 ++ ")" 
<a name="line-310"></a>  ++ ascii_render_controls wtm c 
<a name="line-311"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-312"></a>-}</i></font>
<a name="line-313"></a>    <font color=Green><u>do</u></font>
<a name="line-314"></a>    string <font color=Magenta>"QSwap("</font>
<a name="line-315"></a>    w1 <font color=Red>&lt;-</font> int
<a name="line-316"></a>    char <font color=Magenta>','</font>
<a name="line-317"></a>    w2 <font color=Red>&lt;-</font> int
<a name="line-318"></a>    char <font color=Magenta>')'</font>
<a name="line-319"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-320"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-321"></a>    eof
<a name="line-322"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QGate <font color=Magenta>"swap"</font> False <font color=Red>[</font>w1<font color=Cyan>,</font> w2<font color=Red>]</font> [] cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-323"></a><font color=Blue><i>{-
<a name="line-324"></a>For backward compatibility:
<a name="line-325"></a>ascii_render_gate (QW w1 w2 c ncf) = 
<a name="line-326"></a>  "QW(" ++ show w1 ++ "," ++ show w2 ++ ")" 
<a name="line-327"></a>  ++ ascii_render_controls wtm c 
<a name="line-328"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-329"></a>-}</i></font>
<a name="line-330"></a>    <font color=Green><u>do</u></font>
<a name="line-331"></a>    string <font color=Magenta>"QW("</font>
<a name="line-332"></a>    w1 <font color=Red>&lt;-</font> int
<a name="line-333"></a>    char <font color=Magenta>','</font>
<a name="line-334"></a>    w2 <font color=Red>&lt;-</font> int
<a name="line-335"></a>    char <font color=Magenta>')'</font>
<a name="line-336"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-337"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-338"></a>    eof
<a name="line-339"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QGate <font color=Magenta>"W"</font> False <font color=Red>[</font>w1<font color=Cyan>,</font> w2<font color=Red>]</font> [] cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-340"></a><font color=Blue><i>{-
<a name="line-341"></a>ascii_render_gate (GPhase t ws c ncf) = 
<a name="line-342"></a>  "GPhase() with t=" ++ show t 
<a name="line-343"></a>  ++ ascii_render_controls wtm c 
<a name="line-344"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-345"></a>  ++ string_of_list " with anchors=[" ", " "]" "" show ws
<a name="line-346"></a>-}</i></font>
<a name="line-347"></a>    <font color=Green><u>do</u></font>
<a name="line-348"></a>    string <font color=Magenta>"GPhase() with t="</font>
<a name="line-349"></a>    t <font color=Red>&lt;-</font> double
<a name="line-350"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-351"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-352"></a>    ws <font color=Red>&lt;-</font> option [] <font color=Cyan>(</font><font color=Green><u>do</u></font>
<a name="line-353"></a>      skipSpaces
<a name="line-354"></a>      string <font color=Magenta>"with anchors=["</font>
<a name="line-355"></a>      ws <font color=Red>&lt;-</font> commalist int
<a name="line-356"></a>      char <font color=Magenta>']'</font>
<a name="line-357"></a>      return ws <font color=Cyan>)</font>
<a name="line-358"></a>    eof
<a name="line-359"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>GPhase t ws cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-360"></a><font color=Blue><i>{-
<a name="line-361"></a>ascii_render_gate (QGate name inv ws1 ws2 c ncf) = 
<a name="line-362"></a>  "QGate[" ++ show name ++ "]" 
<a name="line-363"></a>  ++ optional inv "*" 
<a name="line-364"></a>  ++ (string_of_list "(" "," ")" "()" show ws1)
<a name="line-365"></a>  ++ (string_of_list "; [" "," "]" "" show ws2)
<a name="line-366"></a>  ++ ascii_render_controls wtm c
<a name="line-367"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-368"></a>-}</i></font>
<a name="line-369"></a>    <font color=Green><u>do</u></font>
<a name="line-370"></a>    string <font color=Magenta>"QGate["</font>
<a name="line-371"></a>    name <font color=Red>&lt;-</font> string_literal
<a name="line-372"></a>    char <font color=Magenta>']'</font>
<a name="line-373"></a>    inv <font color=Red>&lt;-</font> inversechar
<a name="line-374"></a>    char <font color=Magenta>'('</font>
<a name="line-375"></a>    ws1 <font color=Red>&lt;-</font> commalist int
<a name="line-376"></a>    char <font color=Magenta>')'</font>
<a name="line-377"></a>    ws2 <font color=Red>&lt;-</font> option [] <font color=Cyan>(</font><font color=Green><u>do</u></font>
<a name="line-378"></a>      string <font color=Magenta>"; ["</font>
<a name="line-379"></a>      ws <font color=Red>&lt;-</font> commalist int
<a name="line-380"></a>      char <font color=Magenta>']'</font>
<a name="line-381"></a>      return ws <font color=Cyan>)</font>
<a name="line-382"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-383"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-384"></a>    eof
<a name="line-385"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QGate name inv ws1 ws2 cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>   
<a name="line-386"></a><font color=Blue><i>{-
<a name="line-387"></a>ascii_render_gate (QRot name inv theta ws1 ws2 c ncf) = 
<a name="line-388"></a>  "QRot[" ++ show name ++ "," ++ (show theta) ++ "]" 
<a name="line-389"></a>  ++ optional inv "*"
<a name="line-390"></a>  ++ (string_of_list "(" "," ")" "()" show ws1)
<a name="line-391"></a>  ++ (string_of_list "; [" "," "]" "" show ws2)
<a name="line-392"></a>  ++ ascii_render_controls wtm c
<a name="line-393"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-394"></a>-}</i></font>
<a name="line-395"></a>    <font color=Green><u>do</u></font>
<a name="line-396"></a>    string <font color=Magenta>"QRot["</font>
<a name="line-397"></a>    name <font color=Red>&lt;-</font> string_literal
<a name="line-398"></a>    char <font color=Magenta>','</font>
<a name="line-399"></a>    theta <font color=Red>&lt;-</font> double
<a name="line-400"></a>    char <font color=Magenta>']'</font>
<a name="line-401"></a>    inv <font color=Red>&lt;-</font> inversechar
<a name="line-402"></a>    char <font color=Magenta>'('</font>
<a name="line-403"></a>    ws1 <font color=Red>&lt;-</font> commalist int
<a name="line-404"></a>    char <font color=Magenta>')'</font>
<a name="line-405"></a>    ws2 <font color=Red>&lt;-</font> option [] <font color=Cyan>(</font> <font color=Green><u>do</u></font>
<a name="line-406"></a>      string <font color=Magenta>"; ["</font>
<a name="line-407"></a>      ws <font color=Red>&lt;-</font> commalist int
<a name="line-408"></a>      char <font color=Magenta>']'</font>
<a name="line-409"></a>      return ws <font color=Cyan>)</font>
<a name="line-410"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-411"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-412"></a>    eof
<a name="line-413"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QRot name inv theta ws1 ws2 cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-414"></a><font color=Blue><i>{-
<a name="line-415"></a>ascii_render_gate (CNot w c ncf) = 
<a name="line-416"></a>  "CNot(" ++ show w ++ ")" 
<a name="line-417"></a>  ++ ascii_render_controls wtm c
<a name="line-418"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-419"></a>-}</i></font>
<a name="line-420"></a>    <font color=Green><u>do</u></font> 
<a name="line-421"></a>    string <font color=Magenta>"CNot("</font>
<a name="line-422"></a>    w <font color=Red>&lt;-</font> int
<a name="line-423"></a>    char <font color=Magenta>')'</font>
<a name="line-424"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-425"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-426"></a>    eof
<a name="line-427"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>CNot w cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-428"></a><font color=Blue><i>{-
<a name="line-429"></a>ascii_render_gate (CGate n w c ncf) = 
<a name="line-430"></a>  "CGate[" ++ show n ++ "]" ++ (string_of_list "(" "," ")" "()" show (w:c))
<a name="line-431"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-432"></a>-}</i></font>
<a name="line-433"></a>    <font color=Green><u>do</u></font>
<a name="line-434"></a>    string <font color=Magenta>"CGate["</font>
<a name="line-435"></a>    name <font color=Red>&lt;-</font> string_literal
<a name="line-436"></a>    string <font color=Magenta>"]("</font>
<a name="line-437"></a>    ws <font color=Red>&lt;-</font> commalist int
<a name="line-438"></a>    char <font color=Magenta>')'</font>
<a name="line-439"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-440"></a>    eof
<a name="line-441"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>CGate name <font color=Cyan>(</font>head ws<font color=Cyan>)</font> <font color=Cyan>(</font>tail ws<font color=Cyan>)</font> ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-442"></a><font color=Blue><i>{-
<a name="line-443"></a>ascii_render_gate (CGateInv n w c ncf) = 
<a name="line-444"></a>  "CGate[" ++ show n ++ "]" ++ "*" ++ (string_of_list "(" "," ")" "()" show (w:c))
<a name="line-445"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-446"></a>-}</i></font>
<a name="line-447"></a>    <font color=Green><u>do</u></font>
<a name="line-448"></a>    string <font color=Magenta>"CGate["</font>
<a name="line-449"></a>    name <font color=Red>&lt;-</font> string_literal
<a name="line-450"></a>    string <font color=Magenta>"]*("</font>
<a name="line-451"></a>    ws <font color=Red>&lt;-</font> commalist int
<a name="line-452"></a>    char <font color=Magenta>')'</font>
<a name="line-453"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-454"></a>    eof
<a name="line-455"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>CGateInv name <font color=Cyan>(</font>head ws<font color=Cyan>)</font> <font color=Cyan>(</font>tail ws<font color=Cyan>)</font> ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-456"></a><font color=Blue><i>{-
<a name="line-457"></a>ascii_render_gate (CSwap w1 w2 c ncf) = 
<a name="line-458"></a>  "CSwap(" ++ show w1 ++ "," ++ show w2 ++ ")" 
<a name="line-459"></a>  ++ ascii_render_controls wtm c
<a name="line-460"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-461"></a>-}</i></font>
<a name="line-462"></a>    <font color=Green><u>do</u></font>
<a name="line-463"></a>    string <font color=Magenta>"CSwap("</font>
<a name="line-464"></a>    w1 <font color=Red>&lt;-</font> int
<a name="line-465"></a>    char <font color=Magenta>','</font>
<a name="line-466"></a>    w2 <font color=Red>&lt;-</font> int
<a name="line-467"></a>    char <font color=Magenta>')'</font>
<a name="line-468"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-469"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-470"></a>    eof
<a name="line-471"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>CSwap w1 w2 cs ncf<font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-472"></a><font color=Blue><i>{-
<a name="line-473"></a>ascii_render_gate (QPrep w ncf) = 
<a name="line-474"></a>  "QPrep(" ++ show w ++ ")"
<a name="line-475"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-476"></a>-}</i></font>
<a name="line-477"></a>    <font color=Green><u>do</u></font>
<a name="line-478"></a>    string <font color=Magenta>"QPrep("</font>
<a name="line-479"></a>    w <font color=Red>&lt;-</font> int
<a name="line-480"></a>    char <font color=Magenta>')'</font>
<a name="line-481"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-482"></a>    eof
<a name="line-483"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QPrep w ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-484"></a><font color=Blue><i>{-
<a name="line-485"></a>ascii_render_gate (QUnprep w ncf) = 
<a name="line-486"></a>  "QUnprep(" ++ show w ++ ")"
<a name="line-487"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-488"></a>-}</i></font>
<a name="line-489"></a>    <font color=Green><u>do</u></font>
<a name="line-490"></a>    string <font color=Magenta>"QUnprep("</font>
<a name="line-491"></a>    w <font color=Red>&lt;-</font> int
<a name="line-492"></a>    char <font color=Magenta>')'</font>
<a name="line-493"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-494"></a>    eof
<a name="line-495"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QUnprep w ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-496"></a><font color=Blue><i>{-
<a name="line-497"></a>ascii_render_gate (QInit b w ncf) = 
<a name="line-498"></a>  "QInit" ++ (if b then "1" else "0") ++ "(" ++ show w ++ ")"
<a name="line-499"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-500"></a>-}</i></font>
<a name="line-501"></a>    <font color=Green><u>do</u></font>
<a name="line-502"></a>    string <font color=Magenta>"QInit"</font>
<a name="line-503"></a>    val_char <font color=Red>&lt;-</font> choice <font color=Red>[</font>char <font color=Magenta>'0'</font><font color=Cyan>,</font>char <font color=Magenta>'1'</font><font color=Red>]</font>
<a name="line-504"></a>    <font color=Green><u>let</u></font> val <font color=Red>=</font> val_char <font color=Cyan>==</font> <font color=Magenta>'1'</font>
<a name="line-505"></a>    char <font color=Magenta>'('</font>
<a name="line-506"></a>    w <font color=Red>&lt;-</font> int
<a name="line-507"></a>    char <font color=Magenta>')'</font>
<a name="line-508"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-509"></a>    eof
<a name="line-510"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QInit val w ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-511"></a><font color=Blue><i>{-
<a name="line-512"></a>ascii_render_gate (CInit b w ncf) = 
<a name="line-513"></a>  "CInit" ++ (if b then "1" else "0") ++ "(" ++ show w ++ ")"
<a name="line-514"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-515"></a>-}</i></font>
<a name="line-516"></a>    <font color=Green><u>do</u></font>
<a name="line-517"></a>    string <font color=Magenta>"CInit"</font>
<a name="line-518"></a>    val_char <font color=Red>&lt;-</font> choice <font color=Red>[</font>char <font color=Magenta>'0'</font><font color=Cyan>,</font>char <font color=Magenta>'1'</font><font color=Red>]</font>
<a name="line-519"></a>    <font color=Green><u>let</u></font> val <font color=Red>=</font> val_char <font color=Cyan>==</font> <font color=Magenta>'1'</font>
<a name="line-520"></a>    char <font color=Magenta>'('</font>
<a name="line-521"></a>    w <font color=Red>&lt;-</font> int
<a name="line-522"></a>    char <font color=Magenta>')'</font>
<a name="line-523"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-524"></a>    eof
<a name="line-525"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>CInit val w ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-526"></a><font color=Blue><i>{-
<a name="line-527"></a>ascii_render_gate (QTerm b w ncf) = 
<a name="line-528"></a>  "QTerm" ++ (if b then "1" else "0") ++ "(" ++ show w ++ ")"
<a name="line-529"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-530"></a>-}</i></font>
<a name="line-531"></a>    <font color=Green><u>do</u></font>
<a name="line-532"></a>    string <font color=Magenta>"QTerm"</font>
<a name="line-533"></a>    val_char <font color=Red>&lt;-</font> choice <font color=Red>[</font>char <font color=Magenta>'0'</font><font color=Cyan>,</font>char <font color=Magenta>'1'</font><font color=Red>]</font>
<a name="line-534"></a>    <font color=Green><u>let</u></font> val <font color=Red>=</font> val_char <font color=Cyan>==</font> <font color=Magenta>'1'</font>
<a name="line-535"></a>    char <font color=Magenta>'('</font>
<a name="line-536"></a>    w <font color=Red>&lt;-</font> int
<a name="line-537"></a>    char <font color=Magenta>')'</font>
<a name="line-538"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-539"></a>    eof
<a name="line-540"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QTerm val w ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-541"></a><font color=Blue><i>{-
<a name="line-542"></a>ascii_render_gate (CTerm b w ncf) = 
<a name="line-543"></a>  "CTerm" ++ (if b then "1" else "0") ++ "(" ++ show w ++ ")"
<a name="line-544"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-545"></a>-}</i></font>
<a name="line-546"></a>    <font color=Green><u>do</u></font>
<a name="line-547"></a>    string <font color=Magenta>"CTerm"</font>
<a name="line-548"></a>    val_char <font color=Red>&lt;-</font> choice <font color=Red>[</font>char <font color=Magenta>'0'</font><font color=Cyan>,</font>char <font color=Magenta>'1'</font><font color=Red>]</font>
<a name="line-549"></a>    <font color=Green><u>let</u></font> val <font color=Red>=</font> val_char <font color=Cyan>==</font> <font color=Magenta>'1'</font>
<a name="line-550"></a>    char <font color=Magenta>'('</font>
<a name="line-551"></a>    w <font color=Red>&lt;-</font> int
<a name="line-552"></a>    char <font color=Magenta>')'</font>
<a name="line-553"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-554"></a>    eof
<a name="line-555"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>CTerm val w ncf<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-556"></a><font color=Blue><i>{-
<a name="line-557"></a>ascii_render_gate (QMeas w) = 
<a name="line-558"></a>  "QMeas(" ++ show w ++ ")"
<a name="line-559"></a>-}</i></font>
<a name="line-560"></a>    <font color=Green><u>do</u></font>
<a name="line-561"></a>    string <font color=Magenta>"QMeas("</font>
<a name="line-562"></a>    w <font color=Red>&lt;-</font> int
<a name="line-563"></a>    char <font color=Magenta>')'</font>
<a name="line-564"></a>    eof
<a name="line-565"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QMeas w<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-566"></a><font color=Blue><i>{-
<a name="line-567"></a>ascii_render_gate (QDiscard w) = 
<a name="line-568"></a>  "QDiscard(" ++ show w ++ ")"
<a name="line-569"></a>-}</i></font>
<a name="line-570"></a>    <font color=Green><u>do</u></font>
<a name="line-571"></a>    string <font color=Magenta>"QDiscard("</font>
<a name="line-572"></a>    w <font color=Red>&lt;-</font> int
<a name="line-573"></a>    char <font color=Magenta>')'</font>
<a name="line-574"></a>    eof
<a name="line-575"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>QDiscard w<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-576"></a><font color=Blue><i>{-
<a name="line-577"></a>ascii_render_gate (CDiscard w) = 
<a name="line-578"></a>  "CDiscard(" ++ show w ++ ")"
<a name="line-579"></a>-}</i></font>
<a name="line-580"></a>    <font color=Green><u>do</u></font>
<a name="line-581"></a>    string <font color=Magenta>"CDiscard("</font>
<a name="line-582"></a>    w <font color=Red>&lt;-</font> int
<a name="line-583"></a>    char <font color=Magenta>')'</font>
<a name="line-584"></a>    eof
<a name="line-585"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>CDiscard w<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-586"></a><font color=Blue><i>{-
<a name="line-587"></a>ascii_render_gate (DTerm b w) = 
<a name="line-588"></a>  "DTerm" ++ (if b then "1" else "0") ++ "(" ++ show w ++ ")"
<a name="line-589"></a>-}</i></font>
<a name="line-590"></a>    <font color=Green><u>do</u></font>
<a name="line-591"></a>    string <font color=Magenta>"DTerm"</font>
<a name="line-592"></a>    vc <font color=Red>&lt;-</font> char <font color=Magenta>'0'</font> <font color=Cyan>+++</font> char <font color=Magenta>'1'</font>
<a name="line-593"></a>    <font color=Green><u>let</u></font> b <font color=Red>=</font> <font color=Green><u>case</u></font> vc <font color=Green><u>of</u></font>
<a name="line-594"></a>             <font color=Magenta>'0'</font> <font color=Red>-&gt;</font> False
<a name="line-595"></a>             <font color=Magenta>'1'</font> <font color=Red>-&gt;</font> True
<a name="line-596"></a>             <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> error <font color=Magenta>"The impossible has happend"</font> 
<a name="line-597"></a>    char <font color=Magenta>'('</font>
<a name="line-598"></a>    w <font color=Red>&lt;-</font> int
<a name="line-599"></a>    char <font color=Magenta>')'</font>
<a name="line-600"></a>    eof
<a name="line-601"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>DTerm b w<font color=Cyan>)</font> []<font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-602"></a><font color=Blue><i>{-
<a name="line-603"></a>ascii_render_gate (Subroutine boxid inv ws1 a1 ws2 a2 c ncf scf) = 
<a name="line-604"></a>  "Subroutine" ++ show_rep ++ "[" ++ show (string_of_boxid boxid) ++ "]"
<a name="line-605"></a>  ++ optional inv "*"
<a name="line-606"></a>  ++ " "
<a name="line-607"></a>  ++ (string_of_list "(" "," ")" "()" show ws1)
<a name="line-608"></a>  ++ (string_of_list " -&gt; (" "," ")" "()" show ws2)
<a name="line-609"></a>  ++ ascii_render_controls wtm c
<a name="line-610"></a>  ++ ascii_render_nocontrolflag ncf
<a name="line-611"></a>  where
<a name="line-612"></a>    show_rep = if rep == RepeatFlag 1 then "" else "(x" ++ show rep ++ ")"
<a name="line-613"></a>-}</i></font>
<a name="line-614"></a><font color=Blue><i>-- The parser returns a subroutine with dummy arities, and controllable flag,</i></font>
<a name="line-615"></a><font color=Blue><i>-- and repeat flag, as</i></font>
<a name="line-616"></a><font color=Blue><i>-- this information is not in a subroutine line in the ASCII output. </i></font>
<a name="line-617"></a><font color=Blue><i>-- The information is added when the GatePlus is evaluated, as the first phase of</i></font>
<a name="line-618"></a><font color=Blue><i>-- parsing will have collected the information. </i></font>
<a name="line-619"></a>    <font color=Green><u>do</u></font>
<a name="line-620"></a>    string <font color=Magenta>"Subroutine"</font>
<a name="line-621"></a>    reps <font color=Red>&lt;-</font> option <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-622"></a>     string <font color=Magenta>"(x"</font>
<a name="line-623"></a>     r <font color=Red>&lt;-</font> int
<a name="line-624"></a>     char <font color=Magenta>')'</font>
<a name="line-625"></a>     return <font color=Cyan>(</font>toInteger r<font color=Cyan>)</font>
<a name="line-626"></a>    char <font color=Magenta>'['</font>
<a name="line-627"></a>    boxid <font color=Red>&lt;-</font> box_id
<a name="line-628"></a>    char <font color=Magenta>']'</font>
<a name="line-629"></a>    inv <font color=Red>&lt;-</font> inversechar
<a name="line-630"></a>    string <font color=Magenta>" ("</font>
<a name="line-631"></a>    ws1 <font color=Red>&lt;-</font> commalist int
<a name="line-632"></a>    string <font color=Magenta>") -&gt; ("</font>
<a name="line-633"></a>    ws2 <font color=Red>&lt;-</font> commalist int
<a name="line-634"></a>    char <font color=Magenta>')'</font>
<a name="line-635"></a>    <font color=Cyan>(</font>cs<font color=Cyan>,</font>wts<font color=Cyan>)</font> <font color=Red>&lt;-</font> option <font color=Cyan>(</font>[]<font color=Cyan>,</font>[]<font color=Cyan>)</font> controls
<a name="line-636"></a>    ncf <font color=Red>&lt;-</font> nocontrolflag
<a name="line-637"></a>    eof
<a name="line-638"></a>    <font color=Green><u>let</u></font> dummy <font color=Red>=</font> error <font color=Magenta>"attempted evaluation of a dummy value"</font>
<a name="line-639"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>Subroutine boxid inv ws1 dummy ws2 dummy cs ncf dummy <font color=Cyan>(</font>RepeatFlag reps<font color=Cyan>)</font><font color=Cyan>)</font> wts<font color=Cyan>)</font><font color=Cyan>,</font>   
<a name="line-640"></a><font color=Blue><i>{-
<a name="line-641"></a>ascii_render_gate (Comment s inv ws) = 
<a name="line-642"></a>  "Comment[" ++ show s ++ "]" 
<a name="line-643"></a>  ++ optional inv "*"
<a name="line-644"></a>  ++ (string_of_list "(" ", " ")" "()" (\(w,s) -&gt; show w ++ ":" ++ show s) ws)
<a name="line-645"></a>-}</i></font>
<a name="line-646"></a>    <font color=Green><u>do</u></font>
<a name="line-647"></a>    string <font color=Magenta>"Comment"</font>
<a name="line-648"></a>    skipSpaces
<a name="line-649"></a>    char <font color=Magenta>'['</font>
<a name="line-650"></a>    comment <font color=Red>&lt;-</font> string_literal
<a name="line-651"></a>    char <font color=Magenta>']'</font>
<a name="line-652"></a>    inv <font color=Red>&lt;-</font> inversechar
<a name="line-653"></a>    ls <font color=Red>&lt;-</font> labels
<a name="line-654"></a>    eof
<a name="line-655"></a>    return <font color=Cyan>(</font>G <font color=Cyan>(</font>Comment comment inv ls<font color=Cyan>)</font> []<font color=Cyan>)</font>
<a name="line-656"></a>  <font color=Red>]</font>
<a name="line-657"></a>
<a name="line-658"></a><a name="parse_ascii_line"></a><font color=Blue><i>-- | The overall parsing function, reading a line of ASCII output, and</i></font>
<a name="line-659"></a><font color=Blue><i>-- producing a 'GatePlus'.</i></font>
<a name="line-660"></a><font color=Blue>parse_ascii_line</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> Maybe GatePlus
<a name="line-661"></a><font color=Blue>parse_ascii_line</font> s <font color=Red>=</font>
<a name="line-662"></a>  <font color=Green><u>case</u></font> readP_to_S ascii_line s <font color=Green><u>of</u></font>
<a name="line-663"></a>    <font color=Cyan>(</font>h<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Red><b>:</b></font><font color=Green><u>_</u></font> <font color=Red>-&gt;</font> Just h
<a name="line-664"></a>    <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> Nothing
<a name="line-665"></a>  <font color=Green><u>where</u></font>
<a name="line-666"></a>    readline <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-667"></a>      skipSpaces
<a name="line-668"></a>      l <font color=Red>&lt;-</font> ascii_line
<a name="line-669"></a>      skipSpaces
<a name="line-670"></a>      eof
<a name="line-671"></a>      return l      
<a name="line-672"></a>      
<a name="line-673"></a>
</pre>
</body>
</html>