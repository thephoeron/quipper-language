<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE BangPatterns #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE ExistentialQuantification #-}</i></font>
<a name="line-3"></a><font color=Blue><i>{-# LANGUAGE DeriveDataTypeable #-}</i></font>
<a name="line-4"></a>
<a name="line-5"></a><font color=Blue><i>-- | Low-level quantum circuit implementation. This is our backend</i></font>
<a name="line-6"></a><font color=Blue><i>-- implementation of quantum circuits. Note: there is no run-time</i></font>
<a name="line-7"></a><font color=Blue><i>-- error checking at the moment. </i></font>
<a name="line-8"></a><font color=Blue><i>-- </i></font>
<a name="line-9"></a><font color=Blue><i>-- At its heart, a circuit is a list of gates. All well-definedness</i></font>
<a name="line-10"></a><font color=Blue><i>-- checking (e.g. input arity, output arity, and checking that the</i></font>
<a name="line-11"></a><font color=Blue><i>-- intermediate gates are connected to legitimate wires) is done</i></font>
<a name="line-12"></a><font color=Blue><i>-- dynamically, at circuit generation time, and is not stored within</i></font>
<a name="line-13"></a><font color=Blue><i>-- the circuit itself. This allows circuits to be produced and</i></font>
<a name="line-14"></a><font color=Blue><i>-- consumed lazily.</i></font>
<a name="line-15"></a><font color=Blue><i>-- </i></font>
<a name="line-16"></a><font color=Blue><i>-- Implementation note: this file is in the intermediate stage of a</i></font>
<a name="line-17"></a><font color=Blue><i>-- code refactoring, and should be considered \"under renovation\".</i></font>
<a name="line-18"></a>
<a name="line-19"></a><font color=Green><u>module</u></font> Quipper<font color=Cyan>.</font>Circuit <font color=Green><u>where</u></font>
<a name="line-20"></a>
<a name="line-21"></a><font color=Blue><i>-- import other Quipper stuff</i></font>
<a name="line-22"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary
<a name="line-23"></a>
<a name="line-24"></a><font color=Blue><i>-- import other stuff</i></font>
<a name="line-25"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>List
<a name="line-26"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Maybe
<a name="line-27"></a>
<a name="line-28"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Set <font color=Cyan>(</font>Set<font color=Cyan>)</font>
<a name="line-29"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Set <font color=Green><u>as</u></font> Set
<a name="line-30"></a>
<a name="line-31"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Map <font color=Cyan>(</font>Map<font color=Cyan>)</font>
<a name="line-32"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Map <font color=Green><u>as</u></font> Map
<a name="line-33"></a>
<a name="line-34"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>IntSet <font color=Cyan>(</font>IntSet<font color=Cyan>)</font>
<a name="line-35"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>IntSet <font color=Green><u>as</u></font> IntSet
<a name="line-36"></a>
<a name="line-37"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>IntMap <font color=Cyan>(</font>IntMap<font color=Cyan>)</font>
<a name="line-38"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>IntMap <font color=Green><u>as</u></font> IntMap
<a name="line-39"></a>
<a name="line-40"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Typeable
<a name="line-41"></a>
<a name="line-42"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-43"></a><font color=Blue><i>-- * Quantum circuit data type</i></font>
<a name="line-44"></a>
<a name="line-45"></a><a name="Wire"></a><font color=Blue><i>-- | Wire identifier. Wires are currently identified by an integer,</i></font>
<a name="line-46"></a><a name="Wire"></a><font color=Blue><i>-- but the users of this interface should be oblivious to this.</i></font>
<a name="line-47"></a><a name="Wire"></a><font color=Green><u>type</u></font> Wire <font color=Red>=</font> Int
<a name="line-48"></a>
<a name="line-49"></a><a name="Wiretype"></a><font color=Blue><i>-- | Wire type. A wire is either quantum or classical.</i></font>
<a name="line-50"></a><a name="Wiretype"></a><font color=Green><u>data</u></font> Wiretype <font color=Red>=</font> Qbit <font color=Blue><i>-- ^ Quantum wire. </i></font>
<a name="line-51"></a>              <font color=Red>|</font> Cbit <font color=Blue><i>-- ^ Classical wire.</i></font>
<a name="line-52"></a>              <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>,</font> Eq<font color=Cyan>,</font> Typeable<font color=Cyan>)</font>
<a name="line-53"></a>
<a name="line-54"></a><a name="Arity"></a><font color=Blue><i>-- | An arity, also known as a typing context, is a map from a finite</i></font>
<a name="line-55"></a><a name="Arity"></a><font color=Blue><i>-- set of wires to wire types.</i></font>
<a name="line-56"></a><a name="Arity"></a><font color=Green><u>type</u></font> Arity <font color=Red>=</font> IntMap Wiretype
<a name="line-57"></a>
<a name="line-58"></a><a name="Signed"></a><font color=Blue><i>-- | A signed item of type /a/. 'Signed' /x/ 'True' represents a</i></font>
<a name="line-59"></a><a name="Signed"></a><font color=Blue><i>-- positive item, and 'Signed' /x/ 'False' represents a negative item.</i></font>
<a name="line-60"></a><a name="Signed"></a><font color=Blue><i>-- </i></font>
<a name="line-61"></a><a name="Signed"></a><font color=Blue><i>-- When used with wires in a circuit, a positive sign is used to</i></font>
<a name="line-62"></a><a name="Signed"></a><font color=Blue><i>-- represent a positive control, i.e., a filled dot, and a negative</i></font>
<a name="line-63"></a><a name="Signed"></a><font color=Blue><i>-- sign is used to represent a negative control, i.e., an empty dot.</i></font>
<a name="line-64"></a><a name="Signed"></a><font color=Green><u>data</u></font> Signed a <font color=Red>=</font> Signed a Bool
<a name="line-65"></a>                   <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>,</font> Typeable<font color=Cyan>)</font> 
<a name="line-66"></a>                     
<a name="line-67"></a><a name="from_signed"></a><font color=Blue><i>-- | Extract the underlying item of a signed item.</i></font>
<a name="line-68"></a><font color=Blue>from_signed</font> <font color=Red>::</font> Signed a <font color=Red>-&gt;</font> a
<a name="line-69"></a><font color=Blue>from_signed</font> <font color=Cyan>(</font>Signed a b<font color=Cyan>)</font> <font color=Red>=</font> a
<a name="line-70"></a>
<a name="line-71"></a><a name="get_sign"></a><font color=Blue><i>-- | Extract the sign of a signed item: 'True' is positive, and</i></font>
<a name="line-72"></a><font color=Blue><i>-- 'False' is negative.</i></font>
<a name="line-73"></a><font color=Blue>get_sign</font> <font color=Red>::</font> Signed a <font color=Red>-&gt;</font> Bool
<a name="line-74"></a><font color=Blue>get_sign</font> <font color=Cyan>(</font>Signed a b<font color=Cyan>)</font> <font color=Red>=</font> b
<a name="line-75"></a>
<a name="line-76"></a><a name="Controls"></a><font color=Blue><i>-- | A list of controlled wires, possibly empty.</i></font>
<a name="line-77"></a><a name="Controls"></a><font color=Green><u>type</u></font> Controls <font color=Red>=</font> <font color=Red>[</font>Signed Wire<font color=Red>]</font>
<a name="line-78"></a>
<a name="line-79"></a><a name="Timestep"></a><font color=Blue><i>-- | A time step is a small floating point number used as a</i></font>
<a name="line-80"></a><a name="Timestep"></a><font color=Blue><i>-- parameter to certain gates, such as rotation gates or the</i></font>
<a name="line-81"></a><a name="Timestep"></a><font color=Blue><i>-- [exp &#8722;/iZt/] gate.</i></font>
<a name="line-82"></a><a name="Timestep"></a><font color=Green><u>type</u></font> Timestep <font color=Red>=</font> Double
<a name="line-83"></a>
<a name="line-84"></a><a name="InverseFlag"></a><font color=Blue><i>-- | A flag that, if 'True', indicates that the gate is inverted.</i></font>
<a name="line-85"></a><a name="InverseFlag"></a><font color=Green><u>type</u></font> InverseFlag <font color=Red>=</font> Bool
<a name="line-86"></a>
<a name="line-87"></a><a name="NoControlFlag"></a><font color=Blue><i>-- | A flag that, if 'True', indicates that the gate is controllable,</i></font>
<a name="line-88"></a><a name="NoControlFlag"></a><font color=Blue><i>-- but any further controls on the gate should be ignored. This is</i></font>
<a name="line-89"></a><a name="NoControlFlag"></a><font color=Blue><i>-- used, e.g., for circuits consisting of a basis change, some</i></font>
<a name="line-90"></a><a name="NoControlFlag"></a><font color=Blue><i>-- operation, and the inverse basis change. When controlling such a</i></font>
<a name="line-91"></a><a name="NoControlFlag"></a><font color=Blue><i>-- circuit, it is sufficient to control the middle operation, so the</i></font>
<a name="line-92"></a><a name="NoControlFlag"></a><font color=Blue><i>-- gates belonging to the basis change and its inverse will have the</i></font>
<a name="line-93"></a><a name="NoControlFlag"></a><font color=Blue><i>-- NoControlFlag set.</i></font>
<a name="line-94"></a><a name="NoControlFlag"></a><font color=Green><u>type</u></font> NoControlFlag <font color=Red>=</font> Bool
<a name="line-95"></a>
<a name="line-96"></a><a name="ControllableFlag"></a><font color=Blue><i>-- | A flag, to specify if the corresponding subroutine can be controlled.</i></font>
<a name="line-97"></a><a name="ControllableFlag"></a><font color=Blue><i>-- Either no control allowed, or all controls, or only classical.</i></font>
<a name="line-98"></a><a name="ControllableFlag"></a><font color=Green><u>data</u></font> ControllableFlag <font color=Red>=</font> NoCtl <font color=Red>|</font> AllCtl <font color=Red>|</font> OnlyClassicalCtl
<a name="line-99"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Eq<font color=Cyan>,</font> Ord<font color=Cyan>,</font> Show<font color=Cyan>)</font>
<a name="line-100"></a>
<a name="line-101"></a><a name="BoxId"></a><font color=Blue><i>-- | An identifier for a subroutine. A boxed subroutine is currently</i></font>
<a name="line-102"></a><a name="BoxId"></a><font color=Blue><i>-- identified by a pair of: the user-defined name of the subroutine;</i></font>
<a name="line-103"></a><a name="BoxId"></a><font color=Blue><i>-- and a value uniquely identifying the type and shape of the argument.</i></font>
<a name="line-104"></a><a name="BoxId"></a><font color=Blue><i>-- </i></font>
<a name="line-105"></a><a name="BoxId"></a><font color=Blue><i>-- For now, we represent the shape as a string, because this gives an</i></font>
<a name="line-106"></a><a name="BoxId"></a><font color=Blue><i>-- easy total 'Ord' instance, needed for "Data.Map". However, in</i></font>
<a name="line-107"></a><a name="BoxId"></a><font color=Blue><i>-- principle, one could also use a pair of a type representation and a</i></font>
<a name="line-108"></a><a name="BoxId"></a><font color=Blue><i>-- shape term. The implementation of this may change later.</i></font>
<a name="line-109"></a><a name="BoxId"></a><font color=Green><u>data</u></font> BoxId <font color=Red>=</font> BoxId String String
<a name="line-110"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Eq<font color=Cyan>,</font> Ord<font color=Cyan>,</font> Show<font color=Cyan>)</font>
<a name="line-111"></a>
<a name="line-112"></a><a name="RepeatFlag"></a><font color=Blue><i>-- | A flag that indicates how many times a particular subroutine</i></font>
<a name="line-113"></a><a name="RepeatFlag"></a><font color=Blue><i>-- should be repeated. If non-zero, it implies some constraints on</i></font>
<a name="line-114"></a><a name="RepeatFlag"></a><font color=Blue><i>-- the type of the subroutine.</i></font>
<a name="line-115"></a><a name="RepeatFlag"></a><font color=Green><u>data</u></font> RepeatFlag <font color=Red>=</font> RepeatFlag Integer
<a name="line-116"></a>                  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Eq<font color=Cyan>,</font>Ord<font color=Cyan>)</font>
<a name="line-117"></a>
<a name="line-118"></a><font color=Green><u>instance</u></font> Show RepeatFlag <font color=Green><u>where</u></font>
<a name="line-119"></a>  show <font color=Cyan>(</font>RepeatFlag n<font color=Cyan>)</font> <font color=Red>=</font> show n
<a name="line-120"></a>
<a name="line-121"></a><font color=Blue><i>-- When changing the 'Gate' datatype, also remember to update</i></font>
<a name="line-122"></a><font color=Blue><i>-- 'gate_arity', 'gate_controls', and 'gate_reverse' below.</i></font>
<a name="line-123"></a>
<a name="line-124"></a><a name="Gate"></a><font color=Blue><i>-- | The low-level representation of gates.</i></font>
<a name="line-125"></a><a name="Gate"></a><font color=Green><u>data</u></font> Gate <font color=Red>=</font>
<a name="line-126"></a>  <font color=Blue><i>-- Named reversible quantum gates.</i></font>
<a name="line-127"></a>  QGate String InverseFlag <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>[</font>Wire<font color=Red>]</font> Controls NoControlFlag
<a name="line-128"></a>    <font color=Blue><i>-- ^ A named reversible quantum gate: @'Qbit'^(m+n) -&gt;</i></font>
<a name="line-129"></a>    <font color=Blue><i>-- 'Qbit'^(m+n)@.  The second @['Wire']@ argument should be</i></font>
<a name="line-130"></a>    <font color=Blue><i>-- \"generalized controls\", i.e. wires not modified by the</i></font>
<a name="line-131"></a>    <font color=Blue><i>-- gate. The gate type is uniquely determined by: the name, the</i></font>
<a name="line-132"></a>    <font color=Blue><i>-- number of inputs, and the number of generalized controls. Gates</i></font>
<a name="line-133"></a>    <font color=Blue><i>-- that differ in one of these respects should be regarded as</i></font>
<a name="line-134"></a>    <font color=Blue><i>-- different gates.</i></font>
<a name="line-135"></a>    
<a name="line-136"></a>  <font color=Red>|</font> QRot String InverseFlag Timestep <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>[</font>Wire<font color=Red>]</font> Controls NoControlFlag
<a name="line-137"></a>    <font color=Blue><i>-- ^ A named reversible quantum gate that also depends on a real</i></font>
<a name="line-138"></a>    <font color=Blue><i>-- parameter. This is typically used for phase and rotation</i></font>
<a name="line-139"></a>    <font color=Blue><i>-- gates. The gate name can contain \'%\' as a place holder for</i></font>
<a name="line-140"></a>    <font color=Blue><i>-- the parameter, e.g., @\"exp(-i%Z)\"@. The remaining arguments</i></font>
<a name="line-141"></a>    <font color=Blue><i>-- are as for 'QGate'.</i></font>
<a name="line-142"></a>
<a name="line-143"></a>  <font color=Blue><i>-- A nullary quantum gate.</i></font>
<a name="line-144"></a>  <font color=Red>|</font> GPhase Timestep <font color=Red>[</font>Wire<font color=Red>]</font> Controls NoControlFlag
<a name="line-145"></a>    <font color=Blue><i>-- ^ Global phase gate: @'1' -&gt; '1'@. The list of wires is just a hint for graphical rendering.</i></font>
<a name="line-146"></a>  
<a name="line-147"></a>  <font color=Blue><i>-- Some classical gates.</i></font>
<a name="line-148"></a>  <font color=Red>|</font> CNot Wire Controls NoControlFlag
<a name="line-149"></a>    <font color=Blue><i>-- ^ Classical not: @'Cbit' -&gt; 'Cbit'@.</i></font>
<a name="line-150"></a>  <font color=Red>|</font> CGate String Wire <font color=Red>[</font>Wire<font color=Red>]</font> NoControlFlag  
<a name="line-151"></a>    <font color=Blue><i>-- ^ Generic classical gate @1 -&gt; 'Cbit'@.</i></font>
<a name="line-152"></a>  <font color=Red>|</font> CGateInv String Wire <font color=Red>[</font>Wire<font color=Red>]</font> NoControlFlag  
<a name="line-153"></a>    <font color=Blue><i>-- ^ Uncompute classical gate @'Cbit' -&gt; 1@, asserting that the</i></font>
<a name="line-154"></a>    <font color=Blue><i>-- classical bit is in the state specified by the corresponding</i></font>
<a name="line-155"></a>    <font color=Blue><i>-- 'CGate'.</i></font>
<a name="line-156"></a>  <font color=Red>|</font> CSwap Wire Wire Controls NoControlFlag
<a name="line-157"></a>    <font color=Blue><i>-- ^ Classical swap gate: @'Cbit' * 'Cbit' -&gt; 'Cbit' * 'Cbit'@.</i></font>
<a name="line-158"></a>
<a name="line-159"></a>  <font color=Blue><i>-- Initialization and assertive termination.</i></font>
<a name="line-160"></a>  <font color=Red>|</font> QPrep Wire NoControlFlag
<a name="line-161"></a>    <font color=Blue><i>-- ^ Initialization: @'Cbit' -&gt; 'Qbit'@.</i></font>
<a name="line-162"></a>  <font color=Red>|</font> QUnprep Wire NoControlFlag
<a name="line-163"></a>    <font color=Blue><i>-- ^ Measurement @'Qbit' -&gt; 'Cbit'@ with an assertion that the</i></font>
<a name="line-164"></a>    <font color=Blue><i>-- qubit is already in a computational basis state. This kind of</i></font>
<a name="line-165"></a>    <font color=Blue><i>-- measurement loses no information, and is formally the inverse</i></font>
<a name="line-166"></a>    <font color=Blue><i>-- of 'QPrep'.</i></font>
<a name="line-167"></a>  <font color=Red>|</font> QInit Bool Wire NoControlFlag  
<a name="line-168"></a>    <font color=Blue><i>-- ^ Initialization: @'Bool' -&gt; 'Qbit'@. </i></font>
<a name="line-169"></a>  <font color=Red>|</font> CInit Bool Wire NoControlFlag  
<a name="line-170"></a>    <font color=Blue><i>-- ^ Initialization: @'Bool' -&gt; 'Cbit'@. </i></font>
<a name="line-171"></a>  <font color=Red>|</font> QTerm Bool Wire NoControlFlag  
<a name="line-172"></a>    <font color=Blue><i>-- ^ Termination of a 'Qbit' wire with assertion</i></font>
<a name="line-173"></a>    <font color=Blue><i>-- that the qubit is in the specified state:</i></font>
<a name="line-174"></a>    <font color=Blue><i>-- @'Qbit' * 'Bool' -&gt; 1@.</i></font>
<a name="line-175"></a>  <font color=Red>|</font> CTerm Bool Wire NoControlFlag  
<a name="line-176"></a>    <font color=Blue><i>-- ^ Termination of a 'Cbit' wire with assertion</i></font>
<a name="line-177"></a>    <font color=Blue><i>-- that the bit is in the specified state:</i></font>
<a name="line-178"></a>    <font color=Blue><i>-- @'Cbit' * 'Bool' -&gt; 1@.</i></font>
<a name="line-179"></a>  
<a name="line-180"></a>  <font color=Blue><i>-- Measurement.</i></font>
<a name="line-181"></a>  <font color=Red>|</font> QMeas Wire
<a name="line-182"></a>    <font color=Blue><i>-- ^ Measurement: @'Qbit' -&gt; 'Cbit'@.</i></font>
<a name="line-183"></a>  <font color=Red>|</font> QDiscard Wire    
<a name="line-184"></a>    <font color=Blue><i>-- ^ Termination of a 'Qbit' wire without</i></font>
<a name="line-185"></a>    <font color=Blue><i>-- assertion: @'Qbit' -&gt; 1@</i></font>
<a name="line-186"></a>  <font color=Red>|</font> CDiscard Wire    
<a name="line-187"></a>    <font color=Blue><i>-- ^ Termination of a 'Cbit' wire without</i></font>
<a name="line-188"></a>    <font color=Blue><i>-- assertion: @'Cbit' -&gt; 1@</i></font>
<a name="line-189"></a>
<a name="line-190"></a>  <font color=Blue><i>-- Dynamic termination.</i></font>
<a name="line-191"></a>  <font color=Red>|</font> DTerm Bool Wire 
<a name="line-192"></a>    <font color=Blue><i>-- ^ Termination of a 'Cbit' wire, with a comment indicating what</i></font>
<a name="line-193"></a>    <font color=Blue><i>-- the observed state of that wire was. This is typically inserted</i></font>
<a name="line-194"></a>    <font color=Blue><i>-- in a circuit after a dynamic lifting is performed. Unlike</i></font>
<a name="line-195"></a>    <font color=Blue><i>-- 'CTerm', this is in no way an assertion, but simply a record of</i></font>
<a name="line-196"></a>    <font color=Blue><i>-- observed behavior during a particular run of the algorithm.</i></font>
<a name="line-197"></a>
<a name="line-198"></a>  <font color=Blue><i>-- Subroutines.</i></font>
<a name="line-199"></a>  <font color=Red>|</font> Subroutine BoxId InverseFlag <font color=Red>[</font>Wire<font color=Red>]</font> Arity <font color=Red>[</font>Wire<font color=Red>]</font> Arity Controls NoControlFlag ControllableFlag RepeatFlag
<a name="line-200"></a>    <font color=Blue><i>-- ^ Reference to a subroutine, assumed to be bound to another</i></font>
<a name="line-201"></a>    <font color=Blue><i>-- circuit. Arbitrary input and output arities. The domain of /a1/</i></font>
<a name="line-202"></a>    <font color=Blue><i>-- must include the range of /ws1/, and similarly for /a2/ and /ws2/.</i></font>
<a name="line-203"></a>
<a name="line-204"></a>  <font color=Blue><i>-- Comments.</i></font>
<a name="line-205"></a>  <font color=Red>|</font> Comment String InverseFlag <font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font>String<font color=Cyan>)</font><font color=Red>]</font>
<a name="line-206"></a>    <font color=Blue><i>-- ^ A comment. Does nothing, but can be useful for marking a</i></font>
<a name="line-207"></a>    <font color=Blue><i>-- location or some wires in a circuit.</i></font>
<a name="line-208"></a>
<a name="line-209"></a>    <font color=Green><u>deriving</u></font> Show
<a name="line-210"></a>
<a name="line-211"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-212"></a><font color=Blue><i>-- * Basic information about gates</i></font>
<a name="line-213"></a>
<a name="line-214"></a><font color=Blue><i>-- The following functions must be updated each time the 'Gate' data</i></font>
<a name="line-215"></a><font color=Blue><i>-- type is changed.</i></font>
<a name="line-216"></a>
<a name="line-217"></a><a name="gate_arity"></a><font color=Blue><i>-- | Compute the incoming and outgoing wires of a given gate</i></font>
<a name="line-218"></a><font color=Blue><i>-- (excluding controls, comments, and anchors). This essentially</i></font>
<a name="line-219"></a><font color=Blue><i>-- encodes the type information of the basic gates. If a wire is used</i></font>
<a name="line-220"></a><font color=Blue><i>-- multiple times as an input or output, then 'gate_arity' also</i></font>
<a name="line-221"></a><font color=Blue><i>-- returns it multiple times; this enables run-time type checking.</i></font>
<a name="line-222"></a><font color=Blue><i>-- </i></font>
<a name="line-223"></a><font color=Blue><i>-- Note that 'gate_arity' returns the /logical/ wires, and therefore</i></font>
<a name="line-224"></a><font color=Blue><i>-- excludes things like labels, comments, and graphical anchors. This</i></font>
<a name="line-225"></a><font color=Blue><i>-- is in contrast to 'wires_of_gate', which returns the /syntactic/</i></font>
<a name="line-226"></a><font color=Blue><i>-- set of wires used by the gate.</i></font>
<a name="line-227"></a><font color=Blue>gate_arity</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font> Wiretype<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font> Wiretype<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-228"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QGate n inv ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Cyan>(</font>w<font color=Cyan>,</font>Qbit<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>ws1 <font color=Cyan>++</font> ws2<font color=Cyan>)</font> <font color=Cyan>,</font>map <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Cyan>(</font>w<font color=Cyan>,</font>Qbit<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>ws1 <font color=Cyan>++</font> ws2<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-229"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QRot n inv t ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Cyan>(</font>w<font color=Cyan>,</font>Qbit<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>ws1 <font color=Cyan>++</font> ws2<font color=Cyan>)</font> <font color=Cyan>,</font>map <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Cyan>(</font>w<font color=Cyan>,</font>Qbit<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font>ws1 <font color=Cyan>++</font> ws2<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-230"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>GPhase t w c ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-231"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>CNot w c ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-232"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>CGate n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>cs<font color=Cyan>,</font> <font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font> <font color=Red><b>:</b></font> cs<font color=Cyan>)</font>
<a name="line-233"></a>  <font color=Green><u>where</u></font> cs <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Cyan>(</font>x<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Cyan>)</font> ws
<a name="line-234"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>CGateInv n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font> <font color=Red><b>:</b></font> cs<font color=Cyan>,</font> cs<font color=Cyan>)</font>
<a name="line-235"></a>  <font color=Green><u>where</u></font> cs <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font>x <font color=Red>-&gt;</font> <font color=Cyan>(</font>x<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Cyan>)</font> ws
<a name="line-236"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>CSwap w1 w2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w1<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>w2<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>w1<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>w2<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-237"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QPrep w ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Qbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-238"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QUnprep w ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Qbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-239"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Qbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-240"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>CInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-241"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Qbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-242"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>CTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-243"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QMeas w<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Qbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>)</font>
<a name="line-244"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>QDiscard w<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Qbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-245"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>CDiscard w<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-246"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>DTerm b w<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>w<font color=Cyan>,</font> Cbit<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-247"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>Subroutine n inv ws1 a1 ws2 a2 c ncf ctrble <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>getTypes ws1 a1<font color=Cyan>,</font> getTypes ws2 a2<font color=Cyan>)</font>
<a name="line-248"></a>  <font color=Green><u>where</u></font> getTypes ws a <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font>n <font color=Red>-&gt;</font> <font color=Cyan>(</font>n<font color=Cyan>,</font> fromJust <font color=Cyan>(</font>IntMap<font color=Cyan>.</font>lookup n a<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>)</font> ws
<a name="line-249"></a><font color=Blue>gate_arity</font> <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> []<font color=Cyan>)</font>
<a name="line-250"></a>
<a name="line-251"></a><a name="gate_controls"></a><font color=Blue><i>-- | Return the controls of a gate (or an empty list if the gate has</i></font>
<a name="line-252"></a><font color=Blue><i>-- no controls).</i></font>
<a name="line-253"></a><font color=Blue>gate_controls</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> Controls
<a name="line-254"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QGate n inv ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> c
<a name="line-255"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QRot n inv t ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> c
<a name="line-256"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>GPhase t w c ncf<font color=Cyan>)</font> <font color=Red>=</font> c
<a name="line-257"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>CNot w c ncf<font color=Cyan>)</font> <font color=Red>=</font> c
<a name="line-258"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>CGate n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-259"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>CGateInv n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-260"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>CSwap w1 w2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> c
<a name="line-261"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QPrep w ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-262"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QUnprep w ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-263"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-264"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>CInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-265"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-266"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>CTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-267"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QMeas w<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-268"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>QDiscard w<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-269"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>CDiscard w<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-270"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>DTerm b w<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-271"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>Subroutine n inv ws1 a1 ws2 a2 c ncf ctrble <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> c
<a name="line-272"></a><font color=Blue>gate_controls</font> <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font> <font color=Red>=</font> []
<a name="line-273"></a>
<a name="line-274"></a><a name="gate_ncflag"></a><font color=Blue><i>-- | Return the 'NoControlFlag' of a gate, or 'False' if it doesn't have one.</i></font>
<a name="line-275"></a><font color=Blue>gate_ncflag</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> NoControlFlag
<a name="line-276"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QGate n inv ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-277"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QRot n inv t ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-278"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>GPhase t w c ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-279"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>CNot w c ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-280"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>CGate n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-281"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>CGateInv n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-282"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>CSwap w1 w2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-283"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QPrep w ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-284"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QUnprep w ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-285"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-286"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>CInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-287"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-288"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>CTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-289"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>Subroutine n inv ws1 a1 ws2 a2 c ncf ctrble <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> ncf
<a name="line-290"></a><font color=Blue><i>-- The remaining gates don't have a 'NoControlFlag'. We list them</i></font>
<a name="line-291"></a><font color=Blue><i>-- explicitly, so that the typechecker can warn us about new gates</i></font>
<a name="line-292"></a><font color=Blue><i>-- that must be added here.</i></font>
<a name="line-293"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QMeas <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> False
<a name="line-294"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>QDiscard <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> False
<a name="line-295"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>CDiscard <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> False
<a name="line-296"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>DTerm <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> False
<a name="line-297"></a><font color=Blue>gate_ncflag</font> <font color=Cyan>(</font>Comment <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> False
<a name="line-298"></a>
<a name="line-299"></a>
<a name="line-300"></a><a name="gate_with_ncflag"></a><font color=Blue><i>-- | Apply the given 'NoControlFlag' to the given 'Gate'. This means,</i></font>
<a name="line-301"></a><font color=Blue><i>-- if the first parameter is 'True', set the gate's 'NoControlFlag',</i></font>
<a name="line-302"></a><font color=Blue><i>-- otherwise do nothing. Throw an error if attempting to set the</i></font>
<a name="line-303"></a><font color=Blue><i>-- 'NoControlFlag' on a gate that can't support this flag.</i></font>
<a name="line-304"></a><font color=Blue>gate_with_ncflag</font> <font color=Red>::</font> NoControlFlag <font color=Red>-&gt;</font> Gate <font color=Red>-&gt;</font> Gate
<a name="line-305"></a><font color=Blue>gate_with_ncflag</font> False gate <font color=Red>=</font> gate
<a name="line-306"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>QGate n inv ws1 ws2 c <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>QGate n inv ws1 ws2 c True<font color=Cyan>)</font>
<a name="line-307"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>QRot n inv t ws1 ws2 c <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>QRot n inv t ws1 ws2 c True<font color=Cyan>)</font>
<a name="line-308"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>GPhase t w c <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>GPhase t w c True<font color=Cyan>)</font>
<a name="line-309"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>CNot w c <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>CNot w c True<font color=Cyan>)</font>
<a name="line-310"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>CGate n w ws <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>CGate n w ws True<font color=Cyan>)</font>
<a name="line-311"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>CGateInv n w ws <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>CGateInv n w ws True<font color=Cyan>)</font>
<a name="line-312"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>CSwap w1 w2 c <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>CSwap w1 w2 c True<font color=Cyan>)</font>
<a name="line-313"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>QPrep w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>QPrep w True<font color=Cyan>)</font>
<a name="line-314"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>QUnprep w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>QUnprep w True<font color=Cyan>)</font>
<a name="line-315"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>QInit b w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>QInit b w True<font color=Cyan>)</font>
<a name="line-316"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>CInit b w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>CInit b w True<font color=Cyan>)</font>
<a name="line-317"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>QTerm b w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>QTerm b w True<font color=Cyan>)</font>
<a name="line-318"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>CTerm b w <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>CTerm b w True<font color=Cyan>)</font>
<a name="line-319"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>Subroutine n inv ws1 a1 ws2 a2 c <font color=Green><u>_</u></font> ctrble repeat<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>Subroutine n inv ws1 a1 ws2 a2 c True ctrble repeat<font color=Cyan>)</font>
<a name="line-320"></a><font color=Blue>gate_with_ncflag</font> True <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font>
<a name="line-321"></a><font color=Blue><i>-- The remaining gates can't have their 'NoControlFlag' set. We list</i></font>
<a name="line-322"></a><font color=Blue><i>-- them explicitly, so that the typechecker can warn us about new</i></font>
<a name="line-323"></a><font color=Blue><i>-- gates that must be added here.</i></font>
<a name="line-324"></a><font color=Blue>gate_with_ncflag</font> True g<font color=Red>@</font><font color=Cyan>(</font>QMeas <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-325"></a>  error <font color=Cyan>(</font><font color=Magenta>"gate "</font> <font color=Cyan>++</font> show g <font color=Cyan>++</font> <font color=Magenta>" can't be used in a without_controls context"</font><font color=Cyan>)</font>
<a name="line-326"></a><font color=Blue>gate_with_ncflag</font> True g<font color=Red>@</font><font color=Cyan>(</font>QDiscard <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-327"></a>  error <font color=Cyan>(</font><font color=Magenta>"gate "</font> <font color=Cyan>++</font> show g <font color=Cyan>++</font> <font color=Magenta>" can't be used in a without_controls context"</font><font color=Cyan>)</font>
<a name="line-328"></a><font color=Blue>gate_with_ncflag</font> True g<font color=Red>@</font><font color=Cyan>(</font>CDiscard <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-329"></a>  error <font color=Cyan>(</font><font color=Magenta>"gate "</font> <font color=Cyan>++</font> show g <font color=Cyan>++</font> <font color=Magenta>" can't be used in a without_controls context"</font><font color=Cyan>)</font>
<a name="line-330"></a><font color=Blue>gate_with_ncflag</font> True g<font color=Red>@</font><font color=Cyan>(</font>DTerm <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-331"></a>  error <font color=Cyan>(</font><font color=Magenta>"gate "</font> <font color=Cyan>++</font> show g <font color=Cyan>++</font> <font color=Magenta>" can't be used in a without_controls context"</font><font color=Cyan>)</font>
<a name="line-332"></a>
<a name="line-333"></a><a name="gate_reverse"></a><font color=Blue><i>-- | Reverse a gate. Throw an error if the gate is not reversible.</i></font>
<a name="line-334"></a><font color=Blue>gate_reverse</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> Gate
<a name="line-335"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>QGate n inv ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> QGate n <font color=Cyan>(</font>not inv<font color=Cyan>)</font> ws1 ws2 c ncf
<a name="line-336"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>QRot n inv t ws1 ws2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> QRot n <font color=Cyan>(</font>not inv<font color=Cyan>)</font> t ws1 ws2 c ncf
<a name="line-337"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>GPhase t w c ncf<font color=Cyan>)</font> <font color=Red>=</font> GPhase <font color=Cyan>(</font><font color=Blue><i>-</i></font>t<font color=Cyan>)</font> w c ncf
<a name="line-338"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>CNot w c ncf<font color=Cyan>)</font> <font color=Red>=</font> CNot w c ncf
<a name="line-339"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>CGate n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> CGateInv n w ws ncf
<a name="line-340"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>CGateInv n w ws ncf<font color=Cyan>)</font> <font color=Red>=</font> CGate n w ws ncf
<a name="line-341"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>CSwap w1 w2 c ncf<font color=Cyan>)</font> <font color=Red>=</font> CSwap w1 w2 c ncf
<a name="line-342"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>QPrep w ncf<font color=Cyan>)</font> <font color=Red>=</font> QUnprep w ncf
<a name="line-343"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>QUnprep w ncf<font color=Cyan>)</font> <font color=Red>=</font> QPrep w ncf
<a name="line-344"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>QInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> QTerm b w ncf
<a name="line-345"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>CInit b w ncf<font color=Cyan>)</font> <font color=Red>=</font> CTerm b w ncf
<a name="line-346"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>QTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> QInit b w ncf
<a name="line-347"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>CTerm b w ncf<font color=Cyan>)</font> <font color=Red>=</font> CInit b w ncf
<a name="line-348"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>Subroutine name inv ws1 a1 ws2 a2 c ncf ctrble repeat<font color=Cyan>)</font> <font color=Red>=</font> Subroutine name <font color=Cyan>(</font>not inv<font color=Cyan>)</font> ws2 a2 ws1 a1 c ncf ctrble repeat
<a name="line-349"></a><font color=Blue>gate_reverse</font> <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font> <font color=Red>=</font> Comment s <font color=Cyan>(</font>not inv<font color=Cyan>)</font> ws
<a name="line-350"></a><font color=Blue><i>-- The remaining gates are not reversible. We list them explicitly, so</i></font>
<a name="line-351"></a><font color=Blue><i>-- that the typechecker can warn us about new gates that must be added</i></font>
<a name="line-352"></a><font color=Blue><i>-- here.</i></font>
<a name="line-353"></a><font color=Blue>gate_reverse</font> g<font color=Red>@</font><font color=Cyan>(</font>QMeas <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> error <font color=Cyan>(</font><font color=Magenta>"gate_reverse: gate not reversible: "</font> <font color=Cyan>++</font> show g<font color=Cyan>)</font>
<a name="line-354"></a><font color=Blue>gate_reverse</font> g<font color=Red>@</font><font color=Cyan>(</font>QDiscard <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> error <font color=Cyan>(</font><font color=Magenta>"gate_reverse: gate not reversible: "</font> <font color=Cyan>++</font> show g<font color=Cyan>)</font>
<a name="line-355"></a><font color=Blue>gate_reverse</font> g<font color=Red>@</font><font color=Cyan>(</font>CDiscard <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> error <font color=Cyan>(</font><font color=Magenta>"gate_reverse: gate not reversible: "</font> <font color=Cyan>++</font> show g<font color=Cyan>)</font>
<a name="line-356"></a><font color=Blue>gate_reverse</font> g<font color=Red>@</font><font color=Cyan>(</font>DTerm <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> error <font color=Cyan>(</font><font color=Magenta>"gate_reverse: gate not reversible: "</font> <font color=Cyan>++</font> show g<font color=Cyan>)</font>
<a name="line-357"></a>
<a name="line-358"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-359"></a><font color=Blue><i>-- * Auxiliary functions on gates and wires</i></font>
<a name="line-360"></a>
<a name="line-361"></a><a name="wires_of_controls"></a><font color=Blue><i>-- | Return the set of wires used by a list of controls.</i></font>
<a name="line-362"></a><font color=Blue>wires_of_controls</font> <font color=Red>::</font> Controls <font color=Red>-&gt;</font> IntSet
<a name="line-363"></a><font color=Blue>wires_of_controls</font> c <font color=Red>=</font> IntSet<font color=Cyan>.</font>fromList <font color=Cyan>(</font>map from_signed c<font color=Cyan>)</font>
<a name="line-364"></a>
<a name="line-365"></a><a name="wires_of_gate"></a><font color=Blue><i>-- | Return the set of wires used by a gate (including controls,</i></font>
<a name="line-366"></a><font color=Blue><i>-- labels, and anchors). </i></font>
<a name="line-367"></a><font color=Blue><i>-- </i></font>
<a name="line-368"></a><font color=Blue><i>-- Unlike 'gate_arity', the function 'wires_of_gate' is used for</i></font>
<a name="line-369"></a><font color=Blue><i>-- printing, and therefore returns all wires that are syntactically</i></font>
<a name="line-370"></a><font color=Blue><i>-- used by the gate, irrespective of whether they have a logical</i></font>
<a name="line-371"></a><font color=Blue><i>-- meaning.</i></font>
<a name="line-372"></a><font color=Blue>wires_of_gate</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> IntSet
<a name="line-373"></a><font color=Blue>wires_of_gate</font> <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-374"></a>  intset_inserts <font color=Cyan>(</font>map fst ws<font color=Cyan>)</font> <font color=Cyan>(</font>IntSet<font color=Cyan>.</font>empty<font color=Cyan>)</font>
<a name="line-375"></a><font color=Blue>wires_of_gate</font> <font color=Cyan>(</font>GPhase t w c ncf<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-376"></a>  intset_inserts w <font color=Cyan>(</font>wires_of_controls c<font color=Cyan>)</font>
<a name="line-377"></a><font color=Blue>wires_of_gate</font> g <font color=Red>=</font> intset_inserts w1 <font color=Cyan>(</font>intset_inserts w2 <font color=Cyan>(</font>wires_of_controls c<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-378"></a>  <font color=Green><u>where</u></font>
<a name="line-379"></a>    <font color=Cyan>(</font>a1<font color=Cyan>,</font> a2<font color=Cyan>)</font> <font color=Red>=</font> gate_arity g
<a name="line-380"></a>    c <font color=Red>=</font> gate_controls g
<a name="line-381"></a>    w1 <font color=Red>=</font> map fst a1
<a name="line-382"></a>    w2 <font color=Red>=</font> map fst a2
<a name="line-383"></a>
<a name="line-384"></a><a name="wirelist_of_gate"></a><font color=Blue><i>-- | Like 'wires_of_gate', except return a list of wires.</i></font>
<a name="line-385"></a><font color=Blue>wirelist_of_gate</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font>
<a name="line-386"></a><font color=Blue>wirelist_of_gate</font> g <font color=Red>=</font> IntSet<font color=Cyan>.</font>toList <font color=Cyan>(</font>wires_of_gate g<font color=Cyan>)</font>
<a name="line-387"></a>
<a name="line-388"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-389"></a><font color=Blue><i>-- * Dynamic arities</i></font>
<a name="line-390"></a>
<a name="line-391"></a><font color=Blue><i>-- | Recall that an 'Arity' is a set of typed wires, and it determines</i></font>
<a name="line-392"></a><font color=Blue><i>-- the external interfaces at which circuits and gates can be</i></font>
<a name="line-393"></a><font color=Blue><i>-- connected.  The type 'ExtArity' stores the same information as the</i></font>
<a name="line-394"></a><font color=Blue><i>-- type 'Arity', but in a format that is more optimized for efficient</i></font>
<a name="line-395"></a><font color=Blue><i>-- updating. Additionally, it also stores the set of wires ever used.</i></font>
<a name="line-396"></a>
<a name="line-397"></a><a name="ExtArity"></a><font color=Green><u>type</u></font> ExtArity <font color=Red>=</font> XIntMap Wiretype
<a name="line-398"></a>
<a name="line-399"></a><font color=Blue><i>-- | Check whether the given gate is well-formed and can be legally</i></font>
<a name="line-400"></a><font color=Blue><i>-- applied in the context of the given arity. If successful, return</i></font>
<a name="line-401"></a><font color=Blue><i>-- the updated arity resulting from the gate application. If</i></font>
<a name="line-402"></a><font color=Blue><i>-- unsuccessful, raise an error. Properties checked are:</i></font>
<a name="line-403"></a><font color=Blue><i>-- </i></font>
<a name="line-404"></a><font color=Blue><i>-- * that each gate has non-overlapping inputs, including controls;</i></font>
<a name="line-405"></a><font color=Blue><i>-- </i></font>
<a name="line-406"></a><font color=Blue><i>-- * that each gate has non-overlapping outputs, including controls;</i></font>
<a name="line-407"></a><font color=Blue><i>-- </i></font>
<a name="line-408"></a><font color=Blue><i>-- * that the inputs of the gate (including controls) are actually</i></font>
<a name="line-409"></a><font color=Blue><i>-- present in the current arity; </i></font>
<a name="line-410"></a><font color=Blue><i>-- </i></font>
<a name="line-411"></a><font color=Blue><i>-- * that the types of the inputs (excluding controls) match those of</i></font>
<a name="line-412"></a><font color=Blue><i>-- the current arity;</i></font>
<a name="line-413"></a><font color=Blue><i>-- </i></font>
<a name="line-414"></a><font color=Blue><i>-- * that the outputs of the gate (excluding controls) don't conflict</i></font>
<a name="line-415"></a><font color=Blue><i>-- with any wires already existing in the current arity.</i></font>
<a name="line-416"></a>
<a name="line-417"></a><a name="arity_append_safe"></a><font color=Blue>arity_append_safe</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> ExtArity <font color=Red>-&gt;</font> ExtArity
<a name="line-418"></a><font color=Blue>arity_append_safe</font> gate a0 <font color=Red>=</font> 
<a name="line-419"></a>  <font color=Green><u>case</u></font> <font color=Cyan>(</font>err0<font color=Cyan>,</font> err1<font color=Cyan>,</font> err2<font color=Cyan>,</font> err3<font color=Cyan>,</font> err4<font color=Cyan>)</font> <font color=Green><u>of</u></font>
<a name="line-420"></a>    <font color=Cyan>(</font>True<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> 
<a name="line-421"></a>      error <font color=Cyan>$</font> <font color=Magenta>"Gate error: duplicate inputs in "</font> <font color=Cyan>++</font> show gate
<a name="line-422"></a>    <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> True<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> 
<a name="line-423"></a>      error <font color=Cyan>$</font> <font color=Magenta>"Gate error: duplicate outputs in "</font> <font color=Cyan>++</font> show gate
<a name="line-424"></a>    <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> Just w<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font>
<a name="line-425"></a>      error <font color=Cyan>$</font> <font color=Magenta>"Gate application error: no such wire "</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>": "</font> <font color=Cyan>++</font> show gate
<a name="line-426"></a>    <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> Just <font color=Cyan>(</font>w<font color=Cyan>,</font>t<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font>
<a name="line-427"></a>      error <font color=Cyan>$</font> <font color=Magenta>"Gate application error: wire "</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>":"</font> <font color=Cyan>++</font> show t <font color=Cyan>++</font> <font color=Magenta>" has wrong type "</font> <font color=Cyan>++</font> show t' <font color=Cyan>++</font> <font color=Magenta>": "</font> <font color=Cyan>++</font> show gate
<a name="line-428"></a>      <font color=Green><u>where</u></font>
<a name="line-429"></a>        Just t' <font color=Red>=</font> xintmap_lookup w a0
<a name="line-430"></a>    <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> Just w<font color=Cyan>)</font> <font color=Red>-&gt;</font>
<a name="line-431"></a>      error <font color=Cyan>$</font> <font color=Magenta>"Gate application error: wire "</font> <font color=Cyan>++</font> show w <font color=Cyan>++</font> <font color=Magenta>" already exists: "</font> <font color=Cyan>++</font> show gate
<a name="line-432"></a>    <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> a2
<a name="line-433"></a>  <font color=Green><u>where</u></font>
<a name="line-434"></a>    <font color=Cyan>(</font>win<font color=Cyan>,</font> wout<font color=Cyan>)</font> <font color=Red>=</font> gate_arity gate
<a name="line-435"></a>    c_ids <font color=Red>=</font> map from_signed <font color=Cyan>(</font>gate_controls gate<font color=Cyan>)</font>
<a name="line-436"></a>    win_ids <font color=Red>=</font> map fst win
<a name="line-437"></a>    wout_ids <font color=Red>=</font> map fst wout
<a name="line-438"></a>    err0 <font color=Red>=</font> has_duplicates <font color=Cyan>(</font>win_ids <font color=Cyan>++</font> c_ids<font color=Cyan>)</font>
<a name="line-439"></a>    err1 <font color=Red>=</font> has_duplicates <font color=Cyan>(</font>wout_ids <font color=Cyan>++</font> c_ids<font color=Cyan>)</font>
<a name="line-440"></a>    err2 <font color=Red>=</font> find <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> not <font color=Cyan>$</font> xintmap_member w a0<font color=Cyan>)</font> <font color=Cyan>(</font>win_ids <font color=Cyan>++</font> c_ids<font color=Cyan>)</font>
<a name="line-441"></a>    err3 <font color=Red>=</font> find <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>w<font color=Cyan>,</font>t<font color=Cyan>)</font> <font color=Red>-&gt;</font> not <font color=Cyan>$</font> xintmap_lookup w a0 <font color=Cyan>==</font> Just t<font color=Cyan>)</font> win
<a name="line-442"></a>    err4 <font color=Red>=</font> find <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> xintmap_member w a1<font color=Cyan>)</font> wout_ids
<a name="line-443"></a>    a1 <font color=Red>=</font> xintmap_deletes win_ids a0
<a name="line-444"></a>    a2 <font color=Red>=</font> xintmap_inserts wout a1
<a name="line-445"></a>
<a name="line-446"></a><a name="arity_append_unsafe"></a><font color=Blue><i>-- | Like 'arity_append', but without type checking. This is</i></font>
<a name="line-447"></a><font color=Blue><i>-- potentially faster, but should only used in applications that have</i></font>
<a name="line-448"></a><font color=Blue><i>-- already been thoroughly tested or type-checked.</i></font>
<a name="line-449"></a><font color=Blue>arity_append_unsafe</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> ExtArity <font color=Red>-&gt;</font> ExtArity
<a name="line-450"></a><font color=Blue>arity_append_unsafe</font> gate a0 <font color=Red>=</font> a2
<a name="line-451"></a>  <font color=Green><u>where</u></font>
<a name="line-452"></a>    <font color=Cyan>(</font>win<font color=Cyan>,</font> wout<font color=Cyan>)</font> <font color=Red>=</font> gate_arity gate
<a name="line-453"></a>    a1 <font color=Red>=</font> xintmap_deletes <font color=Cyan>(</font>map fst win<font color=Cyan>)</font> a0    
<a name="line-454"></a>    a2 <font color=Red>=</font> xintmap_inserts wout a1
<a name="line-455"></a>
<a name="line-456"></a><a name="arity_append"></a><font color=Blue><i>-- | For now, we disable run-time type checking, because we have not</i></font>
<a name="line-457"></a><font color=Blue><i>-- yet implemented run-time types properly. Therefore, we define</i></font>
<a name="line-458"></a><font color=Blue><i>-- 'arity_append' to be a synonym for 'arity_append_unsafe'.</i></font>
<a name="line-459"></a><font color=Blue>arity_append</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> ExtArity <font color=Red>-&gt;</font> ExtArity
<a name="line-460"></a><font color=Blue>arity_append</font> <font color=Red>=</font> arity_append_unsafe
<a name="line-461"></a>
<a name="line-462"></a><a name="arity_empty"></a><font color=Blue><i>-- | Return an empty arity.</i></font>
<a name="line-463"></a><font color=Blue>arity_empty</font> <font color=Red>::</font> ExtArity
<a name="line-464"></a><font color=Blue>arity_empty</font> <font color=Red>=</font> xintmap_empty
<a name="line-465"></a>
<a name="line-466"></a><a name="arity_unused_wire"></a><font color=Blue><i>-- | Return a wire unused in the current arity.</i></font>
<a name="line-467"></a><font color=Blue>arity_unused_wire</font> <font color=Red>::</font> ExtArity <font color=Red>-&gt;</font> Wire
<a name="line-468"></a><font color=Blue>arity_unused_wire</font> <font color=Red>=</font> xintmap_freshkey
<a name="line-469"></a>
<a name="line-470"></a><a name="arity_unused_wires"></a><font color=Blue><i>-- | Return the next /k/ wires unused in the current arity.</i></font>
<a name="line-471"></a><font color=Blue>arity_unused_wires</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> ExtArity <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font>
<a name="line-472"></a><font color=Blue>arity_unused_wires</font> <font color=Red>=</font> xintmap_freshkeys
<a name="line-473"></a>
<a name="line-474"></a><a name="arity_alloc"></a><font color=Blue><i>-- | Add a new typed wire to the current arity. This returns a new</i></font>
<a name="line-475"></a><font color=Blue><i>-- wire and the updated arity.</i></font>
<a name="line-476"></a><font color=Blue>arity_alloc</font> <font color=Red>::</font> Wiretype <font color=Red>-&gt;</font> ExtArity <font color=Red>-&gt;</font> <font color=Cyan>(</font>Wire<font color=Cyan>,</font> ExtArity<font color=Cyan>)</font>
<a name="line-477"></a><font color=Blue>arity_alloc</font> t arity <font color=Red>=</font> <font color=Cyan>(</font>w<font color=Cyan>,</font> arity'<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-478"></a>  w <font color=Red>=</font> xintmap_freshkey arity
<a name="line-479"></a>  arity' <font color=Red>=</font> xintmap_insert w t arity
<a name="line-480"></a>
<a name="line-481"></a><a name="arity_of_extarity"></a><font color=Blue><i>-- | Convert an extended arity to an ordinary arity.</i></font>
<a name="line-482"></a><font color=Blue>arity_of_extarity</font> <font color=Red>::</font> ExtArity <font color=Red>-&gt;</font> Arity
<a name="line-483"></a><font color=Blue>arity_of_extarity</font> <font color=Red>=</font> xintmap_to_intmap
<a name="line-484"></a>
<a name="line-485"></a><a name="n_of_extarity"></a><font color=Blue><i>-- | Return the smallest wire id nowhere used in the circuit.</i></font>
<a name="line-486"></a><font color=Blue>n_of_extarity</font> <font color=Red>::</font> ExtArity <font color=Red>-&gt;</font> Int
<a name="line-487"></a><font color=Blue>n_of_extarity</font> <font color=Red>=</font> xintmap_size
<a name="line-488"></a>
<a name="line-489"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-490"></a><font color=Blue><i>-- * Circuit abstraction</i></font>
<a name="line-491"></a>
<a name="line-492"></a><a name="Circuit"></a><font color=Blue><i>-- | A completed circuit /(a1,gs,a2,n)/ has an input arity /a1/, a</i></font>
<a name="line-493"></a><a name="Circuit"></a><font color=Blue><i>-- list of gates /gs/, and an output arity /a2/.  We also record /n/,</i></font>
<a name="line-494"></a><a name="Circuit"></a><font color=Blue><i>-- the total number of wires used by the circuit. Because wires are</i></font>
<a name="line-495"></a><a name="Circuit"></a><font color=Blue><i>-- allocated consecutively, this means that the wire id's used are</i></font>
<a name="line-496"></a><a name="Circuit"></a><font color=Blue><i>-- [0../n/-1].</i></font>
<a name="line-497"></a><a name="Circuit"></a><font color=Green><u>type</u></font> Circuit <font color=Red>=</font> <font color=Cyan>(</font>Arity<font color=Cyan>,</font> <font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font> Arity<font color=Cyan>,</font> Int<font color=Cyan>)</font>
<a name="line-498"></a>
<a name="line-499"></a><a name="wirelist_of_circuit"></a><font color=Blue><i>-- | Return the set of all the wires in a circuit.</i></font>
<a name="line-500"></a><font color=Blue>wirelist_of_circuit</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font>
<a name="line-501"></a><font color=Blue>wirelist_of_circuit</font> <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Red>[</font><font color=Magenta>0</font><font color=Red>..</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Red>]</font>
<a name="line-502"></a>
<a name="line-503"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-504"></a><font color=Blue><i>-- ** Reversing low-level circuits</i></font>
<a name="line-505"></a>
<a name="line-506"></a><a name="reverse_gatelist"></a><font color=Blue><i>-- | Reverse a gate list.</i></font>
<a name="line-507"></a><font color=Blue>reverse_gatelist</font> <font color=Red>::</font> <font color=Red>[</font>Gate<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Gate<font color=Red>]</font>
<a name="line-508"></a><font color=Blue>reverse_gatelist</font> gates <font color=Red>=</font> reverse <font color=Cyan>(</font>map gate_reverse gates<font color=Cyan>)</font>
<a name="line-509"></a>
<a name="line-510"></a><a name="reverse_circuit"></a><font color=Blue><i>-- | Reverse a circuit. Throw an error if the circuit is not reversible.</i></font>
<a name="line-511"></a><font color=Blue>reverse_circuit</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> Circuit
<a name="line-512"></a><font color=Blue>reverse_circuit</font> <font color=Cyan>(</font>a1<font color=Cyan>,</font> gates<font color=Cyan>,</font> a2<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>a2<font color=Cyan>,</font> reverse_gatelist gates<font color=Cyan>,</font> a1<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-513"></a>
<a name="line-514"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-515"></a><font color=Blue><i>-- ** NoControlFlag on low-level circuits</i></font>
<a name="line-516"></a>
<a name="line-517"></a><a name="circuit_to_nocontrol"></a><font color=Blue><i>-- | Set the 'NoControlFlag' on all gates of a circuit.</i></font>
<a name="line-518"></a><font color=Blue>circuit_to_nocontrol</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> Circuit
<a name="line-519"></a><font color=Blue>circuit_to_nocontrol</font> <font color=Cyan>(</font>a1<font color=Cyan>,</font> gates<font color=Cyan>,</font> a2<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>a1<font color=Cyan>,</font> gates'<font color=Cyan>,</font> a2<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-520"></a>  gates' <font color=Red>=</font> map <font color=Cyan>(</font>gate_with_ncflag True<font color=Cyan>)</font> gates
<a name="line-521"></a>
<a name="line-522"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-523"></a><font color=Blue><i>-- ** Ordered circuits</i></font>
<a name="line-524"></a>
<a name="line-525"></a><a name="OCircuit"></a><font color=Blue><i>-- | An ordered circuit is a 'Circuit' together with an ordering on</i></font>
<a name="line-526"></a><a name="OCircuit"></a><font color=Blue><i>-- (usually all, but potentially a subset of) the input and output</i></font>
<a name="line-527"></a><a name="OCircuit"></a><font color=Blue><i>-- endpoints.</i></font>
<a name="line-528"></a><a name="OCircuit"></a><font color=Blue><i>--</i></font>
<a name="line-529"></a><a name="OCircuit"></a><font color=Blue><i>-- This extra information is required when a circuit is used within a</i></font>
<a name="line-530"></a><a name="OCircuit"></a><font color=Blue><i>-- larger circuit (e.g. via a 'Subroutine' gate), to identify which wires</i></font>
<a name="line-531"></a><a name="OCircuit"></a><font color=Blue><i>-- of the sub-circuit should be bound to which wires of the surrounding </i></font>
<a name="line-532"></a><a name="OCircuit"></a><font color=Blue><i>-- circuit.</i></font>
<a name="line-533"></a><a name="OCircuit"></a><font color=Green><u>newtype</u></font> OCircuit <font color=Red>=</font> OCircuit <font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font> Circuit<font color=Cyan>,</font> <font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-534"></a>
<a name="line-535"></a><a name="reverse_ocircuit"></a><font color=Blue><i>-- | Reverse an 'OCircuit'. Throw an error if the circuit is not reversible.</i></font>
<a name="line-536"></a><font color=Blue>reverse_ocircuit</font> <font color=Red>::</font> OCircuit <font color=Red>-&gt;</font> OCircuit
<a name="line-537"></a><font color=Blue>reverse_ocircuit</font> <font color=Cyan>(</font>OCircuit <font color=Cyan>(</font>ws_in<font color=Cyan>,</font> circ<font color=Cyan>,</font> ws_out<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> OCircuit <font color=Cyan>(</font>ws_out<font color=Cyan>,</font> reverse_circuit circ<font color=Cyan>,</font> ws_out<font color=Cyan>)</font> 
<a name="line-538"></a>
<a name="line-539"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-540"></a><font color=Blue><i>-- ** Annotated circuits</i></font>
<a name="line-541"></a>
<a name="line-542"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- | One often wants to consider the inputs and outputs of a circuit as</i></font>
<a name="line-543"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- more structured/typed than just lists of bits/qubits; for instance,</i></font>
<a name="line-544"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- a list of six qubits could be structured as a pair of triples, or a </i></font>
<a name="line-545"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- triple of pairs, or a six-bit 'QDInt'.</i></font>
<a name="line-546"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>--</i></font>
<a name="line-547"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- While for the most part this typing information is not included in </i></font>
<a name="line-548"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- low-level circuits, we need to consider it in hierarchical circuits,</i></font>
<a name="line-549"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- so that the information stored in a subroutine is sufficient to call</i></font>
<a name="line-550"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- the subroutine in a typed context.</i></font>
<a name="line-551"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>--</i></font>
<a name="line-552"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- Specifically, the extra information needed consists of functions to</i></font>
<a name="line-553"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- destructure the input/output data as a list of typed wires, and </i></font>
<a name="line-554"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- restructure such a list of wires into a piece of data of the appropriate</i></font>
<a name="line-555"></a><a name="CircuitTypeStructure"></a><font color=Blue><i>-- type. </i></font>
<a name="line-556"></a><a name="CircuitTypeStructure"></a><font color=Green><u>data</u></font> CircuitTypeStructure a <font color=Red>=</font> CircuitTypeStructure <font color=Cyan>(</font>a <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font>Arity<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>(</font><font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font>Arity<font color=Cyan>)</font> <font color=Red>-&gt;</font> a<font color=Cyan>)</font>
<a name="line-557"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Typeable<font color=Cyan>)</font>
<a name="line-558"></a>
<a name="line-559"></a><a name="id_CircuitTypeStructure"></a><font color=Blue><i>-- | The trivial 'CircuitTypeStructure' on @(['Wire'],'Arity')@.</i></font>
<a name="line-560"></a><font color=Blue>id_CircuitTypeStructure</font> <font color=Red>::</font> CircuitTypeStructure <font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font>Arity<font color=Cyan>)</font>
<a name="line-561"></a><font color=Blue>id_CircuitTypeStructure</font> <font color=Red>=</font> CircuitTypeStructure id id
<a name="line-562"></a>
<a name="line-563"></a><a name="destructure_with"></a><font color=Blue><i>-- | Use a 'CircuitTypeStructure' to destructure a piece of (suitably</i></font>
<a name="line-564"></a><font color=Blue><i>-- typed) data into a list of typed wires.</i></font>
<a name="line-565"></a><font color=Blue>destructure_with</font> <font color=Red>::</font> CircuitTypeStructure a <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font>Arity<font color=Cyan>)</font>
<a name="line-566"></a><font color=Blue>destructure_with</font> <font color=Cyan>(</font>CircuitTypeStructure f <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> f
<a name="line-567"></a>
<a name="line-568"></a><a name="structure_with"></a><font color=Blue><i>-- | Use a 'CircuitTypeStructure' to structure a list of typed wires </i></font>
<a name="line-569"></a><font color=Blue><i>-- (of the appropriate length/arity) into a piece of structured data.</i></font>
<a name="line-570"></a><font color=Blue>structure_with</font> <font color=Red>::</font> CircuitTypeStructure a <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font>Arity<font color=Cyan>)</font> <font color=Red>-&gt;</font> a
<a name="line-571"></a><font color=Blue>structure_with</font> <font color=Cyan>(</font>CircuitTypeStructure <font color=Green><u>_</u></font> g<font color=Cyan>)</font> <font color=Red>=</font> g
<a name="line-572"></a>
<a name="line-573"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-574"></a><font color=Blue><i>-- * Boxed circuits</i></font>
<a name="line-575"></a>
<a name="line-576"></a><a name="TypedSubroutine"></a><font color=Blue><i>-- | A typed subroutine consists of:</i></font>
<a name="line-577"></a><a name="TypedSubroutine"></a><font color=Blue><i>--</i></font>
<a name="line-578"></a><a name="TypedSubroutine"></a><font color=Blue><i>-- * a low-level circuit, ordered to allow binding of incoming and outgoing wires;</i></font>
<a name="line-579"></a><a name="TypedSubroutine"></a><font color=Blue><i>--</i></font>
<a name="line-580"></a><a name="TypedSubroutine"></a><font color=Blue><i>-- * functions for structuring/destructuring the inputs and outputs to and </i></font>
<a name="line-581"></a><a name="TypedSubroutine"></a><font color=Blue><i>-- from lists of wires (these functions being dynamically typed, since the </i></font>
<a name="line-582"></a><a name="TypedSubroutine"></a><font color=Blue><i>-- input/output type may vary between subroutines);</i></font>
<a name="line-583"></a><a name="TypedSubroutine"></a><font color=Blue><i>--</i></font>
<a name="line-584"></a><a name="TypedSubroutine"></a><font color=Blue><i>-- * a 'ControllableFlag', recording whether the circuit is controllable.</i></font>
<a name="line-585"></a><a name="TypedSubroutine"></a><font color=Green><u>data</u></font> TypedSubroutine <font color=Red>=</font> <font color=Green><u>forall</u></font> a b<font color=Cyan>.</font> <font color=Cyan>(</font>Typeable a<font color=Cyan>,</font> Typeable b<font color=Cyan>)</font> <font color=Red>=&gt;</font>
<a name="line-586"></a>  TypedSubroutine OCircuit <font color=Cyan>(</font>CircuitTypeStructure a<font color=Cyan>)</font> <font color=Cyan>(</font>CircuitTypeStructure b<font color=Cyan>)</font> ControllableFlag
<a name="line-587"></a>
<a name="line-588"></a><a name="circuit_of_typedsubroutine"></a><font color=Blue><i>-- | Extract just the 'Circuit' from a 'TypedSubroutine'.</i></font>
<a name="line-589"></a><font color=Blue>circuit_of_typedsubroutine</font> <font color=Red>::</font> TypedSubroutine <font color=Red>-&gt;</font> Circuit
<a name="line-590"></a><font color=Blue>circuit_of_typedsubroutine</font> <font color=Cyan>(</font>TypedSubroutine <font color=Cyan>(</font>OCircuit <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font>circ<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> circ
<a name="line-591"></a>
<a name="line-592"></a><a name="Namespace"></a><font color=Blue><i>-- | A name space is a map from names to subroutine bindings.  These</i></font>
<a name="line-593"></a><a name="Namespace"></a><font color=Blue><i>-- subroutines can reference each other; it is the programmer&#8217;s</i></font>
<a name="line-594"></a><a name="Namespace"></a><font color=Blue><i>-- responsibility to ensure there is no circular dependency, and no</i></font>
<a name="line-595"></a><a name="Namespace"></a><font color=Blue><i>-- clash of names.</i></font>
<a name="line-596"></a><a name="Namespace"></a><font color=Green><u>type</u></font> Namespace <font color=Red>=</font> Map BoxId TypedSubroutine
<a name="line-597"></a>
<a name="line-598"></a><a name="namespace_empty"></a><font color=Blue><i>-- | The empty namespace.</i></font>
<a name="line-599"></a><font color=Blue>namespace_empty</font> <font color=Red>::</font> Namespace
<a name="line-600"></a><font color=Blue>namespace_empty</font> <font color=Red>=</font> Map<font color=Cyan>.</font>empty
<a name="line-601"></a>
<a name="line-602"></a><a name="showNames"></a><font color=Blue><i>-- | A function to display the names of all the subroutines in a 'Namespace'.</i></font>
<a name="line-603"></a><font color=Blue>showNames</font> <font color=Red>::</font> Namespace <font color=Red>-&gt;</font> String
<a name="line-604"></a><font color=Blue>showNames</font> ns <font color=Red>=</font> show <font color=Cyan>(</font>map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>n<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> n<font color=Cyan>)</font> <font color=Cyan>(</font>Map<font color=Cyan>.</font>toList ns<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-605"></a>
<a name="line-606"></a><a name="BCircuit"></a><font color=Blue><i>-- | A boxed circuit is a distinguished simple circuit (analogous to a &#8220;main&#8221; function) together with a namespace. </i></font>
<a name="line-607"></a><a name="BCircuit"></a><font color=Green><u>type</u></font> BCircuit <font color=Red>=</font> <font color=Cyan>(</font>Circuit<font color=Cyan>,</font>Namespace<font color=Cyan>)</font>
<a name="line-608"></a>
<a name="line-609"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-610"></a><font color=Blue><i>-- ** Ordered circuits</i></font>
<a name="line-611"></a>
<a name="line-612"></a><a name="OBCircuit"></a><font color=Blue><i>-- | An ordered boxed circuit is a 'BCircuit' together with an</i></font>
<a name="line-613"></a><a name="OBCircuit"></a><font color=Blue><i>-- ordering on the input and output endpoints, or equivalently, an</i></font>
<a name="line-614"></a><a name="OBCircuit"></a><font color=Blue><i>-- 'OCircuit' together with a namespace.</i></font>
<a name="line-615"></a><a name="OBCircuit"></a><font color=Green><u>type</u></font> OBCircuit <font color=Red>=</font> <font color=Cyan>(</font>OCircuit<font color=Cyan>,</font>Namespace<font color=Cyan>)</font>
<a name="line-616"></a>
<a name="line-617"></a><a name="ob_circuit"></a><font color=Blue><i>-- | Construct an 'OBCircuit' from a 'BCircuit' and an ordering on the</i></font>
<a name="line-618"></a><font color=Blue><i>-- input and output endpoints.</i></font>
<a name="line-619"></a><font color=Blue>ob_circuit</font> <font color=Red>::</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> BCircuit <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> OBCircuit
<a name="line-620"></a><font color=Blue>ob_circuit</font> w_in <font color=Cyan>(</font>circ<font color=Cyan>,</font> ns<font color=Cyan>)</font> w_out <font color=Red>=</font> <font color=Cyan>(</font>OCircuit <font color=Cyan>(</font>w_in<font color=Cyan>,</font> circ<font color=Cyan>,</font> w_out<font color=Cyan>)</font><font color=Cyan>,</font> ns<font color=Cyan>)</font>
<a name="line-621"></a>
<a name="line-622"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-623"></a><font color=Blue><i>-- ** Basic functions lifted to boxed circuits</i></font>
<a name="line-624"></a>
<a name="line-625"></a><font color=Blue><i>-- All the basic functions defined on simple circuits now lift</i></font>
<a name="line-626"></a><font color=Blue><i>-- trivially to boxed circuits:</i></font>
<a name="line-627"></a> 
<a name="line-628"></a><a name="reverse_bcircuit"></a><font color=Blue><i>-- | Reverse a simple boxed circuit, or throw an error if not reversible.</i></font>
<a name="line-629"></a><font color=Blue>reverse_bcircuit</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> BCircuit
<a name="line-630"></a><font color=Blue>reverse_bcircuit</font> <font color=Cyan>(</font>c<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>reverse_circuit c<font color=Cyan>,</font>s<font color=Cyan>)</font>
<a name="line-631"></a>
<a name="line-632"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-633"></a><font color=Blue><i>-- * The ReadWrite monad</i></font>
<a name="line-634"></a>
<a name="line-635"></a><font color=Blue><i>-- $ The 'ReadWrite' monad encapsulates the interaction with a (real</i></font>
<a name="line-636"></a><font color=Blue><i>-- or simulated) low-level quantum device.</i></font>
<a name="line-637"></a>
<a name="line-638"></a><a name="ReadWrite"></a><font color=Blue><i>-- | The 'ReadWrite' monad describes a standard read-write computation,</i></font>
<a name="line-639"></a><a name="ReadWrite"></a><font color=Blue><i>-- here specialized to the case where writes are 'Gate's, prompts are</i></font>
<a name="line-640"></a><a name="ReadWrite"></a><font color=Blue><i>-- 'Bit's, and reads are 'Bool's. Thus, a read-write computation can</i></font>
<a name="line-641"></a><a name="ReadWrite"></a><font color=Blue><i>-- do three things:</i></font>
<a name="line-642"></a><a name="ReadWrite"></a><font color=Blue><i>-- </i></font>
<a name="line-643"></a><a name="ReadWrite"></a><font color=Blue><i>-- * terminate with a result. This is the case 'RW_Return'.</i></font>
<a name="line-644"></a><a name="ReadWrite"></a><font color=Blue><i>-- </i></font>
<a name="line-645"></a><a name="ReadWrite"></a><font color=Blue><i>-- * write a single 'Gate' and continue. This is the case 'RW_Write'.</i></font>
<a name="line-646"></a><a name="ReadWrite"></a><font color=Blue><i>-- </i></font>
<a name="line-647"></a><a name="ReadWrite"></a><font color=Blue><i>-- * issue a prompt, which is a 'Wire', then read a 'Bool', then</i></font>
<a name="line-648"></a><a name="ReadWrite"></a><font color=Blue><i>-- continue. This is the case 'RW_Read'.</i></font>
<a name="line-649"></a><a name="ReadWrite"></a><font color=Green><u>data</u></font> ReadWrite a <font color=Red>=</font> RW_Return a
<a name="line-650"></a>                 <font color=Red>|</font> RW_Write <font color=Cyan>!</font>Gate <font color=Cyan>(</font>ReadWrite a<font color=Cyan>)</font>
<a name="line-651"></a>                 <font color=Red>|</font> RW_Read <font color=Cyan>!</font>Wire <font color=Cyan>(</font>Bool <font color=Red>-&gt;</font> ReadWrite a<font color=Cyan>)</font>
<a name="line-652"></a>                 <font color=Red>|</font> RW_Subroutine BoxId TypedSubroutine <font color=Cyan>(</font>ReadWrite a<font color=Cyan>)</font>
<a name="line-653"></a>
<a name="line-654"></a><font color=Green><u>instance</u></font> Monad ReadWrite <font color=Green><u>where</u></font>
<a name="line-655"></a>  return a <font color=Red>=</font> RW_Return a
<a name="line-656"></a>  f <font color=Cyan>&gt;&gt;=</font> g <font color=Red>=</font> <font color=Green><u>case</u></font> f <font color=Green><u>of</u></font>
<a name="line-657"></a>    RW_Return a <font color=Red>-&gt;</font> g a
<a name="line-658"></a>    RW_Write gate f' <font color=Red>-&gt;</font> RW_Write gate <font color=Cyan>(</font>f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-659"></a>    RW_Read bit cont <font color=Red>-&gt;</font> RW_Read bit <font color=Cyan>(</font><font color=Red>\</font>bool <font color=Red>-&gt;</font> cont bool <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-660"></a>    RW_Subroutine name subroutine f' <font color=Red>-&gt;</font> RW_Subroutine name subroutine <font color=Cyan>(</font>f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-661"></a>
<a name="line-662"></a><a name="readwrite_wrap"></a><font color=Blue><i>-- | Transforms a read-write computation into one that behaves identically,</i></font>
<a name="line-663"></a><font color=Blue><i>-- but also returns the list of gates generated.</i></font>
<a name="line-664"></a><font color=Blue><i>-- </i></font>
<a name="line-665"></a><font color=Blue><i>-- This is used as a building block, for example to allow a read-write</i></font>
<a name="line-666"></a><font color=Blue><i>-- computation to be run in a simulator while simultaneously using a</i></font>
<a name="line-667"></a><font color=Blue><i>-- static backend to print the list of generated gates.</i></font>
<a name="line-668"></a><font color=Blue>readwrite_wrap</font> <font color=Red>::</font> ReadWrite a <font color=Red>-&gt;</font> ReadWrite <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-669"></a><font color=Blue>readwrite_wrap</font> <font color=Cyan>(</font>RW_Return a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-670"></a>  RW_Return <font color=Cyan>(</font>[]<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-671"></a><font color=Blue>readwrite_wrap</font> <font color=Cyan>(</font>RW_Write gate comp<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-672"></a>  <font color=Red>~</font><font color=Cyan>(</font>gates<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>&lt;-</font> readwrite_wrap comp
<a name="line-673"></a>  RW_Write gate <font color=Cyan>(</font>return <font color=Cyan>(</font>gate<font color=Red><b>:</b></font>gates<font color=Cyan>,</font> a<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-674"></a><font color=Blue>readwrite_wrap</font> <font color=Cyan>(</font>RW_Read bit cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-675"></a>  RW_Read bit <font color=Cyan>(</font><font color=Red>\</font>bool <font color=Red>-&gt;</font> readwrite_wrap <font color=Cyan>(</font>cont bool<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-676"></a><font color=Blue>readwrite_wrap</font> <font color=Cyan>(</font>RW_Subroutine name subroutine comp<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-677"></a>  RW_Subroutine name subroutine <font color=Cyan>(</font>readwrite_wrap comp<font color=Cyan>)</font>
<a name="line-678"></a>
<a name="line-679"></a><a name="readwrite_unwind_static"></a><font color=Blue><i>-- | Extract the contents of a static 'ReadWrite' computation. A</i></font>
<a name="line-680"></a><font color=Blue><i>-- 'ReadWrite' computation is said to be static if it contains no</i></font>
<a name="line-681"></a><font color=Blue><i>-- 'RW_Read' instructions, or in other words, no dynamic lifting.  If</i></font>
<a name="line-682"></a><font color=Blue><i>-- an 'RW_Read' instruction is encountered, issue an error message</i></font>
<a name="line-683"></a><font color=Blue><i>-- using the given stub.</i></font>
<a name="line-684"></a><font color=Blue>readwrite_unwind_static</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> ReadWrite a <font color=Red>-&gt;</font> a
<a name="line-685"></a><font color=Blue>readwrite_unwind_static</font> e <font color=Cyan>(</font>RW_Return a<font color=Cyan>)</font> <font color=Red>=</font> a
<a name="line-686"></a><font color=Blue>readwrite_unwind_static</font> e <font color=Cyan>(</font>RW_Write gate comp<font color=Cyan>)</font> <font color=Red>=</font> readwrite_unwind_static e comp
<a name="line-687"></a><font color=Blue>readwrite_unwind_static</font> e <font color=Cyan>(</font>RW_Read bit cont<font color=Cyan>)</font> <font color=Red>=</font> error <font color=Cyan>$</font> e <font color=Magenta>"dynamic lifting"</font>
<a name="line-688"></a><font color=Blue>readwrite_unwind_static</font> e <font color=Cyan>(</font>RW_Subroutine name subroutine comp<font color=Cyan>)</font> <font color=Red>=</font> readwrite_unwind_static e comp
<a name="line-689"></a>
<a name="line-690"></a><a name="gatelist_of_readwrite"></a><font color=Blue><i>-- | Turn a static read-write computation into a list of gates, while</i></font>
<a name="line-691"></a><font color=Blue><i>-- also updating a namespace. \"Static\" means that the computation</i></font>
<a name="line-692"></a><font color=Blue><i>-- may not contain any 'RW_Read' operations. If it does, the message</i></font>
<a name="line-693"></a><font color=Blue><i>-- \"dynamic lifting\" is passed to the given error handler.</i></font>
<a name="line-694"></a><font color=Blue><i>-- </i></font>
<a name="line-695"></a><font color=Blue><i>-- Important usage note: This function returns a triple (/gates/,</i></font>
<a name="line-696"></a><font color=Blue><i>-- /ns/, /x/). The list of gates is generated lazily, and can be</i></font>
<a name="line-697"></a><font color=Blue><i>-- consumed one gate at a time. However, the values /ns/ and /x/ are</i></font>
<a name="line-698"></a><font color=Blue><i>-- only computed at the end of the computation. Any function using</i></font>
<a name="line-699"></a><font color=Blue><i>-- them should not apply a strict pattern match to /ns/ or /x/, or</i></font>
<a name="line-700"></a><font color=Blue><i>-- else the whole list of gates will be generated in memory. For</i></font>
<a name="line-701"></a><font color=Blue><i>-- example, the following will blow up the memory:</i></font>
<a name="line-702"></a><font color=Blue><i>-- </i></font>
<a name="line-703"></a><font color=Blue><i>-- &gt; (gates, ns, (a, n, x)) = gatelist_of_readwrite errmsg comp</i></font>
<a name="line-704"></a><font color=Blue><i>-- </i></font>
<a name="line-705"></a><font color=Blue><i>-- whereas the following will work as intended:</i></font>
<a name="line-706"></a><font color=Blue><i>-- </i></font>
<a name="line-707"></a><font color=Blue><i>-- &gt; (gates, ns, ~(a, n, x)) = gatelist_of_readwrite errmsg comp</i></font>
<a name="line-708"></a><font color=Blue>gatelist_of_readwrite</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> ReadWrite a <font color=Red>-&gt;</font> Namespace <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Gate<font color=Red>]</font><font color=Cyan>,</font> Namespace<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-709"></a><font color=Blue>gatelist_of_readwrite</font> e <font color=Cyan>(</font>RW_Return a<font color=Cyan>)</font> ns <font color=Red>=</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> ns<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-710"></a><font color=Blue>gatelist_of_readwrite</font> e <font color=Cyan>(</font>RW_Write gate comp<font color=Cyan>)</font> ns <font color=Red>=</font> <font color=Cyan>(</font>gate <font color=Red><b>:</b></font> gates<font color=Cyan>,</font> ns'<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-711"></a>  <font color=Cyan>(</font>gates<font color=Cyan>,</font> ns'<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> gatelist_of_readwrite e comp ns
<a name="line-712"></a><font color=Blue>gatelist_of_readwrite</font> e <font color=Cyan>(</font>RW_Read bit cont<font color=Cyan>)</font> ns <font color=Red>=</font> error <font color=Cyan>(</font>e <font color=Magenta>"dynamic lifting"</font><font color=Cyan>)</font>
<a name="line-713"></a><font color=Blue>gatelist_of_readwrite</font> e <font color=Cyan>(</font>RW_Subroutine name subroutine comp<font color=Cyan>)</font> ns <font color=Red>=</font> 
<a name="line-714"></a>  <font color=Green><u>let</u></font> ns' <font color=Red>=</font> map_provide name subroutine ns <font color=Green><u>in</u></font>
<a name="line-715"></a>  gatelist_of_readwrite e comp ns'
<a name="line-716"></a>
<a name="line-717"></a><font color=Blue><i>{-
<a name="line-718"></a>  -- This version is inefficient. Why?
<a name="line-719"></a>  gatelist_of_readwrite_xxx :: ErrMsg -&gt; ReadWrite a -&gt; ([Gate], a)
<a name="line-720"></a>  gatelist_of_readwrite_xxx e comp = 
<a name="line-721"></a>    readwrite_unwind_static e (readwrite_wrap comp)
<a name="line-722"></a>-}</i></font>
<a name="line-723"></a>
<a name="line-724"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-725"></a><font color=Blue><i>-- * Dynamic boxed circuits</i></font>
<a name="line-726"></a>
<a name="line-727"></a><a name="DBCircuit"></a><font color=Blue><i>-- | The type of dynamic boxed circuits. The type 'DBCircuit' /a/ is</i></font>
<a name="line-728"></a><a name="DBCircuit"></a><font color=Blue><i>-- the appropriate generalization of ('BCircuit', /a/), in a setting</i></font>
<a name="line-729"></a><a name="DBCircuit"></a><font color=Blue><i>-- that is dynamic rather than static (i.e., with dynamic lifting or</i></font>
<a name="line-730"></a><a name="DBCircuit"></a><font color=Blue><i>-- \"interactive measurement\").</i></font>
<a name="line-731"></a><a name="DBCircuit"></a><font color=Green><u>type</u></font> DBCircuit a <font color=Red>=</font> <font color=Cyan>(</font>Arity<font color=Cyan>,</font> ReadWrite <font color=Cyan>(</font>Arity<font color=Cyan>,</font> Int<font color=Cyan>,</font> a<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-732"></a>
<a name="line-733"></a><a name="bcircuit_of_static_dbcircuit"></a><font color=Blue><i>-- | Convert a dynamic boxed circuit to a static boxed circuit. The</i></font>
<a name="line-734"></a><font color=Blue><i>-- dynamic boxed circuit may not contain any dynamic liftings, since</i></font>
<a name="line-735"></a><font color=Blue><i>-- these cannot be performed in a static setting. In case any output</i></font>
<a name="line-736"></a><font color=Blue><i>-- liftings are encountered, try to issue a meaningful error via the</i></font>
<a name="line-737"></a><font color=Blue><i>-- given stub error message.</i></font>
<a name="line-738"></a><font color=Blue>bcircuit_of_static_dbcircuit</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> DBCircuit a <font color=Red>-&gt;</font> <font color=Cyan>(</font>BCircuit<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-739"></a><font color=Blue>bcircuit_of_static_dbcircuit</font> e dbcirc <font color=Red>=</font> <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> x<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-740"></a>  <font color=Cyan>(</font>a0<font color=Cyan>,</font> comp<font color=Cyan>)</font> <font color=Red>=</font> dbcirc
<a name="line-741"></a>  bcirc <font color=Red>=</font> <font color=Cyan>(</font>circ<font color=Cyan>,</font> ns<font color=Cyan>)</font>
<a name="line-742"></a>  circ <font color=Red>=</font> <font color=Cyan>(</font>a0<font color=Cyan>,</font> gates<font color=Cyan>,</font> a1<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-743"></a>  <font color=Cyan>(</font>gates<font color=Cyan>,</font> ns<font color=Cyan>,</font> <font color=Red>~</font><font color=Cyan>(</font>a1<font color=Cyan>,</font> n<font color=Cyan>,</font> x<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> gatelist_of_readwrite e comp namespace_empty
<a name="line-744"></a>
<a name="line-745"></a><a name="dbcircuit_of_bcircuit"></a><font color=Blue><i>-- | Convert a boxed circuit to a dynamic boxed circuit. The latter,</i></font>
<a name="line-746"></a><font color=Blue><i>-- of course, contains no 'RW_Read' instructions.</i></font>
<a name="line-747"></a><font color=Blue>dbcircuit_of_bcircuit</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> DBCircuit a
<a name="line-748"></a><font color=Blue>dbcircuit_of_bcircuit</font> bcircuit x <font color=Red>=</font> <font color=Cyan>(</font>a0<font color=Cyan>,</font> comp <font color=Cyan>(</font>Map<font color=Cyan>.</font>toList ns<font color=Cyan>)</font> gates<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-749"></a>  <font color=Cyan>(</font>circuit<font color=Cyan>,</font> ns<font color=Cyan>)</font> <font color=Red>=</font> bcircuit
<a name="line-750"></a>  <font color=Cyan>(</font>a0<font color=Cyan>,</font> gates<font color=Cyan>,</font> a1<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> circuit
<a name="line-751"></a>  comp <font color=Cyan>(</font><font color=Cyan>(</font>boxid<font color=Cyan>,</font>subroutine<font color=Cyan>)</font><font color=Red><b>:</b></font>ns<font color=Cyan>)</font> gs <font color=Red>=</font> RW_Subroutine boxid subroutine <font color=Cyan>(</font>comp ns gs<font color=Cyan>)</font>
<a name="line-752"></a>  comp [] [] <font color=Red>=</font> RW_Return <font color=Cyan>(</font>a1<font color=Cyan>,</font> n<font color=Cyan>,</font> x<font color=Cyan>)</font>
<a name="line-753"></a>  comp [] <font color=Cyan>(</font>g<font color=Red><b>:</b></font>gs<font color=Cyan>)</font> <font color=Red>=</font> RW_Write g <font color=Cyan>(</font>comp [] gs<font color=Cyan>)</font>
</pre>
</body>
</html>