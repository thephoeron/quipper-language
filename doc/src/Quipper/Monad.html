<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE FlexibleInstances #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE BangPatterns #-}</i></font>
<a name="line-3"></a><font color=Blue><i>{-# LANGUAGE RankNTypes #-}</i></font>
<a name="line-4"></a><font color=Blue><i>{-# LANGUAGE FlexibleContexts #-}</i></font>
<a name="line-5"></a><font color=Blue><i>{-# LANGUAGE DeriveDataTypeable  #-}</i></font>
<a name="line-6"></a><font color=Blue><i>{-# LANGUAGE ScopedTypeVariables  #-}</i></font>
<a name="line-7"></a>
<a name="line-8"></a><font color=Blue><i>-- | This module provides a high-level circuit building interface</i></font>
<a name="line-9"></a><font color=Blue><i>-- intended to look \"functional\". At a given time, there is a</i></font>
<a name="line-10"></a><font color=Blue><i>-- circuit being assembled. This circuit has free endpoints (on the</i></font>
<a name="line-11"></a><font color=Blue><i>-- left and right) that can be bound to variables. A qubit or bit is</i></font>
<a name="line-12"></a><font color=Blue><i>-- simply an endpoint in such a circuit. \"Applying\" an operation to</i></font>
<a name="line-13"></a><font color=Blue><i>-- a qubit or bit simply appends the operation to the current</i></font>
<a name="line-14"></a><font color=Blue><i>-- circuit. We use the 'Circ' monad to capture the side effect of</i></font>
<a name="line-15"></a><font color=Blue><i>-- assembling a circuit.</i></font>
<a name="line-16"></a>
<a name="line-17"></a><font color=Green><u>module</u></font> Quipper<font color=Cyan>.</font>Monad <font color=Cyan>(</font>
<a name="line-18"></a>  <font color=Blue><i>-- * The ReadWrite monad</i></font>
<a name="line-19"></a>  ReadWrite<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-20"></a>  
<a name="line-21"></a>  <font color=Blue><i>-- * The Circ monad  </i></font>
<a name="line-22"></a>  Circ<font color=Cyan>,</font>
<a name="line-23"></a>
<a name="line-24"></a>  <font color=Blue><i>-- * Some types</i></font>
<a name="line-25"></a>  Qubit<font color=Cyan>,</font>
<a name="line-26"></a>  Bit<font color=Cyan>,</font>
<a name="line-27"></a>  Endpoint<font color=Cyan>,</font>
<a name="line-28"></a>  Signed<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Blue><i>-- re-exported from Quipper.Circuit</i></font>
<a name="line-29"></a>  Ctrl<font color=Cyan>,</font>
<a name="line-30"></a>  Qulist<font color=Cyan>,</font>
<a name="line-31"></a>  Bitlist<font color=Cyan>,</font>
<a name="line-32"></a>  Timestep<font color=Cyan>,</font>   <font color=Blue><i>-- re-exported from Quipper.Circuit</i></font>
<a name="line-33"></a>  InverseFlag<font color=Cyan>,</font> <font color=Blue><i>-- re-exported from Quipper.Circuit</i></font>
<a name="line-34"></a>  
<a name="line-35"></a>  <font color=Blue><i>-- * Conversions for wires, qubits, bits, endpoints</i></font>
<a name="line-36"></a>  wire_of_qubit<font color=Cyan>,</font>
<a name="line-37"></a>  wire_of_bit<font color=Cyan>,</font>
<a name="line-38"></a>  wire_of_endpoint<font color=Cyan>,</font>  
<a name="line-39"></a>  wires_with_arity_of_endpoints<font color=Cyan>,</font>
<a name="line-40"></a>  qubit_of_wire<font color=Cyan>,</font>
<a name="line-41"></a>  bit_of_wire<font color=Cyan>,</font>
<a name="line-42"></a>  endpoint_of_wire<font color=Cyan>,</font>
<a name="line-43"></a>  endpoints_of_wires_in_arity<font color=Cyan>,</font>
<a name="line-44"></a>
<a name="line-45"></a>  <font color=Blue><i>-- * Bindings for qubits and bits</i></font>
<a name="line-46"></a>  bind_qubit<font color=Cyan>,</font>
<a name="line-47"></a>  bind_bit<font color=Cyan>,</font>
<a name="line-48"></a>  unbind_qubit<font color=Cyan>,</font>
<a name="line-49"></a>  unbind_bit<font color=Cyan>,</font>
<a name="line-50"></a>  
<a name="line-51"></a>  <font color=Blue><i>-- * Controls for qubits and bits</i></font>
<a name="line-52"></a>  clist_add_qubit<font color=Cyan>,</font>
<a name="line-53"></a>  clist_add_bit<font color=Cyan>,</font>
<a name="line-54"></a>  
<a name="line-55"></a>  <font color=Blue><i>-- * Namespace management  </i></font>
<a name="line-56"></a>  provide_simple_subroutine<font color=Cyan>,</font>
<a name="line-57"></a>  provide_subroutine<font color=Cyan>,</font>
<a name="line-58"></a>  provide_subroutines<font color=Cyan>,</font>
<a name="line-59"></a>  call_subroutine<font color=Cyan>,</font>
<a name="line-60"></a>  get_namespace<font color=Cyan>,</font>
<a name="line-61"></a>  set_namespace<font color=Cyan>,</font>
<a name="line-62"></a>
<a name="line-63"></a>  put_subroutine_definition<font color=Cyan>,</font>
<a name="line-64"></a>  
<a name="line-65"></a>  <font color=Blue><i>-- * Basic gates</i></font>
<a name="line-66"></a>  <font color=Blue><i>-- ** Gates in functional style</i></font>
<a name="line-67"></a>  qnot<font color=Cyan>,</font>
<a name="line-68"></a>  hadamard<font color=Cyan>,</font>
<a name="line-69"></a>  gate_H<font color=Cyan>,</font>
<a name="line-70"></a>  gate_X<font color=Cyan>,</font>
<a name="line-71"></a>  gate_Y<font color=Cyan>,</font>
<a name="line-72"></a>  gate_Z<font color=Cyan>,</font>
<a name="line-73"></a>  gate_S<font color=Cyan>,</font>  
<a name="line-74"></a>  gate_S_inv<font color=Cyan>,</font>
<a name="line-75"></a>  gate_T<font color=Cyan>,</font>
<a name="line-76"></a>  gate_T_inv<font color=Cyan>,</font>
<a name="line-77"></a>  gate_E<font color=Cyan>,</font>
<a name="line-78"></a>  gate_E_inv<font color=Cyan>,</font>
<a name="line-79"></a>  gate_omega<font color=Cyan>,</font>
<a name="line-80"></a>  gate_V<font color=Cyan>,</font>
<a name="line-81"></a>  gate_V_inv<font color=Cyan>,</font>
<a name="line-82"></a>  swap_qubit<font color=Cyan>,</font>
<a name="line-83"></a>  expZt<font color=Cyan>,</font>
<a name="line-84"></a>  rGate<font color=Cyan>,</font>
<a name="line-85"></a>  gate_W<font color=Cyan>,</font>
<a name="line-86"></a>  gate_iX<font color=Cyan>,</font>
<a name="line-87"></a>  gate_iX_inv<font color=Cyan>,</font>
<a name="line-88"></a>  global_phase<font color=Cyan>,</font>
<a name="line-89"></a>  global_phase_anchored_list<font color=Cyan>,</font>
<a name="line-90"></a>  qmultinot_list<font color=Cyan>,</font>
<a name="line-91"></a>  cmultinot_list<font color=Cyan>,</font>
<a name="line-92"></a>  named_gate_qulist<font color=Cyan>,</font>
<a name="line-93"></a>  named_rotation_qulist<font color=Cyan>,</font>
<a name="line-94"></a>  cnot<font color=Cyan>,</font>
<a name="line-95"></a>  swap_bit<font color=Cyan>,</font>
<a name="line-96"></a>  <font color=Blue><i>-- ** Gates in imperative style</i></font>
<a name="line-97"></a>  qnot_at<font color=Cyan>,</font>
<a name="line-98"></a>  hadamard_at<font color=Cyan>,</font>
<a name="line-99"></a>  gate_H_at<font color=Cyan>,</font>
<a name="line-100"></a>  gate_X_at<font color=Cyan>,</font>
<a name="line-101"></a>  gate_Y_at<font color=Cyan>,</font>
<a name="line-102"></a>  gate_Z_at<font color=Cyan>,</font>
<a name="line-103"></a>  gate_S_at<font color=Cyan>,</font>
<a name="line-104"></a>  gate_S_inv_at<font color=Cyan>,</font>
<a name="line-105"></a>  gate_T_at<font color=Cyan>,</font>
<a name="line-106"></a>  gate_T_inv_at<font color=Cyan>,</font>
<a name="line-107"></a>  gate_E_at<font color=Cyan>,</font>
<a name="line-108"></a>  gate_E_inv_at<font color=Cyan>,</font>
<a name="line-109"></a>  gate_omega_at<font color=Cyan>,</font>
<a name="line-110"></a>  gate_V_at<font color=Cyan>,</font>
<a name="line-111"></a>  gate_V_inv_at<font color=Cyan>,</font>
<a name="line-112"></a>  swap_qubit_at<font color=Cyan>,</font>
<a name="line-113"></a>  expZt_at<font color=Cyan>,</font>
<a name="line-114"></a>  rGate_at<font color=Cyan>,</font>
<a name="line-115"></a>  gate_W_at<font color=Cyan>,</font>
<a name="line-116"></a>  gate_iX_at<font color=Cyan>,</font>
<a name="line-117"></a>  gate_iX_inv_at<font color=Cyan>,</font>
<a name="line-118"></a>  qmultinot_list_at<font color=Cyan>,</font>
<a name="line-119"></a>  cmultinot_list_at<font color=Cyan>,</font>
<a name="line-120"></a>  named_gate_qulist_at<font color=Cyan>,</font>
<a name="line-121"></a>  named_rotation_qulist_at<font color=Cyan>,</font>
<a name="line-122"></a>  cnot_at<font color=Cyan>,</font>
<a name="line-123"></a>  swap_bit_at<font color=Cyan>,</font>
<a name="line-124"></a>  <font color=Blue><i>-- ** Bitwise initialization and termination functions</i></font>
<a name="line-125"></a>  qinit_qubit<font color=Cyan>,</font>
<a name="line-126"></a>  qterm_qubit<font color=Cyan>,</font>
<a name="line-127"></a>  qdiscard_qubit<font color=Cyan>,</font>
<a name="line-128"></a>  prepare_qubit<font color=Cyan>,</font>
<a name="line-129"></a>  unprepare_qubit<font color=Cyan>,</font>
<a name="line-130"></a>  measure_qubit<font color=Cyan>,</font>
<a name="line-131"></a>  cinit_bit<font color=Cyan>,</font>
<a name="line-132"></a>  cterm_bit<font color=Cyan>,</font>
<a name="line-133"></a>  cdiscard_bit<font color=Cyan>,</font>
<a name="line-134"></a>  dterm_bit<font color=Cyan>,</font>
<a name="line-135"></a>  
<a name="line-136"></a>  <font color=Blue><i>-- ** Classical gates</i></font>
<a name="line-137"></a>  <font color=Blue><i>-- $CLASSICAL</i></font>
<a name="line-138"></a>  cgate_xor<font color=Cyan>,</font>
<a name="line-139"></a>  cgate_eq<font color=Cyan>,</font>
<a name="line-140"></a>  cgate_if_bit<font color=Cyan>,</font>
<a name="line-141"></a>  cgate_not<font color=Cyan>,</font>
<a name="line-142"></a>  cgate_and<font color=Cyan>,</font>
<a name="line-143"></a>  cgate_or<font color=Cyan>,</font>
<a name="line-144"></a>  cgate<font color=Cyan>,</font>
<a name="line-145"></a>  cgateinv<font color=Cyan>,</font>
<a name="line-146"></a>  
<a name="line-147"></a>  <font color=Blue><i>-- ** Subroutines</i></font>
<a name="line-148"></a>  subroutine<font color=Cyan>,</font>
<a name="line-149"></a>  
<a name="line-150"></a>  <font color=Blue><i>-- ** Comments</i></font>
<a name="line-151"></a>  comment_label<font color=Cyan>,</font>
<a name="line-152"></a>  without_comments<font color=Cyan>,</font>
<a name="line-153"></a>  
<a name="line-154"></a>  <font color=Blue><i>-- ** Dynamic lifting</i></font>
<a name="line-155"></a>  dynamic_lift_bit<font color=Cyan>,</font>
<a name="line-156"></a>  
<a name="line-157"></a>  <font color=Blue><i>-- * Other circuit-building functions</i></font>
<a name="line-158"></a>  qinit_plusminus<font color=Cyan>,</font>
<a name="line-159"></a>  qinit_of_char<font color=Cyan>,</font>
<a name="line-160"></a>  qinit_of_string<font color=Cyan>,</font>
<a name="line-161"></a>  qinit_list<font color=Cyan>,</font>
<a name="line-162"></a>  qterm_list<font color=Cyan>,</font>
<a name="line-163"></a>  cinit_list<font color=Cyan>,</font>
<a name="line-164"></a>  
<a name="line-165"></a>  <font color=Blue><i>-- * Higher-order functions</i></font>
<a name="line-166"></a>  with_ancilla<font color=Cyan>,</font>
<a name="line-167"></a>  with_controls<font color=Cyan>,</font>
<a name="line-168"></a>  controlled<font color=Cyan>,</font>
<a name="line-169"></a>  without_controls<font color=Cyan>,</font>
<a name="line-170"></a>  without_controls_if<font color=Cyan>,</font>
<a name="line-171"></a>  
<a name="line-172"></a>  <font color=Blue><i>-- ** Deprecated special cases</i></font>
<a name="line-173"></a>  qinit_qubit_ancilla<font color=Cyan>,</font>
<a name="line-174"></a>  qterm_qubit_ancilla<font color=Cyan>,</font>
<a name="line-175"></a>  
<a name="line-176"></a>  <font color=Blue><i>-- * Circuit transformers</i></font>
<a name="line-177"></a>  identity_transformer<font color=Cyan>,</font>
<a name="line-178"></a>  identity_dynamic_transformer<font color=Cyan>,</font>
<a name="line-179"></a>  apply_circuit_with_bindings<font color=Cyan>,</font>
<a name="line-180"></a>  apply_bcircuit_with_bindings<font color=Cyan>,</font>
<a name="line-181"></a>  apply_dbcircuit_with_bindings<font color=Cyan>,</font>
<a name="line-182"></a>  
<a name="line-183"></a>  <font color=Blue><i>-- * Encapsulated circuits</i></font>
<a name="line-184"></a>  extract_simple<font color=Cyan>,</font>
<a name="line-185"></a>  extract_general<font color=Cyan>,</font>
<a name="line-186"></a>  extract_in_context<font color=Cyan>,</font>
<a name="line-187"></a>  extract_in_current_namespace<font color=Cyan>,</font>
<a name="line-188"></a>  unextract_in_context<font color=Cyan>,</font>
<a name="line-189"></a>  reverse_encapsulated<font color=Cyan>,</font>
<a name="line-190"></a>  with_reserve
<a name="line-191"></a><font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-192"></a>
<a name="line-193"></a><font color=Blue><i>-- import other Quipper stuff</i></font>
<a name="line-194"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Circuit
<a name="line-195"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary
<a name="line-196"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Transformer
<a name="line-197"></a><font color=Green><u>import</u></font> Quipper<font color=Cyan>.</font>Control
<a name="line-198"></a>
<a name="line-199"></a><font color=Blue><i>-- import other stuff</i></font>
<a name="line-200"></a><font color=Green><u>import</u></font> Control<font color=Cyan>.</font>Monad
<a name="line-201"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Typeable
<a name="line-202"></a>
<a name="line-203"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Map <font color=Cyan>(</font>Map<font color=Cyan>)</font>
<a name="line-204"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Map <font color=Green><u>as</u></font> Map
<a name="line-205"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>IntMap <font color=Green><u>as</u></font> IntMap
<a name="line-206"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>IntSet <font color=Cyan>(</font>IntSet<font color=Cyan>)</font>
<a name="line-207"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>IntSet <font color=Green><u>as</u></font> IntSet
<a name="line-208"></a>
<a name="line-209"></a><font color=Green><u>import</u></font> Control<font color=Cyan>.</font>Applicative <font color=Cyan>(</font>Applicative<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-210"></a><font color=Green><u>import</u></font> Control<font color=Cyan>.</font>Monad <font color=Cyan>(</font>liftM<font color=Cyan>,</font> ap<font color=Cyan>)</font>
<a name="line-211"></a>
<a name="line-212"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-213"></a><font color=Blue><i>-- * The Circ monad</i></font>
<a name="line-214"></a>
<a name="line-215"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-216"></a><font color=Blue><i>-- ** States</i></font>
<a name="line-217"></a>
<a name="line-218"></a><a name="NoCommentFlag"></a><font color=Blue><i>-- | A flag to indicate whether comments are disabled ('True') or</i></font>
<a name="line-219"></a><a name="NoCommentFlag"></a><font color=Blue><i>-- enabled ('False').</i></font>
<a name="line-220"></a><a name="NoCommentFlag"></a><font color=Green><u>type</u></font> NoCommentFlag <font color=Red>=</font> Bool
<a name="line-221"></a>
<a name="line-222"></a><a name="State"></a><font color=Blue><i>-- | Holds the state during circuit construction. Currently this has</i></font>
<a name="line-223"></a><a name="State"></a><font color=Blue><i>-- four components: the output arity of the circuit currently being</i></font>
<a name="line-224"></a><a name="State"></a><font color=Blue><i>-- assembled, the current 'Namespace', the currently active</i></font>
<a name="line-225"></a><a name="State"></a><font color=Blue><i>-- 'ControlList' and 'NoControlFlag', and a flag to determine whether</i></font>
<a name="line-226"></a><a name="State"></a><font color=Blue><i>-- comments are disabled. All gates that are appended will have the</i></font>
<a name="line-227"></a><a name="State"></a><font color=Blue><i>-- controls from the 'ControlList' added to them.</i></font>
<a name="line-228"></a><a name="State"></a><font color=Green><u>data</u></font> State <font color=Red>=</font> State <font color=Cyan>{</font>
<a name="line-229"></a>  arity <font color=Red>::</font> <font color=Cyan>!</font>ExtArity<font color=Cyan>,</font>
<a name="line-230"></a>  namespace <font color=Red>::</font> <font color=Cyan>!</font>Namespace<font color=Cyan>,</font>
<a name="line-231"></a>  clist <font color=Red>::</font> <font color=Cyan>!</font>ControlList<font color=Cyan>,</font>
<a name="line-232"></a>  ncflag <font color=Red>::</font> <font color=Cyan>!</font>NoControlFlag<font color=Cyan>,</font>
<a name="line-233"></a>  nocommentflag <font color=Red>::</font> <font color=Cyan>!</font>NoCommentFlag
<a name="line-234"></a><font color=Cyan>}</font>
<a name="line-235"></a>
<a name="line-236"></a><a name="empty_state"></a><font color=Blue><i>-- | Return a completely empty state, suitable to be the starting</i></font>
<a name="line-237"></a><font color=Blue><i>-- state for circuit construction.</i></font>
<a name="line-238"></a><font color=Blue>empty_state</font> <font color=Red>::</font> State
<a name="line-239"></a><font color=Blue>empty_state</font> <font color=Red>=</font> State <font color=Cyan>{</font> 
<a name="line-240"></a>  arity <font color=Red>=</font> arity_empty<font color=Cyan>,</font> 
<a name="line-241"></a>  namespace <font color=Red>=</font> namespace_empty<font color=Cyan>,</font>
<a name="line-242"></a>  clist <font color=Red>=</font> clist_empty<font color=Cyan>,</font>
<a name="line-243"></a>  ncflag <font color=Red>=</font> False<font color=Cyan>,</font>
<a name="line-244"></a>  nocommentflag <font color=Red>=</font> False
<a name="line-245"></a>  <font color=Cyan>}</font>
<a name="line-246"></a>
<a name="line-247"></a><a name="initial_state"></a><font color=Blue><i>-- | Prepare an initial state from the given extended arity.</i></font>
<a name="line-248"></a><font color=Blue>initial_state</font> <font color=Red>::</font> ExtArity <font color=Red>-&gt;</font> State
<a name="line-249"></a><font color=Blue>initial_state</font> arity <font color=Red>=</font> empty_state <font color=Cyan>{</font> arity <font color=Red>=</font> arity <font color=Cyan>}</font>
<a name="line-250"></a>
<a name="line-251"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-252"></a><font color=Blue><i>-- ** Definition of Circ</i></font>
<a name="line-253"></a>
<a name="line-254"></a><font color=Blue><i>-- $ The 'Circ' monad is a 'ReadWrite' monad, wrapped with an</i></font>
<a name="line-255"></a><font color=Blue><i>-- additional state.</i></font>
<a name="line-256"></a>
<a name="line-257"></a><font color=Blue><i>-- | The 'Circ' monad encapsulates the type of quantum operations. For</i></font>
<a name="line-258"></a><font color=Blue><i>-- example, a quantum operation that inputs two 'Qubit's and outputs a</i></font>
<a name="line-259"></a><font color=Blue><i>-- 'Qubit' and a 'Bit' has the following type:</i></font>
<a name="line-260"></a><font color=Blue><i>-- </i></font>
<a name="line-261"></a><font color=Blue><i>-- &gt; (Qubit, Qubit) -&gt; Circ (Qubit, Bit)</i></font>
<a name="line-262"></a>
<a name="line-263"></a><font color=Blue><i>-- Implementation note: we could have equivalently defined 'Circ'</i></font>
<a name="line-264"></a><font color=Blue><i>-- using Haskell's 'StateT' monad transformer, like this:</i></font>
<a name="line-265"></a><font color=Blue><i>-- </i></font>
<a name="line-266"></a><font color=Blue><i>-- &gt; Circ = StateT State ReadWrite. </i></font>
<a name="line-267"></a><font color=Blue><i>-- </i></font>
<a name="line-268"></a><font color=Blue><i>-- But it seems clearer, and certainly more self-contained, to write</i></font>
<a name="line-269"></a><font color=Blue><i>-- out the monad laws explicitly. Moreover, 'Circ' will probably look</i></font>
<a name="line-270"></a><font color=Blue><i>-- better in error messages than 'StateT' 'State' 'ReadWrite'.</i></font>
<a name="line-271"></a>
<a name="line-272"></a><a name="Circ"></a><font color=Green><u>newtype</u></font> Circ a <font color=Red>=</font> Circ <font color=Cyan>{</font> getCirc <font color=Red>::</font> State <font color=Red>-&gt;</font> ReadWrite <font color=Cyan>(</font>a<font color=Cyan>,</font> State<font color=Cyan>)</font> <font color=Cyan>}</font>
<a name="line-273"></a>
<a name="line-274"></a><font color=Green><u>instance</u></font> Monad Circ <font color=Green><u>where</u></font>
<a name="line-275"></a>  return a <font color=Red>=</font> Circ <font color=Cyan>(</font><font color=Red>\</font>s <font color=Red>-&gt;</font> return <font color=Cyan>(</font>a<font color=Cyan>,</font> s<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-276"></a>  f <font color=Cyan>&gt;&gt;=</font> g <font color=Red>=</font> Circ h
<a name="line-277"></a>    <font color=Green><u>where</u></font>
<a name="line-278"></a>      h s0 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-279"></a>        <font color=Cyan>(</font>a<font color=Cyan>,</font> s1<font color=Cyan>)</font> <font color=Red>&lt;-</font> getCirc f s0
<a name="line-280"></a>        getCirc <font color=Cyan>(</font>g a<font color=Cyan>)</font> s1
<a name="line-281"></a>
<a name="line-282"></a><font color=Blue><i>-- every monad is applicative, and so is this one</i></font>
<a name="line-283"></a><font color=Green><u>instance</u></font> Applicative Circ <font color=Green><u>where</u></font>
<a name="line-284"></a>  pure <font color=Red>=</font> return
<a name="line-285"></a>  <font color=Cyan>(</font><font color=Cyan>&lt;*&gt;</font><font color=Cyan>)</font> <font color=Red>=</font> ap
<a name="line-286"></a>
<a name="line-287"></a><font color=Blue><i>-- every monad is a functor, and so is this one</i></font>
<a name="line-288"></a><font color=Green><u>instance</u></font> Functor Circ <font color=Green><u>where</u></font>
<a name="line-289"></a>  fmap <font color=Red>=</font> liftM
<a name="line-290"></a>
<a name="line-291"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-292"></a><font color=Blue><i>-- ** Monad access primitives</i></font>
<a name="line-293"></a>  
<a name="line-294"></a><font color=Blue><i>-- $ Developer note: the 5 functions in this section are the /only/</i></font>
<a name="line-295"></a><font color=Blue><i>-- operations that are permitted to access the monad internals (i.e.,</i></font>
<a name="line-296"></a><font color=Blue><i>-- 'Circ' and 'getCirc') directly.</i></font>
<a name="line-297"></a>
<a name="line-298"></a><a name="get_state"></a><font color=Blue><i>-- | Get the 'Circ' monad's state.</i></font>
<a name="line-299"></a><font color=Blue>get_state</font> <font color=Red>::</font> Circ State
<a name="line-300"></a><font color=Blue>get_state</font> <font color=Red>=</font> Circ <font color=Cyan>$</font> <font color=Red>\</font>s <font color=Red>-&gt;</font> return <font color=Cyan>(</font>s<font color=Cyan>,</font> s<font color=Cyan>)</font>
<a name="line-301"></a>
<a name="line-302"></a><a name="set_state"></a><font color=Blue><i>-- | Set the 'Circ' monad's state.</i></font>
<a name="line-303"></a><font color=Blue>set_state</font> <font color=Red>::</font> State <font color=Red>-&gt;</font> Circ ()
<a name="line-304"></a><font color=Blue>set_state</font> s <font color=Red>=</font> Circ <font color=Cyan>$</font> <font color=Red>\</font>t <font color=Red>-&gt;</font> return <font color=Cyan>(</font>()<font color=Cyan>,</font> s<font color=Cyan>)</font>
<a name="line-305"></a>
<a name="line-306"></a><a name="put_gate"></a><font color=Blue><i>-- | Pass a gate to the 'Circ' monad. Note that this is a low-level</i></font>
<a name="line-307"></a><font color=Blue><i>-- monad access function, and does not update other parts of the</i></font>
<a name="line-308"></a><font color=Blue><i>-- monad's data. For a higher-level function, see 'apply_gate'.</i></font>
<a name="line-309"></a><font color=Blue>put_gate</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> Circ ()
<a name="line-310"></a><font color=Blue>put_gate</font> g <font color=Red>=</font> Circ <font color=Cyan>$</font> <font color=Red>\</font>s <font color=Red>-&gt;</font> RW_Write g <font color=Cyan>(</font>return <font color=Cyan>(</font>()<font color=Cyan>,</font> s<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-311"></a>
<a name="line-312"></a><a name="do_read"></a><font color=Blue><i>-- | Issue a prompt and receive a reply.</i></font>
<a name="line-313"></a><font color=Blue>do_read</font> <font color=Red>::</font> Wire <font color=Red>-&gt;</font> Circ Bool
<a name="line-314"></a><font color=Blue>do_read</font> w <font color=Red>=</font> Circ <font color=Cyan>$</font> <font color=Red>\</font>s <font color=Red>-&gt;</font> RW_Read w <font color=Cyan>(</font><font color=Red>\</font>bool <font color=Red>-&gt;</font> return <font color=Cyan>(</font>bool<font color=Cyan>,</font> s<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-315"></a>
<a name="line-316"></a><a name="put_subroutine_definition"></a><font color=Blue><i>-- | Issue a RW_Subroutine primitive</i></font>
<a name="line-317"></a><font color=Blue>put_subroutine_definition</font> <font color=Red>::</font> BoxId <font color=Red>-&gt;</font> TypedSubroutine <font color=Red>-&gt;</font> Circ ()
<a name="line-318"></a><font color=Blue>put_subroutine_definition</font> name subroutine <font color=Red>=</font> Circ <font color=Cyan>$</font> <font color=Red>\</font>s <font color=Red>-&gt;</font> RW_Subroutine name subroutine <font color=Cyan>(</font>return <font color=Cyan>(</font>()<font color=Cyan>,</font> s<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-319"></a>
<a name="line-320"></a><a name="run_circ"></a><font color=Blue><i>-- | This is the universal \"run\" function for the 'Circ' monad.  It</i></font>
<a name="line-321"></a><font color=Blue><i>-- takes as parameters a 'Circ' computation, and an initial state. It</i></font>
<a name="line-322"></a><font color=Blue><i>-- outputs 'ReadWrite' computation for the result of the 'Circ'</i></font>
<a name="line-323"></a><font color=Blue><i>-- computation and the final state.</i></font>
<a name="line-324"></a><font color=Blue>run_circ</font> <font color=Red>::</font> Circ a <font color=Red>-&gt;</font> State <font color=Red>-&gt;</font> ReadWrite <font color=Cyan>(</font>a<font color=Cyan>,</font> State<font color=Cyan>)</font>
<a name="line-325"></a><font color=Blue>run_circ</font> <font color=Red>=</font> getCirc
<a name="line-326"></a>
<a name="line-327"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-328"></a><font color=Blue><i>-- ** Low-level state manipulation</i></font>
<a name="line-329"></a>  
<a name="line-330"></a><font color=Blue><i>-- $ The functions in this section are the /only/ operations that are</i></font>
<a name="line-331"></a><font color=Blue><i>-- permitted to operate on states directly (i.e., to use 'get_state'</i></font>
<a name="line-332"></a><font color=Blue><i>-- and 'set_state'). All other code in this module should access the</i></font>
<a name="line-333"></a><font color=Blue><i>-- state using these abstractions. Code in other modules can't access</i></font>
<a name="line-334"></a><font color=Blue><i>-- the state at all, but should use exported functions (and preferably</i></font>
<a name="line-335"></a><font color=Blue><i>-- 'QShape.encapsulate_generic') when it is necessary to extract</i></font>
<a name="line-336"></a><font color=Blue><i>-- low-level circuits.</i></font>
<a name="line-337"></a>
<a name="line-338"></a><a name="get_arity"></a><font color=Blue><i>-- | Get the 'arity' part of the 'Circ' monad's state.</i></font>
<a name="line-339"></a><font color=Blue>get_arity</font> <font color=Red>::</font> Circ ExtArity
<a name="line-340"></a><font color=Blue>get_arity</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-341"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-342"></a>  return <font color=Cyan>(</font>arity s<font color=Cyan>)</font>
<a name="line-343"></a>
<a name="line-344"></a><a name="set_arity"></a><font color=Blue><i>-- | Set the 'arity' part of the 'Circ' monad's state.</i></font>
<a name="line-345"></a><font color=Blue>set_arity</font> <font color=Red>::</font> ExtArity <font color=Red>-&gt;</font> Circ ()
<a name="line-346"></a><font color=Blue>set_arity</font> arity <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-347"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-348"></a>  set_state s <font color=Cyan>{</font> arity <font color=Red>=</font> arity <font color=Cyan>}</font>
<a name="line-349"></a>  
<a name="line-350"></a><a name="get_namespace"></a><font color=Blue><i>-- | Get the 'namespace' part of the 'Circ' monad's state.</i></font>
<a name="line-351"></a><font color=Blue>get_namespace</font> <font color=Red>::</font> Circ Namespace
<a name="line-352"></a><font color=Blue>get_namespace</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-353"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-354"></a>  return <font color=Cyan>(</font>namespace s<font color=Cyan>)</font>
<a name="line-355"></a>  
<a name="line-356"></a><a name="set_namespace"></a><font color=Blue><i>-- | Set the 'namespace' part of the 'Circ' monad's state.</i></font>
<a name="line-357"></a><font color=Blue>set_namespace</font> <font color=Red>::</font> Namespace <font color=Red>-&gt;</font> Circ ()
<a name="line-358"></a><font color=Blue>set_namespace</font> namespace <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-359"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-360"></a>  set_state s <font color=Cyan>{</font> namespace <font color=Red>=</font> namespace <font color=Cyan>}</font>
<a name="line-361"></a>  
<a name="line-362"></a><a name="get_clist"></a><font color=Blue><i>-- | Get the 'clist' part of the 'Circ' monad's state.</i></font>
<a name="line-363"></a><font color=Blue>get_clist</font> <font color=Red>::</font> Circ ControlList
<a name="line-364"></a><font color=Blue>get_clist</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-365"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-366"></a>  return <font color=Cyan>(</font>clist s<font color=Cyan>)</font>
<a name="line-367"></a>  
<a name="line-368"></a><a name="set_clist"></a><font color=Blue><i>-- | Set the 'clist' part of the 'Circ' monad's state.</i></font>
<a name="line-369"></a><font color=Blue>set_clist</font> <font color=Red>::</font> ControlList <font color=Red>-&gt;</font> Circ ()
<a name="line-370"></a><font color=Blue>set_clist</font> clist <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-371"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-372"></a>  set_state s <font color=Cyan>{</font> clist <font color=Red>=</font> clist <font color=Cyan>}</font>
<a name="line-373"></a>
<a name="line-374"></a><a name="get_ncflag"></a><font color=Blue><i>-- | Get the 'ncflag' part of the 'Circ' monad's state.</i></font>
<a name="line-375"></a><font color=Blue>get_ncflag</font> <font color=Red>::</font> Circ NoControlFlag
<a name="line-376"></a><font color=Blue>get_ncflag</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-377"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-378"></a>  return <font color=Cyan>(</font>ncflag s<font color=Cyan>)</font>
<a name="line-379"></a>  
<a name="line-380"></a><a name="set_ncflag"></a><font color=Blue><i>-- | Set the 'ncflag' part of the 'Circ' monad's state.</i></font>
<a name="line-381"></a><font color=Blue>set_ncflag</font> <font color=Red>::</font> NoControlFlag <font color=Red>-&gt;</font> Circ ()
<a name="line-382"></a><font color=Blue>set_ncflag</font> ncflag <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-383"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-384"></a>  set_state s <font color=Cyan>{</font> ncflag <font color=Red>=</font> ncflag <font color=Cyan>}</font>
<a name="line-385"></a>
<a name="line-386"></a><a name="get_nocommentflag"></a><font color=Blue><i>-- | Get the 'nocommentflag' part of the 'Circ' monad's state.</i></font>
<a name="line-387"></a><font color=Blue>get_nocommentflag</font> <font color=Red>::</font> Circ NoCommentFlag
<a name="line-388"></a><font color=Blue>get_nocommentflag</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-389"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-390"></a>  return <font color=Cyan>(</font>nocommentflag s<font color=Cyan>)</font>
<a name="line-391"></a>  
<a name="line-392"></a><a name="set_nocommentflag"></a><font color=Blue><i>-- | Set the 'nocommentflag' part of the 'Circ' monad's state.</i></font>
<a name="line-393"></a><font color=Blue>set_nocommentflag</font> <font color=Red>::</font> NoCommentFlag <font color=Red>-&gt;</font> Circ ()
<a name="line-394"></a><font color=Blue>set_nocommentflag</font> nocommentflag <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-395"></a>  s <font color=Red>&lt;-</font> get_state
<a name="line-396"></a>  set_state s <font color=Cyan>{</font> nocommentflag <font color=Red>=</font> nocommentflag <font color=Cyan>}</font>
<a name="line-397"></a>
<a name="line-398"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-399"></a><font color=Blue><i>-- ** Circuit extraction</i></font>
<a name="line-400"></a>
<a name="line-401"></a><a name="extract_simple"></a><font color=Blue><i>-- | Extract a circuit from a monadic term, starting from the given</i></font>
<a name="line-402"></a><font color=Blue><i>-- arity. This is the \"simple\" extract function, which does not</i></font>
<a name="line-403"></a><font color=Blue><i>-- allow dynamic lifting. The 'ErrMsg' argument is a stub error message</i></font>
<a name="line-404"></a><font color=Blue><i>-- to be used in case an illegal operation is encountered. </i></font>
<a name="line-405"></a><font color=Blue>extract_simple</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> ExtArity <font color=Red>-&gt;</font> Circ a <font color=Red>-&gt;</font> <font color=Cyan>(</font>BCircuit<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-406"></a><font color=Blue>extract_simple</font> e arity f <font color=Red>=</font> <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> y<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-407"></a>  comp <font color=Red>=</font> extract_general arity f
<a name="line-408"></a>  <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> y<font color=Cyan>)</font> <font color=Red>=</font> bcircuit_of_static_dbcircuit e comp
<a name="line-409"></a>
<a name="line-410"></a>
<a name="line-411"></a><a name="extract_general"></a><font color=Blue><i>-- | Run a monadic term in the initial arity, and extract a dynamic</i></font>
<a name="line-412"></a><font color=Blue><i>-- boxed circuit.</i></font>
<a name="line-413"></a><font color=Blue>extract_general</font> <font color=Red>::</font> ExtArity <font color=Red>-&gt;</font> Circ a <font color=Red>-&gt;</font> DBCircuit a
<a name="line-414"></a><font color=Blue>extract_general</font> arity_in f <font color=Red>=</font> <font color=Cyan>(</font>a0<font color=Cyan>,</font> mmap finalize comp<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-415"></a>  a0 <font color=Red>=</font> arity_of_extarity arity_in
<a name="line-416"></a>  s0 <font color=Red>=</font> initial_state arity_in
<a name="line-417"></a>  comp <font color=Red>=</font> run_circ f s0
<a name="line-418"></a>  finalize <font color=Cyan>(</font>a<font color=Cyan>,</font> s1<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>a1<font color=Cyan>,</font> n<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-419"></a>    arity_out <font color=Red>=</font> arity s1
<a name="line-420"></a>    a1 <font color=Red>=</font> arity_of_extarity arity_out
<a name="line-421"></a>    n <font color=Red>=</font> n_of_extarity arity_out    
<a name="line-422"></a>
<a name="line-423"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-424"></a><font color=Blue><i>-- * Some types</i></font>
<a name="line-425"></a>
<a name="line-426"></a><a name="Qubit"></a><font color=Blue><i>-- | The type of qubits.</i></font>
<a name="line-427"></a><a name="Qubit"></a><font color=Green><u>newtype</u></font> Qubit <font color=Red>=</font> QubitWire Wire
<a name="line-428"></a>              <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>,</font> Eq<font color=Cyan>,</font> Ord<font color=Cyan>,</font> Typeable<font color=Cyan>)</font>
<a name="line-429"></a>
<a name="line-430"></a><a name="Bit"></a><font color=Blue><i>-- | The type of run-time classical bits (i.e., boolean wires in a</i></font>
<a name="line-431"></a><a name="Bit"></a><font color=Blue><i>-- circuit).</i></font>
<a name="line-432"></a><a name="Bit"></a><font color=Green><u>newtype</u></font> Bit <font color=Red>=</font> BitWire Wire
<a name="line-433"></a>              <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>,</font> Eq<font color=Cyan>,</font> Ord<font color=Cyan>,</font> Typeable<font color=Cyan>)</font>
<a name="line-434"></a>
<a name="line-435"></a><a name="Endpoint"></a><font color=Blue><i>-- | An endpoint in a circuit. This is either a 'Qubit' or a 'Bit'.</i></font>
<a name="line-436"></a><a name="Endpoint"></a><font color=Green><u>type</u></font> Endpoint <font color=Red>=</font> B_Endpoint Qubit Bit
<a name="line-437"></a>
<a name="line-438"></a><a name="Ctrl"></a><font color=Blue><i>-- | A control consists of an 'Endpoint' and a boolean ('True' =</i></font>
<a name="line-439"></a><a name="Ctrl"></a><font color=Blue><i>-- perform gate when control wire is 1; 'False' = perform gate when</i></font>
<a name="line-440"></a><a name="Ctrl"></a><font color=Blue><i>-- control wire is 0). Note that gates can be controlled by qubits and</i></font>
<a name="line-441"></a><a name="Ctrl"></a><font color=Blue><i>-- classical bits.</i></font>
<a name="line-442"></a><a name="Ctrl"></a><font color=Green><u>type</u></font> Ctrl <font color=Red>=</font> Signed Endpoint
<a name="line-443"></a>
<a name="line-444"></a><a name="Qulist"></a><font color=Blue><i>-- | Synonym for a qubit list, for convenience.</i></font>
<a name="line-445"></a><a name="Qulist"></a><font color=Green><u>type</u></font> Qulist <font color=Red>=</font> <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-446"></a>
<a name="line-447"></a><a name="Bitlist"></a><font color=Blue><i>-- | Synonym for a bit list, for convenience.</i></font>
<a name="line-448"></a><a name="Bitlist"></a><font color=Green><u>type</u></font> Bitlist <font color=Red>=</font> <font color=Red>[</font>Bit<font color=Red>]</font>
<a name="line-449"></a>
<a name="line-450"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-451"></a><font color=Blue><i>-- * Conversions for wires, qubits, bits, endpoints</i></font>
<a name="line-452"></a>
<a name="line-453"></a><a name="wire_of_qubit"></a><font color=Blue><i>-- | Extract the underlying low-level wire of a qubit.</i></font>
<a name="line-454"></a><font color=Blue>wire_of_qubit</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Wire
<a name="line-455"></a><font color=Blue>wire_of_qubit</font> <font color=Cyan>(</font>QubitWire w<font color=Cyan>)</font> <font color=Red>=</font> w
<a name="line-456"></a>
<a name="line-457"></a><a name="wire_of_bit"></a><font color=Blue><i>-- | Extract the underlying low-level wire of a bit.</i></font>
<a name="line-458"></a><font color=Blue>wire_of_bit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Wire
<a name="line-459"></a><font color=Blue>wire_of_bit</font> <font color=Cyan>(</font>BitWire w<font color=Cyan>)</font> <font color=Red>=</font> w
<a name="line-460"></a>
<a name="line-461"></a><a name="qubit_of_wire"></a><font color=Blue><i>-- | Construct a qubit from a wire.</i></font>
<a name="line-462"></a><font color=Blue>qubit_of_wire</font> <font color=Red>::</font> Wire <font color=Red>-&gt;</font> Qubit
<a name="line-463"></a><font color=Blue>qubit_of_wire</font> w <font color=Red>=</font> QubitWire w
<a name="line-464"></a>
<a name="line-465"></a><a name="bit_of_wire"></a><font color=Blue><i>-- | Construct a bit from a wire.</i></font>
<a name="line-466"></a><font color=Blue>bit_of_wire</font> <font color=Red>::</font> Wire <font color=Red>-&gt;</font> Bit
<a name="line-467"></a><font color=Blue>bit_of_wire</font> w <font color=Red>=</font> BitWire w
<a name="line-468"></a>
<a name="line-469"></a><a name="wire_of_endpoint"></a><font color=Blue><i>-- | Extract the underlying low-level 'Wire' of an 'Endpoint'.</i></font>
<a name="line-470"></a><font color=Blue>wire_of_endpoint</font> <font color=Red>::</font> Endpoint <font color=Red>-&gt;</font> Wire
<a name="line-471"></a><font color=Blue>wire_of_endpoint</font> <font color=Cyan>(</font>Endpoint_Qubit q<font color=Cyan>)</font> <font color=Red>=</font> wire_of_qubit q
<a name="line-472"></a><font color=Blue>wire_of_endpoint</font> <font color=Cyan>(</font>Endpoint_Bit b<font color=Cyan>)</font> <font color=Red>=</font> wire_of_bit b
<a name="line-473"></a>
<a name="line-474"></a><a name="wiretype_of_endpoint"></a><font color=Blue><i>-- | Extract the underlying low-level 'Wiretype' of an 'Endpoint'.</i></font>
<a name="line-475"></a><font color=Blue>wiretype_of_endpoint</font> <font color=Red>::</font> Endpoint <font color=Red>-&gt;</font> Wiretype
<a name="line-476"></a><font color=Blue>wiretype_of_endpoint</font> <font color=Cyan>(</font>Endpoint_Qubit <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> Qbit
<a name="line-477"></a><font color=Blue>wiretype_of_endpoint</font> <font color=Cyan>(</font>Endpoint_Bit <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> Cbit
<a name="line-478"></a>
<a name="line-479"></a><a name="wires_with_arity_of_endpoints"></a><font color=Blue><i>-- | Break a list of 'Endpoint's down into a list of 'Wire's together with an 'Arity'.  </i></font>
<a name="line-480"></a><font color=Blue><i>-- (Partial inverse to 'endpoints_of_wires_in_arity'.)</i></font>
<a name="line-481"></a><font color=Blue>wires_with_arity_of_endpoints</font> <font color=Red>::</font> <font color=Red>[</font>Endpoint<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font>Wire<font color=Red>]</font><font color=Cyan>,</font>Arity<font color=Cyan>)</font>
<a name="line-482"></a><font color=Blue>wires_with_arity_of_endpoints</font> es <font color=Red>=</font> 
<a name="line-483"></a>  <font color=Green><u>let</u></font> ws_with_ts <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font>e <font color=Red>-&gt;</font> <font color=Cyan>(</font>wire_of_endpoint e<font color=Cyan>,</font> wiretype_of_endpoint e<font color=Cyan>)</font><font color=Cyan>)</font> es
<a name="line-484"></a>  <font color=Green><u>in</u></font> <font color=Cyan>(</font>map fst ws_with_ts<font color=Cyan>,</font> IntMap<font color=Cyan>.</font>fromList ws_with_ts<font color=Cyan>)</font>
<a name="line-485"></a>
<a name="line-486"></a><a name="endpoint_of_wire"></a><font color=Blue><i>-- | Create an 'Endpoint' from a low-level 'Wire' and 'Wiretype'.</i></font>
<a name="line-487"></a><font color=Blue>endpoint_of_wire</font> <font color=Red>::</font> Wire <font color=Red>-&gt;</font> Wiretype <font color=Red>-&gt;</font> Endpoint
<a name="line-488"></a><font color=Blue>endpoint_of_wire</font> w Qbit <font color=Red>=</font> Endpoint_Qubit <font color=Cyan>(</font>qubit_of_wire w<font color=Cyan>)</font>
<a name="line-489"></a><font color=Blue>endpoint_of_wire</font> w Cbit <font color=Red>=</font> Endpoint_Bit <font color=Cyan>(</font>bit_of_wire w<font color=Cyan>)</font>
<a name="line-490"></a>
<a name="line-491"></a><a name="endpoints_of_wires_in_arity"></a><font color=Blue><i>-- | Create a list of 'Endpoint's from a list of 'Wire's together with an 'Arity',</i></font>
<a name="line-492"></a><font color=Blue><i>-- assuming all wires are present in the arity.</i></font>
<a name="line-493"></a><font color=Blue>endpoints_of_wires_in_arity</font> <font color=Red>::</font> Arity <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Endpoint<font color=Red>]</font>
<a name="line-494"></a><font color=Blue>endpoints_of_wires_in_arity</font> a <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font>w <font color=Red>-&gt;</font> endpoint_of_wire w <font color=Cyan>(</font>a IntMap<font color=Cyan>.!</font> w<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-495"></a>
<a name="line-496"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-497"></a><font color=Blue><i>-- * Bindings for qubits and bits</i></font>
<a name="line-498"></a>
<a name="line-499"></a><a name="bind_qubit"></a><font color=Blue><i>-- | Bind a qubit wire to a value, and add it to the given bindings.</i></font>
<a name="line-500"></a><font color=Blue>bind_qubit</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> Bindings a b <font color=Red>-&gt;</font> Bindings a b
<a name="line-501"></a><font color=Blue>bind_qubit</font> q x bindings <font color=Red>=</font> bind_qubit_wire <font color=Cyan>(</font>wire_of_qubit q<font color=Cyan>)</font> x bindings
<a name="line-502"></a>
<a name="line-503"></a><a name="bind_bit"></a><font color=Blue><i>-- | Bind a bit wire to a value, and add it to the given bindings.</i></font>
<a name="line-504"></a><font color=Blue>bind_bit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> b <font color=Red>-&gt;</font> Bindings a b <font color=Red>-&gt;</font> Bindings a b
<a name="line-505"></a><font color=Blue>bind_bit</font> c x bindings <font color=Red>=</font> bind_bit_wire <font color=Cyan>(</font>wire_of_bit c<font color=Cyan>)</font> x bindings
<a name="line-506"></a>
<a name="line-507"></a><a name="unbind_qubit"></a><font color=Blue><i>-- | Retrieve the value of a qubit wire from the given bindings.</i></font>
<a name="line-508"></a><font color=Blue><i>-- Throws an error if the wire was bound to a classical bit.</i></font>
<a name="line-509"></a><font color=Blue>unbind_qubit</font> <font color=Red>::</font> Bindings a b <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> a
<a name="line-510"></a><font color=Blue>unbind_qubit</font> bindings q <font color=Red>=</font> unbind_qubit_wire bindings <font color=Cyan>(</font>wire_of_qubit q<font color=Cyan>)</font>
<a name="line-511"></a>
<a name="line-512"></a><a name="unbind_bit"></a><font color=Blue><i>-- | Retrieve the value of a bit wire from the given bindings.  Throws</i></font>
<a name="line-513"></a><font color=Blue><i>-- an error if the wire was bound to a qubit.</i></font>
<a name="line-514"></a><font color=Blue>unbind_bit</font> <font color=Red>::</font> Bindings a b <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> b
<a name="line-515"></a><font color=Blue>unbind_bit</font> bindings c <font color=Red>=</font> unbind_bit_wire bindings <font color=Cyan>(</font>wire_of_bit c<font color=Cyan>)</font>
<a name="line-516"></a>
<a name="line-517"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-518"></a><font color=Blue><i>-- * Controls for qubits and bits</i></font>
<a name="line-519"></a>
<a name="line-520"></a><a name="clist_add_qubit"></a><font color=Blue><i>-- | Add a single signed qubit as a control to a control list.</i></font>
<a name="line-521"></a><font color=Blue>clist_add_qubit</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> ControlList <font color=Red>-&gt;</font> ControlList
<a name="line-522"></a><font color=Blue>clist_add_qubit</font> q b cl <font color=Red>=</font> clist_add <font color=Cyan>(</font>wire_of_qubit q<font color=Cyan>)</font> b cl
<a name="line-523"></a>
<a name="line-524"></a><a name="clist_add_bit"></a><font color=Blue><i>-- | Add a single signed bit as a control to a control list.</i></font>
<a name="line-525"></a><font color=Blue>clist_add_bit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> ControlList <font color=Red>-&gt;</font> ControlList
<a name="line-526"></a><font color=Blue>clist_add_bit</font> c b cl <font color=Red>=</font> clist_add <font color=Cyan>(</font>wire_of_bit c<font color=Cyan>)</font> b cl
<a name="line-527"></a>
<a name="line-528"></a><font color=Green><u>instance</u></font> <font color=Cyan>(</font>ControlSource <font color=Cyan>(</font>Signed a<font color=Cyan>)</font><font color=Cyan>,</font> ControlSource <font color=Cyan>(</font>Signed b<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=&gt;</font> ControlSource <font color=Cyan>(</font>Signed <font color=Cyan>(</font>B_Endpoint a b<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-529"></a>  to_control <font color=Cyan>(</font>Signed <font color=Cyan>(</font>Endpoint_Qubit q<font color=Cyan>)</font> b<font color=Cyan>)</font> <font color=Red>=</font> to_control <font color=Cyan>(</font>Signed q b<font color=Cyan>)</font>
<a name="line-530"></a>  to_control <font color=Cyan>(</font>Signed <font color=Cyan>(</font>Endpoint_Bit c<font color=Cyan>)</font> b<font color=Cyan>)</font> <font color=Red>=</font> to_control <font color=Cyan>(</font>Signed c b<font color=Cyan>)</font>
<a name="line-531"></a>
<a name="line-532"></a><font color=Green><u>instance</u></font> <font color=Cyan>(</font>ControlSource a<font color=Cyan>,</font> ControlSource b<font color=Cyan>)</font> <font color=Red>=&gt;</font> ControlSource <font color=Cyan>(</font>B_Endpoint a b<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-533"></a>  to_control <font color=Cyan>(</font>Endpoint_Qubit q<font color=Cyan>)</font> <font color=Red>=</font> to_control q
<a name="line-534"></a>  to_control <font color=Cyan>(</font>Endpoint_Bit c<font color=Cyan>)</font> <font color=Red>=</font> to_control c
<a name="line-535"></a>  
<a name="line-536"></a><font color=Green><u>instance</u></font> ControlSource <font color=Cyan>(</font>Signed Qubit<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-537"></a>  to_control <font color=Cyan>(</font>Signed q b<font color=Cyan>)</font> <font color=Red>=</font> to_control <font color=Cyan>(</font>Signed <font color=Cyan>(</font>wire_of_qubit q<font color=Cyan>)</font> b<font color=Cyan>)</font>
<a name="line-538"></a>  
<a name="line-539"></a><font color=Green><u>instance</u></font> ControlSource Qubit <font color=Green><u>where</u></font>  
<a name="line-540"></a>  to_control q <font color=Red>=</font> to_control <font color=Cyan>(</font>Signed q True<font color=Cyan>)</font>
<a name="line-541"></a>  
<a name="line-542"></a><font color=Green><u>instance</u></font> ControlSource <font color=Cyan>(</font>Signed Bit<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-543"></a>  to_control <font color=Cyan>(</font>Signed q b<font color=Cyan>)</font> <font color=Red>=</font> to_control <font color=Cyan>(</font>Signed <font color=Cyan>(</font>wire_of_bit q<font color=Cyan>)</font> b<font color=Cyan>)</font>
<a name="line-544"></a>  
<a name="line-545"></a><font color=Green><u>instance</u></font> ControlSource Bit <font color=Green><u>where</u></font>  
<a name="line-546"></a>  to_control q <font color=Red>=</font> to_control <font color=Cyan>(</font>Signed q True<font color=Cyan>)</font>
<a name="line-547"></a>
<a name="line-548"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-549"></a><font color=Blue><i>-- * Namespace management</i></font>
<a name="line-550"></a>
<a name="line-551"></a><a name="provide_simple_subroutine"></a><font color=Blue><i>-- | @'provideSimpleSubroutine' name circ in_struct out_struct is_classically_controllable@:</i></font>
<a name="line-552"></a><font color=Blue><i>-- if /name/ not already bound, binds it to /circ/.</i></font>
<a name="line-553"></a><font color=Blue><i>-- Note: when there&#x2019;s an existing value, does /not/ check that</i></font>
<a name="line-554"></a><font color=Blue><i>-- it&#x2019;s equal to /circ/.  </i></font>
<a name="line-555"></a><font color=Blue>provide_simple_subroutine</font> <font color=Red>::</font> <font color=Cyan>(</font>Typeable a<font color=Cyan>,</font> Typeable b<font color=Cyan>)</font> <font color=Red>=&gt;</font> 
<a name="line-556"></a>  BoxId <font color=Red>-&gt;</font> OCircuit <font color=Red>-&gt;</font> CircuitTypeStructure a <font color=Red>-&gt;</font> CircuitTypeStructure b <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> Circ ()
<a name="line-557"></a><font color=Blue>provide_simple_subroutine</font> name ocirc input_structure output_structure is_classically_controllable <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-558"></a>  s <font color=Red>&lt;-</font> get_namespace
<a name="line-559"></a>  <font color=Green><u>let</u></font> OCircuit <font color=Cyan>(</font>win<font color=Cyan>,</font> circ<font color=Cyan>,</font> wout<font color=Cyan>)</font> <font color=Red>=</font> ocirc
<a name="line-560"></a>  <font color=Green><u>let</u></font> c <font color=Red>=</font> <font color=Green><u>if</u></font> controllable_circuit circ <font color=Green><u>then</u></font> AllCtl <font color=Green><u>else</u></font> <font color=Green><u>if</u></font> is_classically_controllable <font color=Green><u>then</u></font> OnlyClassicalCtl <font color=Green><u>else</u></font> NoCtl
<a name="line-561"></a>  <font color=Green><u>let</u></font> typed_subroutine <font color=Red>=</font> TypedSubroutine ocirc input_structure output_structure c
<a name="line-562"></a>  <font color=Green><u>let</u></font> s' <font color=Red>=</font> map_provide name typed_subroutine s
<a name="line-563"></a>  set_namespace s'
<a name="line-564"></a>  put_subroutine_definition name typed_subroutine
<a name="line-565"></a>
<a name="line-566"></a><a name="provide_subroutines"></a><font color=Blue><i>-- | @'provideSubroutines' namespace@:</i></font>
<a name="line-567"></a><font color=Blue><i>-- Add each subroutine from the /namespace/ to the current circuit,</i></font>
<a name="line-568"></a><font color=Blue><i>-- unless a subroutine of that name already exists.</i></font>
<a name="line-569"></a><font color=Blue>provide_subroutines</font> <font color=Red>::</font> Namespace <font color=Red>-&gt;</font> Circ ()
<a name="line-570"></a><font color=Blue>provide_subroutines</font> state <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-571"></a>  main_state <font color=Red>&lt;-</font> get_namespace
<a name="line-572"></a>  <font color=Green><u>let</u></font> state1 <font color=Red>=</font> Map<font color=Cyan>.</font>union main_state state
<a name="line-573"></a>  set_namespace state1
<a name="line-574"></a>  <font color=Green><u>let</u></font> new_subs <font color=Red>=</font> Map<font color=Cyan>.</font>difference state main_state <font color=Blue><i>-- returns subroutines that are in state, but not main_state</i></font>
<a name="line-575"></a>  mapM_ <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>n<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>-&gt;</font> put_subroutine_definition n s<font color=Cyan>)</font> <font color=Cyan>(</font>Map<font color=Cyan>.</font>toList new_subs<font color=Cyan>)</font> <font color=Blue><i>-- puts a RW_Subroutine for each new subroutine definition</i></font>
<a name="line-576"></a>
<a name="line-577"></a><a name="provide_subroutine"></a><font color=Blue><i>-- | @'provideSubroutine' name circ@:</i></font>
<a name="line-578"></a><font color=Blue><i>-- if /name/ not already bound, binds it to the main circuit of /circ/,</i></font>
<a name="line-579"></a><font color=Blue><i>-- and additionally provides any missing subroutines of /circ/.</i></font>
<a name="line-580"></a><font color=Blue>provide_subroutine</font> <font color=Red>::</font> <font color=Cyan>(</font>Typeable a<font color=Cyan>,</font> Typeable b<font color=Cyan>)</font> <font color=Red>=&gt;</font> 
<a name="line-581"></a>  BoxId <font color=Red>-&gt;</font> OBCircuit <font color=Red>-&gt;</font> CircuitTypeStructure a <font color=Red>-&gt;</font> CircuitTypeStructure b <font color=Red>-&gt;</font> Bool <font color=Red>-&gt;</font> Circ ()
<a name="line-582"></a><font color=Blue>provide_subroutine</font> name obcirc input_structure output_structure is_classically_controllable <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-583"></a>  main_state <font color=Red>&lt;-</font> get_namespace
<a name="line-584"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>ocirc<font color=Cyan>,</font>subsubroutines<font color=Cyan>)</font> <font color=Red>=</font> obcirc
<a name="line-585"></a>  <font color=Green><u>if</u></font> Map<font color=Cyan>.</font>member name main_state 
<a name="line-586"></a>    <font color=Green><u>then</u></font> return () 
<a name="line-587"></a>    <font color=Green><u>else</u></font> <font color=Green><u>do</u></font>
<a name="line-588"></a>      provide_simple_subroutine name ocirc input_structure output_structure is_classically_controllable
<a name="line-589"></a>      provide_subroutines subsubroutines
<a name="line-590"></a>
<a name="line-591"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-592"></a><font color=Blue><i>-- * General gate</i></font>
<a name="line-593"></a>      
<a name="line-594"></a><a name="apply_gate"></a><font color=Blue><i>-- | Apply the specified low-level gate to the current circuit, using</i></font>
<a name="line-595"></a><font color=Blue><i>-- the current controls, and updating the monad state accordingly.</i></font>
<a name="line-596"></a><font color=Blue><i>-- This includes run-time well-formedness checks. This is a helper</i></font>
<a name="line-597"></a><font color=Blue><i>-- function and is not directly accessible by user code.</i></font>
<a name="line-598"></a><font color=Blue>apply_gate</font> <font color=Red>::</font> Gate <font color=Red>-&gt;</font> Circ ()
<a name="line-599"></a><font color=Blue>apply_gate</font> gate <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-600"></a>  arity <font color=Red>&lt;-</font> get_arity
<a name="line-601"></a>  clist <font color=Red>&lt;-</font> get_clist
<a name="line-602"></a>  ncflag <font color=Red>&lt;-</font> get_ncflag
<a name="line-603"></a>  <font color=Green><u>let</u></font> gate' <font color=Red>=</font> gate_with_ncflag ncflag gate
<a name="line-604"></a>  <font color=Green><u>let</u></font> gate'' <font color=Red>=</font> control_gate clist gate'
<a name="line-605"></a>  <font color=Green><u>case</u></font> gate'' <font color=Green><u>of</u></font> 
<a name="line-606"></a>    Nothing <font color=Red>-&gt;</font> return ()
<a name="line-607"></a>    Just g <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-608"></a>      <font color=Green><u>let</u></font> arity' <font color=Red>=</font> arity_append g arity
<a name="line-609"></a>      put_gate g
<a name="line-610"></a>      set_arity arity'
<a name="line-611"></a>      return ()
<a name="line-612"></a>
<a name="line-613"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-614"></a><font color=Blue><i>-- * Basic gates</i></font>
<a name="line-615"></a>
<a name="line-616"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-617"></a><font color=Blue><i>-- ** Gates in functional style</i></font>
<a name="line-618"></a>
<a name="line-619"></a><a name="qnot"></a><font color=Blue><i>-- | Apply a NOT gate to a qubit.</i></font>
<a name="line-620"></a><font color=Blue>qnot</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-621"></a><font color=Blue>qnot</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-622"></a>  named_gate_qulist <font color=Magenta>"not"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-623"></a>  return q
<a name="line-624"></a>
<a name="line-625"></a><a name="hadamard"></a><font color=Blue><i>-- | Apply a Hadamard gate.</i></font>
<a name="line-626"></a><font color=Blue>hadamard</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-627"></a><font color=Blue>hadamard</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-628"></a>  named_gate_qulist <font color=Magenta>"H"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-629"></a>  return q
<a name="line-630"></a>
<a name="line-631"></a><a name="gate_H"></a><font color=Blue><i>-- | An alternate name for the Hadamard gate.</i></font>
<a name="line-632"></a><font color=Blue>gate_H</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-633"></a><font color=Blue>gate_H</font> <font color=Red>=</font> hadamard
<a name="line-634"></a>
<a name="line-635"></a><a name="qmultinot_list"></a><font color=Blue><i>-- | Apply a multiple-not gate, as specified by a list of booleans and</i></font>
<a name="line-636"></a><font color=Blue><i>--   qubits: @qmultinot_list [(True,q1), (False,q2), (True,q3)]@ applies </i></font>
<a name="line-637"></a><font color=Blue><i>--   a not gate to /q1/ and /q3/, but not to /q2/.</i></font>
<a name="line-638"></a><font color=Blue>qmultinot_list</font> <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Bool<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-639"></a><font color=Blue>qmultinot_list</font> qbs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-640"></a>  <font color=Green><u>let</u></font> qs <font color=Red>=</font> map fst <font color=Cyan>$</font> filter snd qbs
<a name="line-641"></a>  named_gate_qulist <font color=Magenta>"multinot"</font> False qs []
<a name="line-642"></a>  return <font color=Cyan>(</font>map fst qbs<font color=Cyan>)</font>
<a name="line-643"></a>
<a name="line-644"></a><a name="cmultinot_list"></a><font color=Blue><i>-- | Like 'qmultinot_list', but applies to classical bits instead of</i></font>
<a name="line-645"></a><font color=Blue><i>-- qubits. </i></font>
<a name="line-646"></a><font color=Blue>cmultinot_list</font> <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>Bit<font color=Cyan>,</font> Bool<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Bit<font color=Red>]</font>
<a name="line-647"></a><font color=Blue>cmultinot_list</font> cs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-648"></a>  <font color=Green><u>let</u></font> ws <font color=Red>=</font> map <font color=Cyan>(</font>wire_of_bit <font color=Cyan>.</font> fst<font color=Cyan>)</font> <font color=Cyan>$</font> filter snd cs
<a name="line-649"></a>  sequence_ <font color=Red>[</font> apply_gate <font color=Cyan>(</font>CNot w [] False<font color=Cyan>)</font> <font color=Red>|</font> w <font color=Red>&lt;-</font> ws <font color=Red>]</font>
<a name="line-650"></a>  return <font color=Cyan>(</font>map fst cs<font color=Cyan>)</font>
<a name="line-651"></a>
<a name="line-652"></a><a name="gate_X"></a><font color=Blue><i>-- | Apply a Pauli /X/ gate.</i></font>
<a name="line-653"></a><font color=Blue>gate_X</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-654"></a><font color=Blue>gate_X</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-655"></a>  named_gate_qulist <font color=Magenta>"X"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-656"></a>  return q
<a name="line-657"></a>
<a name="line-658"></a><a name="gate_Y"></a><font color=Blue><i>-- | Apply a Pauli /Y/ gate.</i></font>
<a name="line-659"></a><font color=Blue>gate_Y</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-660"></a><font color=Blue>gate_Y</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-661"></a>  named_gate_qulist <font color=Magenta>"Y"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-662"></a>  return q
<a name="line-663"></a>
<a name="line-664"></a><a name="gate_Z"></a><font color=Blue><i>-- | Apply a Pauli /Z/ gate.</i></font>
<a name="line-665"></a><font color=Blue>gate_Z</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-666"></a><font color=Blue>gate_Z</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-667"></a>  named_gate_qulist <font color=Magenta>"Z"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-668"></a>  return q
<a name="line-669"></a>
<a name="line-670"></a><a name="gate_S"></a><font color=Blue><i>-- | Apply a Clifford /S/-gate.</i></font>
<a name="line-671"></a><font color=Blue>gate_S</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-672"></a><font color=Blue>gate_S</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-673"></a>  named_gate_qulist <font color=Magenta>"S"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-674"></a>  return q
<a name="line-675"></a>  
<a name="line-676"></a><a name="gate_S_inv"></a><font color=Blue><i>-- | Apply the inverse of an /S/-gate.</i></font>
<a name="line-677"></a><font color=Blue>gate_S_inv</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-678"></a><font color=Blue>gate_S_inv</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-679"></a>  named_gate_qulist <font color=Magenta>"S"</font> True <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-680"></a>  return q
<a name="line-681"></a>  
<a name="line-682"></a><a name="gate_T"></a><font color=Blue><i>-- | Apply a /T/ = &#x221a;/S/ gate.</i></font>
<a name="line-683"></a><font color=Blue>gate_T</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-684"></a><font color=Blue>gate_T</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-685"></a>  named_gate_qulist <font color=Magenta>"T"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-686"></a>  return q
<a name="line-687"></a>  
<a name="line-688"></a><a name="gate_T_inv"></a><font color=Blue><i>-- | Apply the inverse of a /T/-gate.</i></font>
<a name="line-689"></a><font color=Blue>gate_T_inv</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-690"></a><font color=Blue>gate_T_inv</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-691"></a>  named_gate_qulist <font color=Magenta>"T"</font> True <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-692"></a>  return q
<a name="line-693"></a>  
<a name="line-694"></a><a name="gate_E"></a><font color=Blue><i>-- | Apply a Clifford /E/ = /H//S/[sup 3]&#x03c9;[sup 3] gate. </i></font>
<a name="line-695"></a><font color=Blue><i>-- </i></font>
<a name="line-696"></a><font color=Blue><i>-- \[image E.png]</i></font>
<a name="line-697"></a><font color=Blue><i>-- </i></font>
<a name="line-698"></a><font color=Blue><i>-- This gate is the unique Clifford operator with the properties /E/&#x00b3;</i></font>
<a name="line-699"></a><font color=Blue><i>-- = /I/, /EXE/&#x207b;&#x00b9; = /Y/, /EYE/&#x207b;&#x00b9; = /Z/, and /EZE/&#x207b;&#x00b9; = /X/. It is a</i></font>
<a name="line-700"></a><font color=Blue><i>-- convenient gate for calculations. For example, every Clifford</i></font>
<a name="line-701"></a><font color=Blue><i>-- operator can be uniquely written of the form</i></font>
<a name="line-702"></a><font color=Blue><i>-- </i></font>
<a name="line-703"></a><font color=Blue><i>-- * /E/[sup /a/]/X/[sup /b/]/S/[sup /c/]&#x03c9;[sup /d/],</i></font>
<a name="line-704"></a><font color=Blue><i>-- </i></font>
<a name="line-705"></a><font color=Blue><i>-- where /a/, /b/, /c/, and /d/ are taken modulo 3, 2, 4, and 8,</i></font>
<a name="line-706"></a><font color=Blue><i>-- respectively.</i></font>
<a name="line-707"></a><font color=Blue>gate_E</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-708"></a><font color=Blue>gate_E</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-709"></a>  named_gate_qulist <font color=Magenta>"E"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-710"></a>  return q
<a name="line-711"></a>  
<a name="line-712"></a><a name="gate_E_inv"></a><font color=Blue><i>-- | Apply the inverse of an /E/-gate.</i></font>
<a name="line-713"></a><font color=Blue>gate_E_inv</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-714"></a><font color=Blue>gate_E_inv</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-715"></a>  named_gate_qulist <font color=Magenta>"E"</font> True <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-716"></a>  return q
<a name="line-717"></a>  
<a name="line-718"></a><a name="gate_omega"></a><font color=Blue><i>-- | Apply the scalar &#x03c9; = [exp /i/&#x03c0;\/4], as a single-qubit gate.</i></font>
<a name="line-719"></a><font color=Blue>gate_omega</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-720"></a><font color=Blue>gate_omega</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-721"></a>  named_gate_qulist <font color=Magenta>"omega"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-722"></a>  return q
<a name="line-723"></a>
<a name="line-724"></a><a name="gate_V"></a><font color=Blue><i>-- | Apply a /V/ = &#x221a;/X/ gate. This is by definition the following gate</i></font>
<a name="line-725"></a><font color=Blue><i>-- (see also Nielsen and Chuang, p.182):</i></font>
<a name="line-726"></a><font color=Blue><i>-- </i></font>
<a name="line-727"></a><font color=Blue><i>-- \[image V.png]</i></font>
<a name="line-728"></a><font color=Blue>gate_V</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-729"></a><font color=Blue>gate_V</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-730"></a>  named_gate_qulist <font color=Magenta>"V"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-731"></a>  return q
<a name="line-732"></a>
<a name="line-733"></a><a name="gate_V_inv"></a><font color=Blue><i>-- | Apply the inverse of a /V/-gate.</i></font>
<a name="line-734"></a><font color=Blue>gate_V_inv</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-735"></a><font color=Blue>gate_V_inv</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-736"></a>  named_gate_qulist <font color=Magenta>"V"</font> True <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-737"></a>  return q
<a name="line-738"></a>
<a name="line-739"></a><a name="swap_qubit"></a><font color=Blue><i>-- | Apply a SWAP gate.</i></font>
<a name="line-740"></a><font color=Blue>swap_qubit</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font>Qubit<font color=Cyan>)</font>
<a name="line-741"></a><font color=Blue>swap_qubit</font> q1 q2 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-742"></a>  named_gate_qulist <font color=Magenta>"swap"</font> False <font color=Red>[</font>q1<font color=Cyan>,</font> q2<font color=Red>]</font> []
<a name="line-743"></a>  return <font color=Cyan>(</font>q1<font color=Cyan>,</font>q2<font color=Cyan>)</font>
<a name="line-744"></a>
<a name="line-745"></a><a name="swap_bit"></a><font color=Blue><i>-- | Apply a classical SWAP gate.</i></font>
<a name="line-746"></a><font color=Blue>swap_bit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Bit<font color=Cyan>,</font>Bit<font color=Cyan>)</font>
<a name="line-747"></a><font color=Blue>swap_bit</font> c1 c2 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-748"></a>  apply_gate <font color=Cyan>(</font>CSwap <font color=Cyan>(</font>wire_of_bit c1<font color=Cyan>)</font> <font color=Cyan>(</font>wire_of_bit c2<font color=Cyan>)</font> [] False<font color=Cyan>)</font>
<a name="line-749"></a>  return <font color=Cyan>(</font>c1<font color=Cyan>,</font>c2<font color=Cyan>)</font>
<a name="line-750"></a>
<a name="line-751"></a><a name="expZt"></a><font color=Blue><i>-- | Apply an [exp &#x2212;/iZt/] gate. The timestep /t/ is a parameter.</i></font>
<a name="line-752"></a><font color=Blue>expZt</font> <font color=Red>::</font> Timestep <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-753"></a><font color=Blue>expZt</font> t q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-754"></a>  named_rotation_qulist <font color=Magenta>"exp(-i%Z)"</font> False t <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-755"></a>  return q
<a name="line-756"></a>
<a name="line-757"></a><a name="rGate"></a><font color=Blue><i>-- | Apply a rotation by angle 2&#x03c0;/i/\/2[sup /n/] about the /z/-axis.</i></font>
<a name="line-758"></a><font color=Blue><i>-- </i></font>
<a name="line-759"></a><font color=Blue><i>-- \[image rGate.png]</i></font>
<a name="line-760"></a><font color=Blue>rGate</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-761"></a><font color=Blue>rGate</font> n q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-762"></a>  named_rotation_qulist <font color=Magenta>"R(2pi/%)"</font> False <font color=Cyan>(</font><font color=Magenta>2</font><font color=Cyan>^</font>n<font color=Cyan>)</font> <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-763"></a>  return q
<a name="line-764"></a>
<a name="line-765"></a><a name="gate_W"></a><font color=Blue><i>-- | Apply a /W/ gate. The /W/ gate is self-inverse and diagonalizes</i></font>
<a name="line-766"></a><font color=Blue><i>-- the SWAP gate. </i></font>
<a name="line-767"></a><font color=Blue><i>-- </i></font>
<a name="line-768"></a><font color=Blue><i>-- \[image W.png]</i></font>
<a name="line-769"></a><font color=Blue><i>-- </i></font>
<a name="line-770"></a><font color=Blue><i>-- The arguments are such that </i></font>
<a name="line-771"></a><font color=Blue><i>-- </i></font>
<a name="line-772"></a><font color=Blue><i>-- &gt; gate_W |0&#x232a; |0&#x232a; = |00&#x232a;</i></font>
<a name="line-773"></a><font color=Blue><i>-- &gt; gate_W |0&#x232a; |1&#x232a; = (|01&#x232a;+|10&#x232a;) / &#x221a;2</i></font>
<a name="line-774"></a><font color=Blue><i>-- &gt; gate_W |1&#x232a; |0&#x232a; = (|01&#x232a;-|10&#x232a;) / &#x221a;2</i></font>
<a name="line-775"></a><font color=Blue><i>-- &gt; gate_W |1&#x232a; |1&#x232a; = |11&#x232a;.</i></font>
<a name="line-776"></a><font color=Blue><i>-- </i></font>
<a name="line-777"></a><font color=Blue><i>-- In circuit diagrams, /W/[sub 1] denotes the \"left\" qubit, and /W/[sub 2]</i></font>
<a name="line-778"></a><font color=Blue><i>-- denotes the \"right\" qubit.</i></font>
<a name="line-779"></a><font color=Blue>gate_W</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>)</font>
<a name="line-780"></a><font color=Blue>gate_W</font> q1 q2 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-781"></a>  named_gate_qulist <font color=Magenta>"W"</font> False <font color=Red>[</font>q1<font color=Cyan>,</font> q2<font color=Red>]</font> []
<a name="line-782"></a>  return <font color=Cyan>(</font>q1<font color=Cyan>,</font> q2<font color=Cyan>)</font>
<a name="line-783"></a>
<a name="line-784"></a><a name="gate_iX"></a><font color=Blue><i>-- | Apply an /iX/ gate. This gate is used similarly to the Pauli /X/</i></font>
<a name="line-785"></a><font color=Blue><i>-- gate, but with two advantages:</i></font>
<a name="line-786"></a><font color=Blue><i>-- </i></font>
<a name="line-787"></a><font color=Blue><i>-- * the doubly-controlled /iX/ gate can be implemented in the</i></font>
<a name="line-788"></a><font color=Blue><i>-- Clifford+/T/ gate base with /T/-count 4 (the doubly-controlled /X/</i></font>
<a name="line-789"></a><font color=Blue><i>-- gate requires /T/-count 7);</i></font>
<a name="line-790"></a><font color=Blue><i>-- </i></font>
<a name="line-791"></a><font color=Blue><i>-- * the /iX/-gate has determinant 1, and therefore an /n/-times</i></font>
<a name="line-792"></a><font color=Blue><i>-- controlled /iX/ gate can be implemented in the Clifford+/T/ gate</i></font>
<a name="line-793"></a><font color=Blue><i>-- base with no ancillas.</i></font>
<a name="line-794"></a><font color=Blue><i>-- </i></font>
<a name="line-795"></a><font color=Blue><i>-- In particular, the /iX/ gate can be used to implement an additional</i></font>
<a name="line-796"></a><font color=Blue><i>-- control with /T/-count 8, like this:</i></font>
<a name="line-797"></a><font color=Blue><i>-- </i></font>
<a name="line-798"></a><font color=Blue><i>-- \[image iX.png]</i></font>
<a name="line-799"></a><font color=Blue>gate_iX</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-800"></a><font color=Blue>gate_iX</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-801"></a>  named_gate_qulist <font color=Magenta>"iX"</font> False <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-802"></a>  return q
<a name="line-803"></a>
<a name="line-804"></a><a name="gate_iX_inv"></a><font color=Blue><i>-- | Apply a &#x2212;/iX/ gate. This is the inverse of 'gate_iX'.</i></font>
<a name="line-805"></a><font color=Blue>gate_iX_inv</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-806"></a><font color=Blue>gate_iX_inv</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-807"></a>  named_gate_qulist <font color=Magenta>"iX"</font> True <font color=Red>[</font>q<font color=Red>]</font> []
<a name="line-808"></a>  return q
<a name="line-809"></a>
<a name="line-810"></a><a name="global_phase"></a><font color=Blue><i>-- | Apply a global phase change [exp /i/&#x03c0;/t/], where typically /t/ &#x2208;</i></font>
<a name="line-811"></a><font color=Blue><i>-- [0,2].  This gate is uninteresting if not controlled; however, it</i></font>
<a name="line-812"></a><font color=Blue><i>-- has non-trivial effect if it is used as a controlled gate.</i></font>
<a name="line-813"></a><font color=Blue>global_phase</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> Circ ()
<a name="line-814"></a><font color=Blue>global_phase</font> t <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-815"></a>  apply_gate <font color=Cyan>(</font>GPhase t [] [] False<font color=Cyan>)</font>
<a name="line-816"></a>  return ()
<a name="line-817"></a>
<a name="line-818"></a><a name="global_phase_anchored_list"></a><font color=Blue><i>-- | Like 'global_phase', except the gate is also \"anchored\" at a</i></font>
<a name="line-819"></a><font color=Blue><i>-- particular bit or qubit. This is strictly for graphical</i></font>
<a name="line-820"></a><font color=Blue><i>-- presentation purposes, to provide a hint for where the gate should</i></font>
<a name="line-821"></a><font color=Blue><i>-- be printed in a circuit diagram. Backends are free to ignore this</i></font>
<a name="line-822"></a><font color=Blue><i>-- hint altogether. The anchor is not actually an input to the gate,</i></font>
<a name="line-823"></a><font color=Blue><i>-- and it is legal for the anchoring qubit to also be used as a</i></font>
<a name="line-824"></a><font color=Blue><i>-- control control.</i></font>
<a name="line-825"></a><font color=Blue>global_phase_anchored_list</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> <font color=Red>[</font>Endpoint<font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-826"></a><font color=Blue>global_phase_anchored_list</font> t qs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-827"></a>  apply_gate <font color=Cyan>(</font>GPhase t <font color=Cyan>(</font>map wire_of_endpoint qs<font color=Cyan>)</font> [] False<font color=Cyan>)</font>
<a name="line-828"></a>  return ()
<a name="line-829"></a>
<a name="line-830"></a><a name="named_gate_qulist"></a><font color=Blue><i>-- | Apply a generic quantum gate to a given list of qubits and a</i></font>
<a name="line-831"></a><font color=Blue><i>-- given list of generalized controls. The generalized controls are</i></font>
<a name="line-832"></a><font color=Blue><i>-- really inputs to the gate, but are guaranteed not to be modified</i></font>
<a name="line-833"></a><font color=Blue><i>-- if they are in a computational basis state.</i></font>
<a name="line-834"></a><font color=Blue>named_gate_qulist</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-835"></a><font color=Blue>named_gate_qulist</font> name inv operands gencontrols <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-836"></a>  apply_gate <font color=Cyan>(</font>QGate name inv <font color=Cyan>(</font>map wire_of_qubit operands<font color=Cyan>)</font> <font color=Cyan>(</font>map wire_of_qubit gencontrols<font color=Cyan>)</font> [] False<font color=Cyan>)</font>
<a name="line-837"></a>  return <font color=Cyan>(</font>operands<font color=Cyan>,</font> gencontrols<font color=Cyan>)</font>
<a name="line-838"></a>
<a name="line-839"></a><a name="named_rotation_qulist"></a><font color=Blue><i>-- | Like 'named_gate_qulist', but produce a named gate that also</i></font>
<a name="line-840"></a><font color=Blue><i>-- depends on a real parameter. This is typically used for rotations</i></font>
<a name="line-841"></a><font color=Blue><i>-- or phase gates parameterized by an angle. The name can contain</i></font>
<a name="line-842"></a><font color=Blue><i>-- \'%\' as a place holder for the parameter, for example @\"exp(-i%Z)\"@.</i></font>
<a name="line-843"></a><font color=Blue>named_rotation_qulist</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> Timestep <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-844"></a><font color=Blue>named_rotation_qulist</font> name inv theta operands gencontrols <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-845"></a>  apply_gate <font color=Cyan>(</font>QRot name inv theta <font color=Cyan>(</font>map wire_of_qubit operands<font color=Cyan>)</font> <font color=Cyan>(</font>map wire_of_qubit gencontrols<font color=Cyan>)</font> [] False<font color=Cyan>)</font>
<a name="line-846"></a>  return <font color=Cyan>(</font>operands<font color=Cyan>,</font> gencontrols<font color=Cyan>)</font>
<a name="line-847"></a>
<a name="line-848"></a><a name="cnot"></a><font color=Blue><i>-- | Apply a NOT gate to a classical bit.</i></font>
<a name="line-849"></a><font color=Blue>cnot</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Circ Bit
<a name="line-850"></a><font color=Blue>cnot</font> b <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-851"></a>  apply_gate <font color=Cyan>(</font>CNot <font color=Cyan>(</font>wire_of_bit b<font color=Cyan>)</font> [] False<font color=Cyan>)</font>
<a name="line-852"></a>  return b
<a name="line-853"></a>
<a name="line-854"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-855"></a><font color=Blue><i>-- ** Gates in imperative style</i></font>
<a name="line-856"></a>
<a name="line-857"></a><a name="qnot_at"></a><font color=Blue><i>-- | Apply a NOT gate to a qubit.</i></font>
<a name="line-858"></a><font color=Blue>qnot_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-859"></a><font color=Blue>qnot_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-860"></a>  qnot q
<a name="line-861"></a>  return ()
<a name="line-862"></a>
<a name="line-863"></a><a name="hadamard_at"></a><font color=Blue><i>-- | Apply a Hadamard gate.</i></font>
<a name="line-864"></a><font color=Blue>hadamard_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-865"></a><font color=Blue>hadamard_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-866"></a>  hadamard q
<a name="line-867"></a>  return ()
<a name="line-868"></a>
<a name="line-869"></a><a name="gate_H_at"></a><font color=Blue><i>-- | An alternate name for the Hadamard gate.</i></font>
<a name="line-870"></a><font color=Blue>gate_H_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-871"></a><font color=Blue>gate_H_at</font> <font color=Red>=</font> hadamard_at
<a name="line-872"></a>
<a name="line-873"></a><a name="qmultinot_list_at"></a><font color=Blue><i>-- | Apply a /qmultinot_list/ gate, as specified by a list of booleans and</i></font>
<a name="line-874"></a><font color=Blue><i>--   qubits: @qmultinot_list [(True,q1), (False,q2), (True,q3)]@ applies </i></font>
<a name="line-875"></a><font color=Blue><i>--   a not gate to /q1/ and /q3/, but not to /q2/.</i></font>
<a name="line-876"></a><font color=Blue>qmultinot_list_at</font> <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Bool<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-877"></a><font color=Blue>qmultinot_list_at</font> qs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-878"></a>  qmultinot_list qs
<a name="line-879"></a>  return ()
<a name="line-880"></a>
<a name="line-881"></a><a name="cmultinot_list_at"></a><font color=Blue><i>-- | Like 'qmultinot_list_at', but applies to classical bits instead of</i></font>
<a name="line-882"></a><font color=Blue><i>-- qubits. </i></font>
<a name="line-883"></a><font color=Blue>cmultinot_list_at</font> <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>Bit<font color=Cyan>,</font> Bool<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-884"></a><font color=Blue>cmultinot_list_at</font> cs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-885"></a>  cmultinot_list cs
<a name="line-886"></a>  return ()
<a name="line-887"></a>
<a name="line-888"></a><a name="gate_X_at"></a><font color=Blue><i>-- | Apply a Pauli /X/ gate.</i></font>
<a name="line-889"></a><font color=Blue>gate_X_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-890"></a><font color=Blue>gate_X_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-891"></a>  gate_X q
<a name="line-892"></a>  return ()
<a name="line-893"></a>
<a name="line-894"></a><a name="gate_Y_at"></a><font color=Blue><i>-- | Apply a Pauli /Y/ gate.</i></font>
<a name="line-895"></a><font color=Blue>gate_Y_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-896"></a><font color=Blue>gate_Y_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-897"></a>  gate_Y q
<a name="line-898"></a>  return ()
<a name="line-899"></a>
<a name="line-900"></a><a name="gate_Z_at"></a><font color=Blue><i>-- | Apply a Pauli /Z/ gate.</i></font>
<a name="line-901"></a><font color=Blue>gate_Z_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-902"></a><font color=Blue>gate_Z_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-903"></a>  gate_Z q
<a name="line-904"></a>  return ()
<a name="line-905"></a>
<a name="line-906"></a><a name="gate_S_at"></a><font color=Blue><i>-- | Apply a Clifford /S/-gate.</i></font>
<a name="line-907"></a><font color=Blue>gate_S_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-908"></a><font color=Blue>gate_S_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-909"></a>  gate_S q
<a name="line-910"></a>  return ()
<a name="line-911"></a>
<a name="line-912"></a><a name="gate_S_inv_at"></a><font color=Blue><i>-- | Apply the inverse of an /S/-gate.</i></font>
<a name="line-913"></a><font color=Blue>gate_S_inv_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-914"></a><font color=Blue>gate_S_inv_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-915"></a>  gate_S_inv q
<a name="line-916"></a>  return ()
<a name="line-917"></a>
<a name="line-918"></a><a name="gate_T_at"></a><font color=Blue><i>-- | Apply a /T/ = &#x221a;/S/ gate.</i></font>
<a name="line-919"></a><font color=Blue>gate_T_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-920"></a><font color=Blue>gate_T_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-921"></a>  gate_T q
<a name="line-922"></a>  return ()
<a name="line-923"></a>
<a name="line-924"></a><a name="gate_T_inv_at"></a><font color=Blue><i>-- | Apply the inverse of a /T/-gate.</i></font>
<a name="line-925"></a><font color=Blue>gate_T_inv_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-926"></a><font color=Blue>gate_T_inv_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-927"></a>  gate_T_inv q
<a name="line-928"></a>  return ()
<a name="line-929"></a>
<a name="line-930"></a><a name="gate_E_at"></a><font color=Blue><i>-- | Apply a Clifford /E/ = /H//S/[sup 3]&#x03c9;[sup 3] gate. </i></font>
<a name="line-931"></a><font color=Blue><i>-- </i></font>
<a name="line-932"></a><font color=Blue><i>-- \[image E.png]</i></font>
<a name="line-933"></a><font color=Blue><i>-- </i></font>
<a name="line-934"></a><font color=Blue><i>-- This gate is the unique Clifford operator with the properties /E/&#x00b3;</i></font>
<a name="line-935"></a><font color=Blue><i>-- = /I/, /EXE/&#x207b;&#x00b9; = /Y/, /EYE/&#x207b;&#x00b9; = /Z/, and /EZE/&#x207b;&#x00b9; = /X/. It is a</i></font>
<a name="line-936"></a><font color=Blue><i>-- convenient gate for calculations. For example, every Clifford</i></font>
<a name="line-937"></a><font color=Blue><i>-- operator can be uniquely written of the form</i></font>
<a name="line-938"></a><font color=Blue><i>-- </i></font>
<a name="line-939"></a><font color=Blue><i>-- * /E/[sup /a/]/X/[sup /b/]/S/[sup /c/]&#x03c9;[sup /d/],</i></font>
<a name="line-940"></a><font color=Blue><i>-- </i></font>
<a name="line-941"></a><font color=Blue><i>-- where /a/, /b/, /c/, and /d/ are taken modulo 3, 2, 4, and 8,</i></font>
<a name="line-942"></a><font color=Blue><i>-- respectively.</i></font>
<a name="line-943"></a><font color=Blue>gate_E_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-944"></a><font color=Blue>gate_E_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-945"></a>  gate_E q
<a name="line-946"></a>  return ()
<a name="line-947"></a>
<a name="line-948"></a><a name="gate_E_inv_at"></a><font color=Blue><i>-- | Apply the inverse of an /E/-gate.</i></font>
<a name="line-949"></a><font color=Blue>gate_E_inv_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-950"></a><font color=Blue>gate_E_inv_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-951"></a>  gate_E_inv q
<a name="line-952"></a>  return ()
<a name="line-953"></a>
<a name="line-954"></a><a name="gate_omega_at"></a><font color=Blue><i>-- | Apply the scalar &#x03c9; = [exp /i/&#x03c0;\/4], as a single-qubit gate.</i></font>
<a name="line-955"></a><font color=Blue>gate_omega_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-956"></a><font color=Blue>gate_omega_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-957"></a>  gate_omega q
<a name="line-958"></a>  return ()
<a name="line-959"></a>
<a name="line-960"></a><a name="gate_V_at"></a><font color=Blue><i>-- | Apply a /V/ = &#x221a;/X/ gate. This is by definition the following gate</i></font>
<a name="line-961"></a><font color=Blue><i>-- (see also Nielsen and Chuang, p.182):</i></font>
<a name="line-962"></a><font color=Blue><i>-- </i></font>
<a name="line-963"></a><font color=Blue><i>-- \[image V.png]</i></font>
<a name="line-964"></a><font color=Blue>gate_V_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-965"></a><font color=Blue>gate_V_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-966"></a>  gate_V q
<a name="line-967"></a>  return ()
<a name="line-968"></a>
<a name="line-969"></a><a name="gate_V_inv_at"></a><font color=Blue><i>-- | Apply the inverse of a /V/-gate.</i></font>
<a name="line-970"></a><font color=Blue>gate_V_inv_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-971"></a><font color=Blue>gate_V_inv_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-972"></a>  gate_V_inv q
<a name="line-973"></a>  return ()
<a name="line-974"></a>
<a name="line-975"></a><a name="swap_qubit_at"></a><font color=Blue><i>-- | Apply a SWAP gate.</i></font>
<a name="line-976"></a><font color=Blue>swap_qubit_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-977"></a><font color=Blue>swap_qubit_at</font> q1 q2 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-978"></a>  swap_qubit q1 q2
<a name="line-979"></a>  return ()
<a name="line-980"></a>
<a name="line-981"></a><a name="swap_bit_at"></a><font color=Blue><i>-- | Apply a classical SWAP gate.</i></font>
<a name="line-982"></a><font color=Blue>swap_bit_at</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> Circ ()
<a name="line-983"></a><font color=Blue>swap_bit_at</font> c1 c2 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-984"></a>  swap_bit c1 c2
<a name="line-985"></a>  return ()
<a name="line-986"></a>
<a name="line-987"></a><a name="expZt_at"></a><font color=Blue><i>-- | Apply an [exp &#x2212;/iZt/] gate. The timestep /t/ is a parameter.</i></font>
<a name="line-988"></a><font color=Blue>expZt_at</font> <font color=Red>::</font> Timestep <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-989"></a><font color=Blue>expZt_at</font> t q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-990"></a>  expZt t q
<a name="line-991"></a>  return ()
<a name="line-992"></a>
<a name="line-993"></a><a name="rGate_at"></a><font color=Blue><i>-- | Apply a rotation by angle 2&#x03c0;/i/\/2[sup /n/] about the /z/-axis.</i></font>
<a name="line-994"></a><font color=Blue><i>-- </i></font>
<a name="line-995"></a><font color=Blue><i>-- \[image rGate.png]</i></font>
<a name="line-996"></a><font color=Blue>rGate_at</font> <font color=Red>::</font> Int <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-997"></a><font color=Blue>rGate_at</font> n q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-998"></a>  rGate n q
<a name="line-999"></a>  return ()
<a name="line-1000"></a>
<a name="line-1001"></a><a name="gate_W_at"></a><font color=Blue><i>-- | Apply a /W/ gate. The /W/ gate is self-inverse and diagonalizes</i></font>
<a name="line-1002"></a><font color=Blue><i>-- the SWAP gate. </i></font>
<a name="line-1003"></a><font color=Blue><i>-- </i></font>
<a name="line-1004"></a><font color=Blue><i>-- \[image W.png]</i></font>
<a name="line-1005"></a><font color=Blue><i>-- </i></font>
<a name="line-1006"></a><font color=Blue><i>-- The arguments are such that </i></font>
<a name="line-1007"></a><font color=Blue><i>-- </i></font>
<a name="line-1008"></a><font color=Blue><i>-- &gt; gate_W |0&#x232a; |0&#x232a; = |00&#x232a;</i></font>
<a name="line-1009"></a><font color=Blue><i>-- &gt; gate_W |0&#x232a; |1&#x232a; = (|01&#x232a;+|10&#x232a;) / &#x221a;2</i></font>
<a name="line-1010"></a><font color=Blue><i>-- &gt; gate_W |1&#x232a; |0&#x232a; = (|01&#x232a;-|10&#x232a;) / &#x221a;2</i></font>
<a name="line-1011"></a><font color=Blue><i>-- &gt; gate_W |1&#x232a; |1&#x232a; = |11&#x232a;.</i></font>
<a name="line-1012"></a><font color=Blue><i>-- </i></font>
<a name="line-1013"></a><font color=Blue><i>-- In circuit diagrams, /W/[sub 1] denotes the \"left\" qubit, and /W/[sub 2]</i></font>
<a name="line-1014"></a><font color=Blue><i>-- denotes the \"right\" qubit.</i></font>
<a name="line-1015"></a><font color=Blue>gate_W_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-1016"></a><font color=Blue>gate_W_at</font> q1 q2 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1017"></a>  gate_W q1 q2
<a name="line-1018"></a>  return ()
<a name="line-1019"></a>
<a name="line-1020"></a><a name="gate_iX_at"></a><font color=Blue><i>-- | Apply an /iX/ gate. This gate is used similarly to the Pauli /X/</i></font>
<a name="line-1021"></a><font color=Blue><i>-- gate, but with two advantages:</i></font>
<a name="line-1022"></a><font color=Blue><i>-- </i></font>
<a name="line-1023"></a><font color=Blue><i>-- * the doubly-controlled /iX/ gate can be implemented in the</i></font>
<a name="line-1024"></a><font color=Blue><i>-- Clifford+/T/ gate base with /T/-count 4 (the doubly-controlled /X/</i></font>
<a name="line-1025"></a><font color=Blue><i>-- gate requires /T/-count 7);</i></font>
<a name="line-1026"></a><font color=Blue><i>-- </i></font>
<a name="line-1027"></a><font color=Blue><i>-- * the /iX/-gate has determinant 1, and therefore an /n/-times</i></font>
<a name="line-1028"></a><font color=Blue><i>-- controlled /iX/ gate can be implemented in the Clifford+/T/ gate</i></font>
<a name="line-1029"></a><font color=Blue><i>-- base with no ancillas.</i></font>
<a name="line-1030"></a><font color=Blue><i>-- </i></font>
<a name="line-1031"></a><font color=Blue><i>-- In particular, the /iX/ gate can be used to implement an additional</i></font>
<a name="line-1032"></a><font color=Blue><i>-- control with /T/-count 8, like this:</i></font>
<a name="line-1033"></a><font color=Blue><i>-- </i></font>
<a name="line-1034"></a><font color=Blue><i>-- \[image iX.png]</i></font>
<a name="line-1035"></a><font color=Blue>gate_iX_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-1036"></a><font color=Blue>gate_iX_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1037"></a>  gate_iX q
<a name="line-1038"></a>  return ()
<a name="line-1039"></a>
<a name="line-1040"></a><a name="gate_iX_inv_at"></a><font color=Blue><i>-- | Apply a &#x2212;/iX/ gate. This is the inverse of 'gate_iX_at'.</i></font>
<a name="line-1041"></a><font color=Blue>gate_iX_inv_at</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-1042"></a><font color=Blue>gate_iX_inv_at</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1043"></a>  gate_iX_inv q
<a name="line-1044"></a>  return ()
<a name="line-1045"></a>
<a name="line-1046"></a><a name="named_gate_qulist_at"></a><font color=Blue><i>-- | Apply a generic quantum gate to a given list of qubits and a</i></font>
<a name="line-1047"></a><font color=Blue><i>-- given list of generalized controls. The generalized controls are</i></font>
<a name="line-1048"></a><font color=Blue><i>-- really inputs to the gate, but are guaranteed not to be modified</i></font>
<a name="line-1049"></a><font color=Blue><i>-- if they are in a computational basis state.</i></font>
<a name="line-1050"></a><font color=Blue>named_gate_qulist_at</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-1051"></a><font color=Blue>named_gate_qulist_at</font> name inv operands gencontrols <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1052"></a>  named_gate_qulist name inv operands gencontrols  
<a name="line-1053"></a>  return ()
<a name="line-1054"></a>
<a name="line-1055"></a><a name="named_rotation_qulist_at"></a><font color=Blue><i>-- | Like 'named_gate_qulist_at', but produce a named gate that also</i></font>
<a name="line-1056"></a><font color=Blue><i>-- depends on a real parameter. This is typically used for rotations</i></font>
<a name="line-1057"></a><font color=Blue><i>-- or phase gates parameterized by an angle. The name can contain</i></font>
<a name="line-1058"></a><font color=Blue><i>-- \'%\' as a place holder for the parameter, for example @\"exp(-i%Z)\"@.</i></font>
<a name="line-1059"></a><font color=Blue>named_rotation_qulist_at</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> Timestep <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-1060"></a><font color=Blue>named_rotation_qulist_at</font> name inv t operands gencontrols <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1061"></a>  named_rotation_qulist name inv t operands gencontrols  
<a name="line-1062"></a>  return ()
<a name="line-1063"></a>
<a name="line-1064"></a><a name="cnot_at"></a><font color=Blue><i>-- | Apply a NOT gate to a classical bit.</i></font>
<a name="line-1065"></a><font color=Blue>cnot_at</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Circ ()
<a name="line-1066"></a><font color=Blue>cnot_at</font> b <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1067"></a>  cnot b
<a name="line-1068"></a>  return ()
<a name="line-1069"></a>
<a name="line-1070"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1071"></a><font color=Blue><i>-- ** Bitwise initialization and termination functions</i></font>
<a name="line-1072"></a>
<a name="line-1073"></a><a name="qinit_qubit"></a><font color=Blue><i>-- | Generate a new qubit, initialized to the parameter 'Bool'.</i></font>
<a name="line-1074"></a><font color=Blue>qinit_qubit</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Circ Qubit
<a name="line-1075"></a><font color=Blue>qinit_qubit</font> b <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1076"></a>  arity <font color=Red>&lt;-</font> get_arity
<a name="line-1077"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> arity_unused_wire arity
<a name="line-1078"></a>  apply_gate <font color=Cyan>(</font>QInit b w False<font color=Cyan>)</font>
<a name="line-1079"></a>  return <font color=Cyan>(</font>qubit_of_wire w<font color=Cyan>)</font>
<a name="line-1080"></a>
<a name="line-1081"></a><a name="qterm_qubit"></a><font color=Blue><i>-- | Terminate a qubit asserted to be in state /b/. </i></font>
<a name="line-1082"></a><font color=Blue><i>-- </i></font>
<a name="line-1083"></a><font color=Blue><i>-- We note that the assertion is relative to the precision: when gates</i></font>
<a name="line-1084"></a><font color=Blue><i>-- in a circuit are implemented up to some precision &#x03b5; (either due to</i></font>
<a name="line-1085"></a><font color=Blue><i>-- physical limitations, or due to decomposition into a discrete gate</i></font>
<a name="line-1086"></a><font color=Blue><i>-- base), the assertion may only hold up to a corresponding precision</i></font>
<a name="line-1087"></a><font color=Blue><i>-- as well.</i></font>
<a name="line-1088"></a><font color=Blue>qterm_qubit</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-1089"></a><font color=Blue>qterm_qubit</font> b q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1090"></a>  apply_gate <font color=Cyan>(</font>QTerm b <font color=Cyan>(</font>wire_of_qubit q<font color=Cyan>)</font> False<font color=Cyan>)</font>
<a name="line-1091"></a>  return ()
<a name="line-1092"></a>
<a name="line-1093"></a><a name="qdiscard_qubit"></a><font color=Blue><i>-- | Discard a qubit destructively.</i></font>
<a name="line-1094"></a><font color=Blue>qdiscard_qubit</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-1095"></a><font color=Blue>qdiscard_qubit</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1096"></a>  apply_gate <font color=Cyan>(</font>QDiscard <font color=Cyan>(</font>wire_of_qubit q<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1097"></a>  return ()
<a name="line-1098"></a>
<a name="line-1099"></a><a name="prepare_qubit"></a><font color=Blue><i>-- | Generate a new qubit, initialized from a classical bit. Note that</i></font>
<a name="line-1100"></a><font color=Blue><i>-- the classical bit is simultaneously terminated. </i></font>
<a name="line-1101"></a><font color=Blue>prepare_qubit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Circ Qubit
<a name="line-1102"></a><font color=Blue>prepare_qubit</font> c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1103"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> wire_of_bit c
<a name="line-1104"></a>  apply_gate <font color=Cyan>(</font>QPrep w False<font color=Cyan>)</font>
<a name="line-1105"></a>  return <font color=Cyan>(</font>qubit_of_wire w<font color=Cyan>)</font>
<a name="line-1106"></a>
<a name="line-1107"></a><a name="unprepare_qubit"></a><font color=Blue><i>-- | Unprepare a qubit asserted to be in a computational basis</i></font>
<a name="line-1108"></a><font color=Blue><i>-- state. This is the same as a measurement, but must only be applied</i></font>
<a name="line-1109"></a><font color=Blue><i>-- to qubits that are already known to be in one of the states |0&#x232a; or</i></font>
<a name="line-1110"></a><font color=Blue><i>-- |1&#x232a;, and not in superposition. This operation is rarely (perhaps</i></font>
<a name="line-1111"></a><font color=Blue><i>-- never?) used in any quantum algorithms, but we include it for</i></font>
<a name="line-1112"></a><font color=Blue><i>-- consistency reasons, because it is formally the inverse of</i></font>
<a name="line-1113"></a><font color=Blue><i>-- 'prepare_qubit'.</i></font>
<a name="line-1114"></a><font color=Blue>unprepare_qubit</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Bit
<a name="line-1115"></a><font color=Blue>unprepare_qubit</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1116"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> wire_of_qubit q
<a name="line-1117"></a>  apply_gate <font color=Cyan>(</font>QUnprep w False<font color=Cyan>)</font>
<a name="line-1118"></a>  return <font color=Cyan>(</font>bit_of_wire w<font color=Cyan>)</font>
<a name="line-1119"></a>
<a name="line-1120"></a><a name="measure_qubit"></a><font color=Blue><i>-- | Apply a measurement gate (turns a qubit into a bit).</i></font>
<a name="line-1121"></a><font color=Blue>measure_qubit</font> <font color=Red>::</font> Qubit <font color=Red>-&gt;</font> Circ Bit
<a name="line-1122"></a><font color=Blue>measure_qubit</font> q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1123"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> wire_of_qubit q
<a name="line-1124"></a>  apply_gate <font color=Cyan>(</font>QMeas w<font color=Cyan>)</font>
<a name="line-1125"></a>  return <font color=Cyan>(</font>bit_of_wire w<font color=Cyan>)</font>
<a name="line-1126"></a>
<a name="line-1127"></a><a name="cinit_bit"></a><font color=Blue><i>-- | Generate a new classical bit, initialized to a boolean parameter</i></font>
<a name="line-1128"></a><font color=Blue><i>-- /b/.</i></font>
<a name="line-1129"></a><font color=Blue>cinit_bit</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Circ Bit
<a name="line-1130"></a><font color=Blue>cinit_bit</font> b <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1131"></a>  arity <font color=Red>&lt;-</font> get_arity
<a name="line-1132"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> arity_unused_wire arity
<a name="line-1133"></a>  apply_gate <font color=Cyan>(</font>CInit b w False<font color=Cyan>)</font>
<a name="line-1134"></a>  return <font color=Cyan>(</font>bit_of_wire w<font color=Cyan>)</font>
<a name="line-1135"></a>
<a name="line-1136"></a><a name="cterm_bit"></a><font color=Blue><i>-- | Terminate a classical 'Bit' asserted to be in state 'Bool'.</i></font>
<a name="line-1137"></a><font color=Blue>cterm_bit</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> Circ ()
<a name="line-1138"></a><font color=Blue>cterm_bit</font> b c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1139"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> wire_of_bit c
<a name="line-1140"></a>  apply_gate <font color=Cyan>(</font>CTerm b w False<font color=Cyan>)</font>
<a name="line-1141"></a>  return ()
<a name="line-1142"></a>
<a name="line-1143"></a><a name="dterm_bit"></a><font color=Blue><i>-- | Terminate a classical 'Bit' with a comment indicating what the</i></font>
<a name="line-1144"></a><font color=Blue><i>-- observed state of the 'Bit' was, in this particular dynamic run of</i></font>
<a name="line-1145"></a><font color=Blue><i>-- the circuit. This is typically used to terminate a wire right after</i></font>
<a name="line-1146"></a><font color=Blue><i>-- a dynamic lifting has been performed.  It is not intended to be a</i></font>
<a name="line-1147"></a><font color=Blue><i>-- user-level operation.</i></font>
<a name="line-1148"></a><font color=Blue><i>-- </i></font>
<a name="line-1149"></a><font color=Blue><i>-- It is important to note that a 'DTerm' gate does not, in any way,</i></font>
<a name="line-1150"></a><font color=Blue><i>-- represent an assertion. Unlike a 'CTerm' gate, which asserts that</i></font>
<a name="line-1151"></a><font color=Blue><i>-- the classical bit will have the stated value at /every/ run of the</i></font>
<a name="line-1152"></a><font color=Blue><i>-- circuit, the 'DTerm' gate simply records that the classical bit had</i></font>
<a name="line-1153"></a><font color=Blue><i>-- the stated value at some /particular/ run of the circuit.</i></font>
<a name="line-1154"></a><font color=Blue><i>--  </i></font>
<a name="line-1155"></a><font color=Blue><i>-- Operationally (e.g., in a simulator), the 'DTerm' gate can be</i></font>
<a name="line-1156"></a><font color=Blue><i>-- interpreted in multiple ways. In the simplest case, it is just</i></font>
<a name="line-1157"></a><font color=Blue><i>-- treated like a 'CDiscard' gate, and the boolean comment</i></font>
<a name="line-1158"></a><font color=Blue><i>-- ignored. Alternatively, it can be treated as a post-selection gate:</i></font>
<a name="line-1159"></a><font color=Blue><i>-- if the actual value does not equal the stated value, the entire</i></font>
<a name="line-1160"></a><font color=Blue><i>-- computation is aborted. Normally, 'DTerm' gates should appear in</i></font>
<a name="line-1161"></a><font color=Blue><i>-- the /output/, not the /input/ of simulators; therefore, the details</i></font>
<a name="line-1162"></a><font color=Blue><i>-- of the behavior of any particular simulator on a 'DTerm' gate are</i></font>
<a name="line-1163"></a><font color=Blue><i>-- implementation dependent.</i></font>
<a name="line-1164"></a><font color=Blue>dterm_bit</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> Circ ()
<a name="line-1165"></a><font color=Blue>dterm_bit</font> b c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1166"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> wire_of_bit c
<a name="line-1167"></a>  apply_gate <font color=Cyan>(</font>DTerm b w<font color=Cyan>)</font>
<a name="line-1168"></a>  return ()
<a name="line-1169"></a>
<a name="line-1170"></a><a name="cdiscard_bit"></a><font color=Blue><i>-- | Discard a classical bit destructively.</i></font>
<a name="line-1171"></a><font color=Blue>cdiscard_bit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Circ ()
<a name="line-1172"></a><font color=Blue>cdiscard_bit</font> c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1173"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> wire_of_bit c
<a name="line-1174"></a>  apply_gate <font color=Cyan>(</font>CDiscard w<font color=Cyan>)</font>
<a name="line-1175"></a>  return ()
<a name="line-1176"></a>
<a name="line-1177"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1178"></a><font color=Blue><i>-- ** Classical gates</i></font>
<a name="line-1179"></a>
<a name="line-1180"></a><font color=Blue><i>-- $CLASSICAL</i></font>
<a name="line-1181"></a><font color=Blue><i>--</i></font>
<a name="line-1182"></a><font color=Blue><i>-- The gates in this section are for constructing classical circuits. </i></font>
<a name="line-1183"></a><font color=Blue><i>-- None of these gates alter or discard their inputs; each gate produces </i></font>
<a name="line-1184"></a><font color=Blue><i>-- a new wire holding the output of the gate.</i></font>
<a name="line-1185"></a>
<a name="line-1186"></a><a name="cgate_xor"></a><font color=Blue><i>-- | Return the \"exclusive or\" of a list of bits. </i></font>
<a name="line-1187"></a><font color=Blue>cgate_xor</font> <font color=Red>::</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ Bit
<a name="line-1188"></a><font color=Blue>cgate_xor</font> inputs <font color=Red>=</font>
<a name="line-1189"></a>  cgate <font color=Magenta>"xor"</font> inputs
<a name="line-1190"></a>  
<a name="line-1191"></a><a name="cgate_eq"></a><font color=Blue><i>-- | Test equality of two bits, and return 'True' iff they are equal. </i></font>
<a name="line-1192"></a><font color=Blue>cgate_eq</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> Circ Bit
<a name="line-1193"></a><font color=Blue>cgate_eq</font> a b <font color=Red>=</font> cgate <font color=Magenta>"eq"</font> <font color=Red>[</font>a<font color=Cyan>,</font>b<font color=Red>]</font>
<a name="line-1194"></a>
<a name="line-1195"></a><a name="cgate_if_bit"></a><font color=Blue><i>-- | If /a/ is 'True', then return /b/, else return /c/.</i></font>
<a name="line-1196"></a><font color=Blue>cgate_if_bit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> Circ Bit
<a name="line-1197"></a><font color=Blue>cgate_if_bit</font> a b c <font color=Red>=</font> cgate <font color=Magenta>"if"</font> <font color=Red>[</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>c<font color=Red>]</font>
<a name="line-1198"></a>
<a name="line-1199"></a><a name="cgate_not"></a><font color=Blue><i>-- | Return the negation of its input. Note that unlike 'cnot' or</i></font>
<a name="line-1200"></a><font color=Blue><i>-- 'cnot_at', this gate does not alter its input, but returns a newly</i></font>
<a name="line-1201"></a><font color=Blue><i>-- created bit.</i></font>
<a name="line-1202"></a><font color=Blue>cgate_not</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Circ Bit
<a name="line-1203"></a><font color=Blue>cgate_not</font> a <font color=Red>=</font> cgate <font color=Magenta>"not"</font> <font color=Red>[</font>a<font color=Red>]</font>
<a name="line-1204"></a>
<a name="line-1205"></a><a name="cgate_and"></a><font color=Blue><i>-- | Return the conjunction of a list of bits.</i></font>
<a name="line-1206"></a><font color=Blue>cgate_and</font> <font color=Red>::</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ Bit
<a name="line-1207"></a><font color=Blue>cgate_and</font> inputs <font color=Red>=</font> cgate <font color=Magenta>"and"</font> inputs
<a name="line-1208"></a>
<a name="line-1209"></a><a name="cgate_or"></a><font color=Blue><i>-- | Return the disjunction of a list of bits.</i></font>
<a name="line-1210"></a><font color=Blue>cgate_or</font> <font color=Red>::</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ Bit
<a name="line-1211"></a><font color=Blue>cgate_or</font> inputs <font color=Red>=</font> cgate <font color=Magenta>"or"</font> inputs
<a name="line-1212"></a>
<a name="line-1213"></a><a name="cgate"></a><font color=Blue><i>-- | Apply a named classical gate. This is used to define all of the</i></font>
<a name="line-1214"></a><font color=Blue><i>-- above classical gates, but should not usually be directly used by</i></font>
<a name="line-1215"></a><font color=Blue><i>-- user code.</i></font>
<a name="line-1216"></a><font color=Blue>cgate</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ Bit
<a name="line-1217"></a><font color=Blue>cgate</font> name inputs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1218"></a>  arity <font color=Red>&lt;-</font> get_arity
<a name="line-1219"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> arity_unused_wire arity
<a name="line-1220"></a>  apply_gate <font color=Cyan>(</font>CGate name w <font color=Cyan>(</font>map wire_of_bit inputs<font color=Cyan>)</font> False<font color=Cyan>)</font>
<a name="line-1221"></a>  return <font color=Cyan>(</font>bit_of_wire w<font color=Cyan>)</font>
<a name="line-1222"></a>
<a name="line-1223"></a><a name="cgateinv"></a><font color=Blue><i>-- | @'cgateinv' name w inputs@: Uncompute a named classical</i></font>
<a name="line-1224"></a><font color=Blue><i>-- gate. This asserts that /w/ is in the state determined by the gate</i></font>
<a name="line-1225"></a><font color=Blue><i>-- type and the /inputs/, then uncomputes /w/ in a reversible</i></font>
<a name="line-1226"></a><font color=Blue><i>-- way. This rarely used gate is formally the inverse of 'cgate'.</i></font>
<a name="line-1227"></a><font color=Blue>cgateinv</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> Bit <font color=Red>-&gt;</font> <font color=Red>[</font>Bit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-1228"></a><font color=Blue>cgateinv</font> name c inputs <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1229"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> wire_of_bit c
<a name="line-1230"></a>  apply_gate <font color=Cyan>(</font>CGateInv name w <font color=Cyan>(</font>map wire_of_bit inputs<font color=Cyan>)</font> False<font color=Cyan>)</font>
<a name="line-1231"></a>  return ()
<a name="line-1232"></a>
<a name="line-1233"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1234"></a><font color=Blue><i>-- ** Subroutines</i></font>
<a name="line-1235"></a>
<a name="line-1236"></a><a name="subroutine"></a><font color=Blue><i>-- | Insert a subroutine gate with specified name, and input/output</i></font>
<a name="line-1237"></a><font color=Blue><i>-- output types, and attach it to the given endpoints. Return the new</i></font>
<a name="line-1238"></a><font color=Blue><i>-- endpoints.</i></font>
<a name="line-1239"></a><font color=Blue><i>--</i></font>
<a name="line-1240"></a><font color=Blue><i>-- Note that the @['Wire']@ and 'Arity' arguments are used as a /pattern/</i></font>
<a name="line-1241"></a><font color=Blue><i>-- for the locations/types of wires of the subroutine; the @['Endpoint']@</i></font>
<a name="line-1242"></a><font color=Blue><i>-- argument (and output) specify what is attached in the current circuit.</i></font>
<a name="line-1243"></a><font color=Blue><i>-- The two aspects of this pattern that are respected are: the</i></font>
<a name="line-1244"></a><font color=Blue><i>-- lingeringness of any inputs; and the number and types of wires.</i></font>
<a name="line-1245"></a><font color=Blue><i>--</i></font>
<a name="line-1246"></a><font color=Blue><i>-- For instance (assuming for simplicity that all wires are qubits), if</i></font>
<a name="line-1247"></a><font color=Blue><i>-- the patterns given are &#x201c;inputs [1,3,5], outputs [1,3,4]&#x201d;, and the </i></font>
<a name="line-1248"></a><font color=Blue><i>-- actual inputs specified are [20,21,25], then the output wires produced </i></font>
<a name="line-1249"></a><font color=Blue><i>-- might be e.g. [20,21,23], [20,21,36], or [20,21,8], depending on the </i></font>
<a name="line-1250"></a><font color=Blue><i>-- next available free wire.</i></font>
<a name="line-1251"></a><font color=Blue><i>--</i></font>
<a name="line-1252"></a><font color=Blue><i>-- More subtly, if</i></font>
<a name="line-1253"></a><font color=Blue><i>-- the patterns given are &#x201c;inputs [1,2,3], outputs [3,7,8,1]&#x201d;,</i></font>
<a name="line-1254"></a><font color=Blue><i>-- and the inputs given are [10,5,4], then the outputs will be</i></font>
<a name="line-1255"></a><font color=Blue><i>-- [4,/x/,/y/,10], where /x/, /y/ are two fresh wires.</i></font>
<a name="line-1256"></a><font color=Blue><i>--</i></font>
<a name="line-1257"></a><font color=Blue><i>-- Note that lingering wires may change type, for e.g. subroutines that</i></font>
<a name="line-1258"></a><font color=Blue><i>-- include measurements.</i></font>
<a name="line-1259"></a><font color=Blue><i>--</i></font>
<a name="line-1260"></a><font color=Blue><i>-- It is currently assumed that all these lists are linear, i.e. contain</i></font>
<a name="line-1261"></a><font color=Blue><i>-- no duplicates.</i></font>
<a name="line-1262"></a><font color=Blue>subroutine</font> <font color=Red>::</font> BoxId <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> ControllableFlag
<a name="line-1263"></a>           <font color=Red>-&gt;</font> RepeatFlag <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Arity <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> Arity
<a name="line-1264"></a>           <font color=Red>-&gt;</font> <font color=Red>[</font>Endpoint<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Endpoint<font color=Red>]</font>
<a name="line-1265"></a><font color=Blue>subroutine</font> name inv scf rep win_pattern ain_pattern wout_pattern aout_pattern ein <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1266"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>win<font color=Cyan>,</font>ain<font color=Cyan>)</font> <font color=Red>=</font> wires_with_arity_of_endpoints ein
<a name="line-1267"></a>  <font color=Blue><i>-- Check the given input wires match the pattern:</i></font>
<a name="line-1268"></a>  when <font color=Cyan>(</font>not <font color=Cyan>$</font> all <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>w_p<font color=Cyan>,</font>w<font color=Cyan>)</font> <font color=Red>-&gt;</font> ain_pattern IntMap<font color=Cyan>.!</font> w_p <font color=Cyan>==</font> ain IntMap<font color=Cyan>.!</font> w<font color=Cyan>)</font> <font color=Cyan>$</font> zip_strict_errmsg win_pattern win e_num_inputs<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> 
<a name="line-1269"></a>    error e_input_types
<a name="line-1270"></a>  <font color=Blue><i>-- Work out which input wires are lingering, and how many new wires are needed:</i></font>
<a name="line-1271"></a>  <font color=Green><u>let</u></font> partial_wout <font color=Red>=</font> map <font color=Cyan>(</font><font color=Red>\</font>w_p <font color=Red>-&gt;</font> <font color=Green><u>let</u></font> maybe_w <font color=Red>=</font> lookup w_p <font color=Cyan>(</font>zip win_pattern win<font color=Cyan>)</font>
<a name="line-1272"></a>                                  <font color=Green><u>in</u></font> <font color=Cyan>(</font>maybe_w<font color=Cyan>,</font> aout_pattern IntMap<font color=Cyan>.!</font> w_p<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1273"></a>                         wout_pattern
<a name="line-1274"></a>      num_new_wires <font color=Red>=</font> length <font color=Cyan>$</font> filter <font color=Cyan>(</font><font color=Cyan>(</font><font color=Cyan>==</font> Nothing<font color=Cyan>)</font> <font color=Cyan>.</font> fst<font color=Cyan>)</font> partial_wout 
<a name="line-1275"></a>  <font color=Blue><i>-- Allocate new wires for the non-lingering outputs:</i></font>
<a name="line-1276"></a>  arity <font color=Red>&lt;-</font> get_arity
<a name="line-1277"></a>  <font color=Green><u>let</u></font> new_wires <font color=Red>=</font> arity_unused_wires num_new_wires arity
<a name="line-1278"></a>      eout <font color=Red>=</font> insert_new_wires partial_wout new_wires
<a name="line-1279"></a>      <font color=Cyan>(</font>wout<font color=Cyan>,</font>aout<font color=Cyan>)</font> <font color=Red>=</font> wires_with_arity_of_endpoints eout
<a name="line-1280"></a>  apply_gate <font color=Cyan>(</font>Subroutine name inv win ain wout aout [] False scf rep<font color=Cyan>)</font>
<a name="line-1281"></a>  return eout
<a name="line-1282"></a>  <font color=Green><u>where</u></font>
<a name="line-1283"></a>    insert_new_wires <font color=Red>::</font> <font color=Red>[</font><font color=Cyan>(</font>Maybe Wire<font color=Cyan>,</font> Wiretype<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Wire<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Endpoint<font color=Red>]</font>
<a name="line-1284"></a>    insert_new_wires <font color=Cyan>(</font><font color=Cyan>(</font>Just w<font color=Cyan>,</font>t<font color=Cyan>)</font><font color=Red><b>:</b></font>ws<font color=Cyan>)</font> new_wires <font color=Red>=</font> <font color=Cyan>(</font>endpoint_of_wire w t<font color=Cyan>)</font><font color=Red><b>:</b></font><font color=Cyan>(</font>insert_new_wires ws new_wires<font color=Cyan>)</font>
<a name="line-1285"></a>    insert_new_wires <font color=Cyan>(</font><font color=Cyan>(</font>Nothing<font color=Cyan>,</font>t<font color=Cyan>)</font><font color=Red><b>:</b></font>ws<font color=Cyan>)</font> <font color=Cyan>(</font>next_new<font color=Red><b>:</b></font>new_wires<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>endpoint_of_wire next_new t<font color=Cyan>)</font><font color=Red><b>:</b></font><font color=Cyan>(</font>insert_new_wires ws new_wires<font color=Cyan>)</font>
<a name="line-1286"></a>    insert_new_wires [] [] <font color=Red>=</font> []
<a name="line-1287"></a>    insert_new_wires <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> <font color=Red>=</font> error e_output_allocation
<a name="line-1288"></a>    e_num_inputs <font color=Red>=</font> <font color=Magenta>"subroutine: subroutine "</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>" applied to the wrong number of input wires"</font>
<a name="line-1289"></a>    e_input_types <font color=Red>=</font> <font color=Magenta>"subroutine: subroutine "</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>" applied to input wires of incorrect type"</font>
<a name="line-1290"></a>    e_output_allocation <font color=Red>=</font> <font color=Magenta>"internal error: Quipper.Monad.subroutine: output wire allocation"</font>
<a name="line-1291"></a>
<a name="line-1292"></a>
<a name="line-1293"></a><a name="call_subroutine"></a><font color=Blue><i>-- | Look up the specified subroutine in the namespace, and apply it</i></font>
<a name="line-1294"></a><font color=Blue><i>-- to the specified inputs, or throw an error if they are not appropriately</i></font>
<a name="line-1295"></a><font color=Blue><i>-- typed.</i></font>
<a name="line-1296"></a><font color=Blue><i>--</i></font>
<a name="line-1297"></a><font color=Blue><i>-- The input/output types of this function are determined dynamically</i></font>
<a name="line-1298"></a><font color=Blue><i>-- by the 'CircuitTypeStructure' stored with the subroutine.</i></font>
<a name="line-1299"></a><font color=Blue>call_subroutine</font> <font color=Red>::</font> <font color=Cyan>(</font>Typeable a<font color=Cyan>,</font> Typeable b<font color=Cyan>)</font> <font color=Red>=&gt;</font> BoxId <font color=Red>-&gt;</font> RepeatFlag <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> Circ b
<a name="line-1300"></a><font color=Blue>call_subroutine</font> name r x <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1301"></a>  ns <font color=Red>&lt;-</font> get_namespace
<a name="line-1302"></a>  <font color=Green><u>let</u></font> mc <font color=Red>=</font> Map<font color=Cyan>.</font>lookup name ns
<a name="line-1303"></a>  <font color=Green><u>case</u></font> mc <font color=Green><u>of</u></font> 
<a name="line-1304"></a>    Nothing <font color=Red>-&gt;</font> 
<a name="line-1305"></a>      error <font color=Cyan>(</font><font color=Magenta>"call_subroutine: subroutine "</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>" does not exist in current namespace: "</font> <font color=Cyan>++</font> showNames ns<font color=Cyan>)</font>
<a name="line-1306"></a>    Just <font color=Cyan>(</font>TypedSubroutine ocircuit input_structure output_structure scf<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1307"></a>      <font color=Green><u>let</u></font> OCircuit <font color=Cyan>(</font>win_pattern<font color=Cyan>,</font> circuit<font color=Cyan>,</font> wout_pattern<font color=Cyan>)</font> <font color=Red>=</font> ocircuit
<a name="line-1308"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>ain_pattern<font color=Cyan>,</font> gates<font color=Cyan>,</font> aout_pattern<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> circuit
<a name="line-1309"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>win<font color=Cyan>,</font> ain<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>case</u></font> cast input_structure <font color=Green><u>of</u></font>
<a name="line-1310"></a>            Just suitable_input_structure <font color=Red>-&gt;</font> destructure_with suitable_input_structure x
<a name="line-1311"></a>            Nothing <font color=Red>-&gt;</font> error <font color=Cyan>(</font><font color=Magenta>"call_subroutine: subroutine "</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>" applied to input of incorrect type"</font><font color=Cyan>)</font>
<a name="line-1312"></a>      <font color=Green><u>let</u></font> ein <font color=Red>=</font> endpoints_of_wires_in_arity ain win
<a name="line-1313"></a>      eout <font color=Red>&lt;-</font> subroutine name False scf r win_pattern ain_pattern wout_pattern aout_pattern ein
<a name="line-1314"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>wout<font color=Cyan>,</font> aout<font color=Cyan>)</font> <font color=Red>=</font> wires_with_arity_of_endpoints eout
<a name="line-1315"></a>      
<a name="line-1316"></a>      <font color=Blue><i>--  The output structure of the subroutine contains the wires</i></font>
<a name="line-1317"></a>      <font color=Blue><i>--  corresponding to the actual output type of the function and</i></font>
<a name="line-1318"></a>      <font color=Blue><i>--  the wires that were created but forgotten, in</i></font>
<a name="line-1319"></a>      <font color=Blue><i>--  imperative-style. (see comments in 'provide_subroutine_generic').</i></font>
<a name="line-1320"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font>y<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Red>::</font><font color=Cyan>(</font><font color=Red>[</font>Qubit<font color=Red>]</font><font color=Cyan>,</font><font color=Red>[</font>Bit<font color=Red>]</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>case</u></font> cast output_structure <font color=Green><u>of</u></font>
<a name="line-1321"></a>            Just suitable_output_structure <font color=Red>-&gt;</font> structure_with suitable_output_structure <font color=Cyan>(</font>wout<font color=Cyan>,</font> aout<font color=Cyan>)</font>
<a name="line-1322"></a>            Nothing <font color=Red>-&gt;</font> error <font color=Cyan>(</font><font color=Magenta>"call_subroutine: attempt to use outputs of subroutine "</font> <font color=Cyan>++</font> show name <font color=Cyan>++</font> <font color=Magenta>" as incorrect type"</font><font color=Cyan>)</font>
<a name="line-1323"></a>      return y
<a name="line-1324"></a>
<a name="line-1325"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1326"></a><font color=Blue><i>-- ** Comments</i></font>
<a name="line-1327"></a>  
<a name="line-1328"></a><a name="comment_label"></a><font color=Blue><i>-- | Insert a comment in the circuit. This is not a gate, and has no</i></font>
<a name="line-1329"></a><font color=Blue><i>-- effect, except to mark a spot in the circuit. The comment has two</i></font>
<a name="line-1330"></a><font color=Blue><i>-- parts: a string (possibly empty), and a list of labelled wires</i></font>
<a name="line-1331"></a><font color=Blue><i>-- (possibly empty). This is a low-level function. Users should use</i></font>
<a name="line-1332"></a><font color=Blue><i>-- 'comment' instead.</i></font>
<a name="line-1333"></a><font color=Blue>comment_label</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> InverseFlag <font color=Red>-&gt;</font> <font color=Red>[</font><font color=Cyan>(</font>Wire<font color=Cyan>,</font> String<font color=Cyan>)</font><font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-1334"></a><font color=Blue>comment_label</font> s inv ws <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1335"></a>  b <font color=Red>&lt;-</font> get_nocommentflag
<a name="line-1336"></a>  when <font color=Cyan>(</font>not b<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1337"></a>    apply_gate <font color=Cyan>(</font>Comment s inv ws<font color=Cyan>)</font>
<a name="line-1338"></a>  return ()
<a name="line-1339"></a>
<a name="line-1340"></a><a name="without_comments"></a><font color=Blue><i>-- | Disable labels and comments for a block of code. The intended</i></font>
<a name="line-1341"></a><font color=Blue><i>-- usage is like this:</i></font>
<a name="line-1342"></a><font color=Blue><i>-- </i></font>
<a name="line-1343"></a><font color=Blue><i>-- &gt; without_comments $ do {</i></font>
<a name="line-1344"></a><font color=Blue><i>-- &gt;   &lt;&lt;&lt;code block&gt;&gt;&gt;</i></font>
<a name="line-1345"></a><font color=Blue><i>-- &gt; }</i></font>
<a name="line-1346"></a><font color=Blue><i>-- </i></font>
<a name="line-1347"></a><font color=Blue><i>-- This is sometimes useful in situations where code is being re-used,</i></font>
<a name="line-1348"></a><font color=Blue><i>-- for example when one function is implemented in terms of another,</i></font>
<a name="line-1349"></a><font color=Blue><i>-- but should not inherit comments from it. It is also useful in the</i></font>
<a name="line-1350"></a><font color=Blue><i>-- definition of recursive function, where a comment should only be</i></font>
<a name="line-1351"></a><font color=Blue><i>-- applied at the outermost level. Finally, it can be used to suppress</i></font>
<a name="line-1352"></a><font color=Blue><i>-- comments from parts of circuits for presentation purposes.</i></font>
<a name="line-1353"></a><font color=Blue>without_comments</font> <font color=Red>::</font> Circ a <font color=Red>-&gt;</font> Circ a
<a name="line-1354"></a><font color=Blue>without_comments</font> body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1355"></a>  b <font color=Red>&lt;-</font> get_nocommentflag
<a name="line-1356"></a>  set_nocommentflag True
<a name="line-1357"></a>  a <font color=Red>&lt;-</font> body
<a name="line-1358"></a>  set_nocommentflag b
<a name="line-1359"></a>  return a
<a name="line-1360"></a>  
<a name="line-1361"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1362"></a><font color=Blue><i>-- ** Dynamic lifting</i></font>
<a name="line-1363"></a>  
<a name="line-1364"></a><a name="dynamic_lift_bit"></a><font color=Blue><i>-- | Convert a 'Bit' (boolean circuit output) to a 'Bool' (boolean</i></font>
<a name="line-1365"></a><font color=Blue><i>-- parameter).</i></font>
<a name="line-1366"></a><font color=Blue><i>-- </i></font>
<a name="line-1367"></a><font color=Blue><i>-- For use in algorithms that require the output of a measurement to</i></font>
<a name="line-1368"></a><font color=Blue><i>-- be used as a circuit-generation parameter. This is the case, for</i></font>
<a name="line-1369"></a><font color=Blue><i>-- example, for sieving methods, and also for some iterative</i></font>
<a name="line-1370"></a><font color=Blue><i>-- algorithms.</i></font>
<a name="line-1371"></a><font color=Blue><i>-- </i></font>
<a name="line-1372"></a><font color=Blue><i>-- Note that this is not a gate, but a meta-operation. The input</i></font>
<a name="line-1373"></a><font color=Blue><i>-- consists of classical circuit endpoints (whose values are known at</i></font>
<a name="line-1374"></a><font color=Blue><i>-- circuit execution time), and the output is a boolean parameter</i></font>
<a name="line-1375"></a><font color=Blue><i>-- (whose value is known at circuit generation time). </i></font>
<a name="line-1376"></a><font color=Blue><i>-- </i></font>
<a name="line-1377"></a><font color=Blue><i>-- The use of this operation implies an interleaving between circuit</i></font>
<a name="line-1378"></a><font color=Blue><i>-- execution and circuit generation. It is therefore a (physically)</i></font>
<a name="line-1379"></a><font color=Blue><i>-- expensive operation and should be used sparingly. Using the</i></font>
<a name="line-1380"></a><font color=Blue><i>-- 'dynamic_lift_bit' operation interrupts the batch mode operation of</i></font>
<a name="line-1381"></a><font color=Blue><i>-- the quantum device (where circuits are generated ahead of time),</i></font>
<a name="line-1382"></a><font color=Blue><i>-- and forces interactive operation (the quantum device must wait for</i></font>
<a name="line-1383"></a><font color=Blue><i>-- the next portion of the circuit to be generated). This operation is</i></font>
<a name="line-1384"></a><font color=Blue><i>-- especially expensive if the current circuit contains unmeasured</i></font>
<a name="line-1385"></a><font color=Blue><i>-- qubits; in this case, the qubits must be preserved while the</i></font>
<a name="line-1386"></a><font color=Blue><i>-- quantum device remains on standby.</i></font>
<a name="line-1387"></a><font color=Blue><i>-- </i></font>
<a name="line-1388"></a><font color=Blue><i>-- Also note that this operation is not supported in all contexts. It</i></font>
<a name="line-1389"></a><font color=Blue><i>-- is an error, for example, to use this operation in a circuit that</i></font>
<a name="line-1390"></a><font color=Blue><i>-- is going to be reversed, or in the body of a boxed subroutine.</i></font>
<a name="line-1391"></a><font color=Blue><i>-- Also, not all output devices (such as circuit viewers) support this</i></font>
<a name="line-1392"></a><font color=Blue><i>-- operation.</i></font>
<a name="line-1393"></a><font color=Blue>dynamic_lift_bit</font> <font color=Red>::</font> Bit <font color=Red>-&gt;</font> Circ Bool
<a name="line-1394"></a><font color=Blue>dynamic_lift_bit</font> c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1395"></a>  b <font color=Red>&lt;-</font> do_read <font color=Cyan>(</font>wire_of_bit c<font color=Cyan>)</font>
<a name="line-1396"></a>  dterm_bit b c
<a name="line-1397"></a>  return b
<a name="line-1398"></a>  
<a name="line-1399"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-1400"></a><font color=Blue><i>-- * Other circuit-building functions</i></font>
<a name="line-1401"></a>
<a name="line-1402"></a><a name="qinit_plusminus"></a><font color=Blue><i>-- | Generate a new qubit initialized to |+&#x232a; when /b/='False' and</i></font>
<a name="line-1403"></a><font color=Blue><i>-- |&#x2212;&#x232a; when /b/='True'.</i></font>
<a name="line-1404"></a><font color=Blue>qinit_plusminus</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Circ Qubit
<a name="line-1405"></a><font color=Blue>qinit_plusminus</font> b <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1406"></a>  q <font color=Red>&lt;-</font> qinit_qubit b
<a name="line-1407"></a>  q <font color=Red>&lt;-</font> hadamard q
<a name="line-1408"></a>  return q  
<a name="line-1409"></a>
<a name="line-1410"></a><a name="qinit_of_char"></a><font color=Blue><i>-- | Generate a new qubit initialized to one of |0&#x232a;, |1&#x232a;, |+&#x232a;, |&#x2212;&#x232a;,</i></font>
<a name="line-1411"></a><font color=Blue><i>-- depending on a character /c/ which is \'0\', \'1\', \'+\', or \'-\'.</i></font>
<a name="line-1412"></a><font color=Blue>qinit_of_char</font> <font color=Red>::</font> Char <font color=Red>-&gt;</font> Circ Qubit
<a name="line-1413"></a><font color=Blue>qinit_of_char</font> <font color=Magenta>'0'</font> <font color=Red>=</font> qinit_qubit False
<a name="line-1414"></a><font color=Blue>qinit_of_char</font> <font color=Magenta>'1'</font> <font color=Red>=</font> qinit_qubit True
<a name="line-1415"></a><font color=Blue>qinit_of_char</font> <font color=Magenta>'+'</font> <font color=Red>=</font> qinit_plusminus False
<a name="line-1416"></a><font color=Blue>qinit_of_char</font> <font color=Magenta>'-'</font> <font color=Red>=</font> qinit_plusminus True
<a name="line-1417"></a><font color=Blue>qinit_of_char</font> c <font color=Red>=</font> error <font color=Cyan>(</font><font color=Magenta>"qinit_of_char: unimplemented initialization: "</font> <font color=Cyan>++</font> <font color=Red>[</font>c<font color=Red>]</font><font color=Cyan>)</font>
<a name="line-1418"></a>
<a name="line-1419"></a><a name="qinit_of_string"></a><font color=Blue><i>-- | Generate a list of qubits initialized to a sequence of |0&#x232a;, |1&#x232a;,</i></font>
<a name="line-1420"></a><font color=Blue><i>-- |+&#x232a;, |&#x2212;&#x232a;, defined by a string argument e.g. \"00+0+++\".</i></font>
<a name="line-1421"></a><font color=Blue>qinit_of_string</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-1422"></a><font color=Blue>qinit_of_string</font> s <font color=Red>=</font> sequence <font color=Cyan>(</font>map qinit_of_char s<font color=Cyan>)</font>
<a name="line-1423"></a>
<a name="line-1424"></a><a name="qinit_list"></a><font color=Blue><i>-- | A version of 'qinit_qubit' that operates on lists. </i></font>
<a name="line-1425"></a><font color=Blue>qinit_list</font> <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Qubit<font color=Red>]</font>
<a name="line-1426"></a><font color=Blue>qinit_list</font> bs <font color=Red>=</font> mapM qinit_qubit bs
<a name="line-1427"></a>
<a name="line-1428"></a>
<a name="line-1429"></a><a name="qterm_list"></a><font color=Blue><i>-- | A version of 'qterm_qubit' that operates on lists. We initialize</i></font>
<a name="line-1430"></a><font color=Blue><i>-- left-to-right and terminate right-to-left, as this leads to more</i></font>
<a name="line-1431"></a><font color=Blue><i>-- symmetric and readable circuits, more stable under reversal.</i></font>
<a name="line-1432"></a><font color=Blue><i>-- </i></font>
<a name="line-1433"></a><font color=Blue><i>-- Note: if the left argument to 'qterm_list' is longer than the right</i></font>
<a name="line-1434"></a><font color=Blue><i>-- argument, then it is truncated. So the first argument can be</i></font>
<a name="line-1435"></a><font color=Blue><i>-- ('repeat' 'False'). It is an error if the left argument is shorter</i></font>
<a name="line-1436"></a><font color=Blue><i>-- than the right one.</i></font>
<a name="line-1437"></a><font color=Blue>qterm_list</font> <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>Qubit<font color=Red>]</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-1438"></a><font color=Blue>qterm_list</font> bs qs <font color=Red>=</font>
<a name="line-1439"></a>  zipRightWithRightStrictM_ qterm_qubit bs qs
<a name="line-1440"></a>
<a name="line-1441"></a><a name="cinit_list"></a><font color=Blue><i>-- | A version of 'cinit_bit' for lists.</i></font>
<a name="line-1442"></a><font color=Blue>cinit_list</font> <font color=Red>::</font> <font color=Red>[</font>Bool<font color=Red>]</font> <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Bit<font color=Red>]</font>
<a name="line-1443"></a><font color=Blue>cinit_list</font> bs <font color=Red>=</font> mapM cinit_bit bs
<a name="line-1444"></a>
<a name="line-1445"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-1446"></a><font color=Blue><i>-- * Higher-order functions</i></font>
<a name="line-1447"></a>
<a name="line-1448"></a><a name="with_ancilla"></a><font color=Blue><i>-- | Convenient wrapper around 'qinit' and 'qterm'. This can be used</i></font>
<a name="line-1449"></a><font color=Blue><i>-- to introduce an ancilla with a local scope, like this:</i></font>
<a name="line-1450"></a><font color=Blue><i>-- </i></font>
<a name="line-1451"></a><font color=Blue><i>-- &gt; with_ancilla $ \h -&gt; do {</i></font>
<a name="line-1452"></a><font color=Blue><i>-- &gt;   &lt;&lt;&lt;code block using ancilla h&gt;&gt;&gt;</i></font>
<a name="line-1453"></a><font color=Blue><i>-- &gt; }</i></font>
<a name="line-1454"></a><font color=Blue><i>-- </i></font>
<a name="line-1455"></a><font color=Blue><i>-- The ancilla will be initialized to |0&#x232a; at the beginning of the</i></font>
<a name="line-1456"></a><font color=Blue><i>-- block, and it is the programmer's responsibility to ensure that it</i></font>
<a name="line-1457"></a><font color=Blue><i>-- will be returned to state |0&#x232a; at the end of the block.</i></font>
<a name="line-1458"></a><font color=Blue><i>-- </i></font>
<a name="line-1459"></a><font color=Blue><i>-- A block created with 'with_ancilla' is controllable, provided that</i></font>
<a name="line-1460"></a><font color=Blue><i>-- the body is controllable.</i></font>
<a name="line-1461"></a><font color=Blue>with_ancilla</font> <font color=Red>::</font> <font color=Cyan>(</font>Qubit <font color=Red>-&gt;</font> Circ a<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ a
<a name="line-1462"></a><font color=Blue>with_ancilla</font> f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1463"></a>  q <font color=Red>&lt;-</font> without_controls <font color=Cyan>(</font>qinit_qubit False<font color=Cyan>)</font>
<a name="line-1464"></a>  a <font color=Red>&lt;-</font> f q
<a name="line-1465"></a>  without_controls <font color=Cyan>(</font>qterm_qubit False q<font color=Cyan>)</font>
<a name="line-1466"></a>  return a
<a name="line-1467"></a>
<a name="line-1468"></a><font color=Blue><i>-- | A syntax for \"if\"-style (classical and quantum) controls. </i></font>
<a name="line-1469"></a><font color=Blue><i>-- This can be used as follows:</i></font>
<a name="line-1470"></a><font color=Blue><i>-- </i></font>
<a name="line-1471"></a><font color=Blue><i>-- &gt; gate1</i></font>
<a name="line-1472"></a><font color=Blue><i>-- &gt; with_controls &lt;&lt;controls&gt;&gt; $ do {</i></font>
<a name="line-1473"></a><font color=Blue><i>-- &gt;   gate2</i></font>
<a name="line-1474"></a><font color=Blue><i>-- &gt;   gate3</i></font>
<a name="line-1475"></a><font color=Blue><i>-- &gt; }</i></font>
<a name="line-1476"></a><font color=Blue><i>-- &gt; gate4</i></font>
<a name="line-1477"></a><font color=Blue><i>-- </i></font>
<a name="line-1478"></a><font color=Blue><i>-- The specified controls will be applied to gate2 and gate3. It is an</i></font>
<a name="line-1479"></a><font color=Blue><i>-- error to specify a control for a gate that cannot be controlled</i></font>
<a name="line-1480"></a><font color=Blue><i>-- (such as measurement).</i></font>
<a name="line-1481"></a>  
<a name="line-1482"></a><a name="with_controls"></a><font color=Blue>with_controls</font> <font color=Red>::</font> ControlSource c <font color=Red>=&gt;</font> c <font color=Red>-&gt;</font> Circ a <font color=Red>-&gt;</font> Circ a
<a name="line-1483"></a><font color=Blue>with_controls</font> control code <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1484"></a>  clist_old <font color=Red>&lt;-</font> get_clist
<a name="line-1485"></a>  set_clist <font color=Cyan>(</font>combine <font color=Cyan>(</font>to_control control<font color=Cyan>)</font> clist_old<font color=Cyan>)</font>
<a name="line-1486"></a>  a <font color=Red>&lt;-</font> code
<a name="line-1487"></a>  set_clist clist_old
<a name="line-1488"></a>  return a
<a name="line-1489"></a>  
<a name="line-1490"></a><font color=Blue><i>-- | An infix operator to apply the given controls to a gate:</i></font>
<a name="line-1491"></a><font color=Blue><i>-- </i></font>
<a name="line-1492"></a><font color=Blue><i>-- &gt; gate `controlled` &lt;&lt;controls&gt;&gt;</i></font>
<a name="line-1493"></a><font color=Blue><i>-- </i></font>
<a name="line-1494"></a><font color=Blue><i>-- It also works with functional-style gates:</i></font>
<a name="line-1495"></a><font color=Blue><i>-- </i></font>
<a name="line-1496"></a><font color=Blue><i>-- &gt; result &lt;- gate `controlled` &lt;&lt;controls&gt;&gt;</i></font>
<a name="line-1497"></a><font color=Blue><i>-- </i></font>
<a name="line-1498"></a><font color=Blue><i>-- The infix operator is left associative, so it can be applied</i></font>
<a name="line-1499"></a><font color=Blue><i>-- multiple times:</i></font>
<a name="line-1500"></a><font color=Blue><i>-- </i></font>
<a name="line-1501"></a><font color=Blue><i>-- &gt; result &lt;- gate `controlled` &lt;&lt;controls1&gt;&gt; `controlled` &lt;&lt;controls2&gt;&gt;</i></font>
<a name="line-1502"></a><font color=Blue><i>-- </i></font>
<a name="line-1503"></a><font color=Blue><i>-- The latter is equivalent to</i></font>
<a name="line-1504"></a><font color=Blue><i>-- </i></font>
<a name="line-1505"></a><font color=Blue><i>-- &gt; result &lt;- gate `controlled` &lt;&lt;controls1&gt;&gt; .&amp;&amp;. &lt;&lt;controls2&gt;&gt;</i></font>
<a name="line-1506"></a>
<a name="line-1507"></a><a name="controlled"></a><font color=Blue>controlled</font> <font color=Red>::</font> ControlSource c <font color=Red>=&gt;</font> Circ a <font color=Red>-&gt;</font> c <font color=Red>-&gt;</font> Circ a
<a name="line-1508"></a><font color=Blue>controlled</font> code control <font color=Red>=</font> with_controls control code
<a name="line-1509"></a>
<a name="line-1510"></a><font color=Green><u>infixl</u></font> <font color=Magenta>2</font> <font color=Cyan>`controlled`</font>
<a name="line-1511"></a>
<a name="line-1512"></a><a name="without_controls"></a><font color=Blue><i>-- | Apply a block of gates while temporarily suspending the</i></font>
<a name="line-1513"></a><font color=Blue><i>-- application of controls.  This can be used to omit controls on</i></font>
<a name="line-1514"></a><font color=Blue><i>-- gates where they are known to be unnecessary. This is a relatively</i></font>
<a name="line-1515"></a><font color=Blue><i>-- low-level function and should not normally be called directly by</i></font>
<a name="line-1516"></a><font color=Blue><i>-- user code. Instead, it is safer to use a higher-level function such</i></font>
<a name="line-1517"></a><font color=Blue><i>-- as 'with_basis_change'. However, the 'without_controls' operator is</i></font>
<a name="line-1518"></a><font color=Blue><i>-- useful in certain situations, e.g., it can be used to preserve the</i></font>
<a name="line-1519"></a><font color=Blue><i>-- 'NoControlFlag' when defining transformers.</i></font>
<a name="line-1520"></a><font color=Blue><i>-- </i></font>
<a name="line-1521"></a><font color=Blue><i>-- Usage:</i></font>
<a name="line-1522"></a><font color=Blue><i>-- </i></font>
<a name="line-1523"></a><font color=Blue><i>-- &gt; without_controls $ do </i></font>
<a name="line-1524"></a><font color=Blue><i>-- &gt;   &lt;&lt;code block&gt;&gt;</i></font>
<a name="line-1525"></a><font color=Blue><i>-- </i></font>
<a name="line-1526"></a><font color=Blue><i>-- or:</i></font>
<a name="line-1527"></a><font color=Blue><i>-- </i></font>
<a name="line-1528"></a><font color=Blue><i>-- &gt; without_controls (gate)</i></font>
<a name="line-1529"></a><font color=Blue><i>-- </i></font>
<a name="line-1530"></a><font color=Blue><i>-- Note that all controls specified in the /surrounding/ code are</i></font>
<a name="line-1531"></a><font color=Blue><i>-- disabled within the 'without_controls' block. This is even true if</i></font>
<a name="line-1532"></a><font color=Blue><i>-- the 'without_controls' block appears in a subroutine, and the</i></font>
<a name="line-1533"></a><font color=Blue><i>-- subroutine is later called in a controlled context. On the other</i></font>
<a name="line-1534"></a><font color=Blue><i>-- hand, it is possible to specify controls /inside/ the</i></font>
<a name="line-1535"></a><font color=Blue><i>-- 'without_controls' block. Consider this example:</i></font>
<a name="line-1536"></a><font color=Blue><i>-- </i></font>
<a name="line-1537"></a><font color=Blue><i>-- &gt; my_subcircuit = do</i></font>
<a name="line-1538"></a><font color=Blue><i>-- &gt;   gate1</i></font>
<a name="line-1539"></a><font color=Blue><i>-- &gt;   without_controls $ do {</i></font>
<a name="line-1540"></a><font color=Blue><i>-- &gt;     gate2</i></font>
<a name="line-1541"></a><font color=Blue><i>-- &gt;     gate3 `controlled` &lt;&lt;controls1&gt;&gt;</i></font>
<a name="line-1542"></a><font color=Blue><i>-- &gt;   }</i></font>
<a name="line-1543"></a><font color=Blue><i>-- &gt;   gate4</i></font>
<a name="line-1544"></a><font color=Blue><i>-- &gt;</i></font>
<a name="line-1545"></a><font color=Blue><i>-- &gt; my_circuit = do</i></font>
<a name="line-1546"></a><font color=Blue><i>-- &gt;   my_subcircuit `controlled` &lt;&lt;controls2&gt;&gt;</i></font>
<a name="line-1547"></a><font color=Blue><i>-- </i></font>
<a name="line-1548"></a><font color=Blue><i>-- In this example, controls 1 will be applied to gate 3, controls 2</i></font>
<a name="line-1549"></a><font color=Blue><i>-- will be applied to gates 1 and 4, and no controls will be applied</i></font>
<a name="line-1550"></a><font color=Blue><i>-- to gate 2.</i></font>
<a name="line-1551"></a><font color=Blue>without_controls</font> <font color=Red>::</font> Circ a <font color=Red>-&gt;</font> Circ a
<a name="line-1552"></a><font color=Blue>without_controls</font> code <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1553"></a>  clist_old <font color=Red>&lt;-</font> get_clist
<a name="line-1554"></a>  ncflag_old <font color=Red>&lt;-</font> get_ncflag
<a name="line-1555"></a>  set_clist clist_empty
<a name="line-1556"></a>  set_ncflag True
<a name="line-1557"></a>  a <font color=Red>&lt;-</font> code
<a name="line-1558"></a>  set_clist clist_old
<a name="line-1559"></a>  set_ncflag ncflag_old
<a name="line-1560"></a>  return a
<a name="line-1561"></a>  
<a name="line-1562"></a><a name="without_controls_if"></a><font color=Blue><i>-- | Apply 'without_controls' if 'NoControlFlag' is 'True', otherwise</i></font>
<a name="line-1563"></a><font color=Blue><i>-- do nothing.</i></font>
<a name="line-1564"></a><font color=Blue>without_controls_if</font> <font color=Red>::</font> NoControlFlag <font color=Red>-&gt;</font> Circ a <font color=Red>-&gt;</font> Circ a
<a name="line-1565"></a><font color=Blue>without_controls_if</font> True <font color=Red>=</font> without_controls
<a name="line-1566"></a><font color=Blue>without_controls_if</font> False <font color=Red>=</font> id
<a name="line-1567"></a>
<a name="line-1568"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1569"></a><font color=Blue><i>-- ** Deprecated special cases of without_controls</i></font>
<a name="line-1570"></a>
<a name="line-1571"></a><a name="qinit_qubit_ancilla"></a><font color=Blue><i>-- | Generate a new qubit, initialized to the parameter 'Bool', that</i></font>
<a name="line-1572"></a><font color=Blue><i>--   is guaranteed to be used as an ancilla and terminated with</i></font>
<a name="line-1573"></a><font color=Blue><i>--   'qterm_qubit_ancilla'. Deprecated.</i></font>
<a name="line-1574"></a><font color=Blue>qinit_qubit_ancilla</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Circ Qubit
<a name="line-1575"></a><font color=Blue>qinit_qubit_ancilla</font> b <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1576"></a>  without_controls <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1577"></a>    qinit_qubit b
<a name="line-1578"></a>
<a name="line-1579"></a><a name="qterm_qubit_ancilla"></a><font color=Blue><i>-- | Terminate an ancilla asserted to be in state /b/. Deprecated.</i></font>
<a name="line-1580"></a><font color=Blue>qterm_qubit_ancilla</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> Qubit <font color=Red>-&gt;</font> Circ ()
<a name="line-1581"></a><font color=Blue>qterm_qubit_ancilla</font> b q <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1582"></a>  without_controls <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1583"></a>    qterm_qubit b q
<a name="line-1584"></a>
<a name="line-1585"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-1586"></a><font color=Blue><i>-- * Circuit transformers</i></font>
<a name="line-1587"></a>
<a name="line-1588"></a><a name="identity_transformer"></a><font color=Blue><i>-- | The identity transformer. This just maps a low-level circuits to</i></font>
<a name="line-1589"></a><font color=Blue><i>-- the corresponding circuit-generating function. It can also be used</i></font>
<a name="line-1590"></a><font color=Blue><i>-- as a building block in other transformers, to define \"catch-all\"</i></font>
<a name="line-1591"></a><font color=Blue><i>-- clauses for gates that don't need to be transformed.</i></font>
<a name="line-1592"></a><font color=Blue>identity_transformer</font> <font color=Red>::</font> Transformer Circ Qubit Bit
<a name="line-1593"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QGate name <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> inv ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1594"></a>  <font color=Red>\</font>ws vs c <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1595"></a>    <font color=Cyan>(</font>ws'<font color=Cyan>,</font> vs'<font color=Cyan>)</font> <font color=Red>&lt;-</font> named_gate_qulist name inv ws vs <font color=Cyan>`controlled`</font> c
<a name="line-1596"></a>    return <font color=Cyan>(</font>ws'<font color=Cyan>,</font> vs'<font color=Cyan>,</font> c<font color=Cyan>)</font>
<a name="line-1597"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QRot name <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> inv t ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1598"></a>  <font color=Red>\</font>ws vs c <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1599"></a>    <font color=Cyan>(</font>ws'<font color=Cyan>,</font> vs'<font color=Cyan>)</font> <font color=Red>&lt;-</font> named_rotation_qulist name inv t ws vs <font color=Cyan>`controlled`</font> c
<a name="line-1600"></a>    return <font color=Cyan>(</font>ws'<font color=Cyan>,</font> vs'<font color=Cyan>,</font> c<font color=Cyan>)</font>
<a name="line-1601"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_GPhase t ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1602"></a>  <font color=Red>\</font>qs c <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1603"></a>    global_phase_anchored_list t qs <font color=Cyan>`controlled`</font> c
<a name="line-1604"></a>    return c
<a name="line-1605"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_CNot ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1606"></a>  <font color=Red>\</font>q c <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1607"></a>    q' <font color=Red>&lt;-</font> cnot q <font color=Cyan>`controlled`</font> c
<a name="line-1608"></a>    return <font color=Cyan>(</font>q'<font color=Cyan>,</font> c<font color=Cyan>)</font>
<a name="line-1609"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_CGate name ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1610"></a>  <font color=Red>\</font>ws <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>    
<a name="line-1611"></a>    v <font color=Red>&lt;-</font> cgate name ws
<a name="line-1612"></a>    return <font color=Cyan>(</font>v<font color=Cyan>,</font> ws<font color=Cyan>)</font>
<a name="line-1613"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_CGateInv name ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1614"></a>  <font color=Red>\</font>v ws <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>    
<a name="line-1615"></a>    cgateinv name v ws
<a name="line-1616"></a>    return ws
<a name="line-1617"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_CSwap ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1618"></a>  <font color=Red>\</font>w v c <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1619"></a>    <font color=Cyan>(</font>w'<font color=Cyan>,</font>v'<font color=Cyan>)</font> <font color=Red>&lt;-</font> swap_bit w v <font color=Cyan>`controlled`</font> c
<a name="line-1620"></a>    return <font color=Cyan>(</font>w'<font color=Cyan>,</font>v'<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-1621"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QPrep ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1622"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>    
<a name="line-1623"></a>    v <font color=Red>&lt;-</font> prepare_qubit w
<a name="line-1624"></a>    return v
<a name="line-1625"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QUnprep ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>    
<a name="line-1626"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>    
<a name="line-1627"></a>    v <font color=Red>&lt;-</font> unprepare_qubit w
<a name="line-1628"></a>    return v
<a name="line-1629"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QInit b ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1630"></a>  without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1631"></a>    w <font color=Red>&lt;-</font> qinit_qubit b
<a name="line-1632"></a>    return w
<a name="line-1633"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_CInit b ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1634"></a>  without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1635"></a>    w <font color=Red>&lt;-</font> cinit_bit b
<a name="line-1636"></a>    return w
<a name="line-1637"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QTerm b ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1638"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1639"></a>    qterm_qubit b w
<a name="line-1640"></a>    return ()
<a name="line-1641"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_CTerm b ncf f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1642"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1643"></a>    cterm_bit b w
<a name="line-1644"></a>    return ()
<a name="line-1645"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QMeas f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>    
<a name="line-1646"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1647"></a>    v <font color=Red>&lt;-</font> measure_qubit w
<a name="line-1648"></a>    return v
<a name="line-1649"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_QDiscard f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1650"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1651"></a>    qdiscard_qubit w
<a name="line-1652"></a>    return ()
<a name="line-1653"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_CDiscard f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1654"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1655"></a>    cdiscard_bit w
<a name="line-1656"></a>    return ()
<a name="line-1657"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_DTerm b f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1658"></a>  <font color=Red>\</font>w <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1659"></a>    dterm_bit b w
<a name="line-1660"></a>    return ()
<a name="line-1661"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_Subroutine n inv ncf scf ws_pat a1 vs_pat a2 rep f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1662"></a>  <font color=Red>\</font>namespace ws c <font color=Red>-&gt;</font> without_controls_if ncf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1663"></a>    provide_subroutines namespace
<a name="line-1664"></a>    vs <font color=Red>&lt;-</font> subroutine n inv scf rep ws_pat a1 vs_pat a2 ws <font color=Cyan>`controlled`</font> c
<a name="line-1665"></a>    return <font color=Cyan>(</font>vs<font color=Cyan>,</font>c<font color=Cyan>)</font>
<a name="line-1666"></a><font color=Blue>identity_transformer</font> <font color=Cyan>(</font>T_Comment s inv f<font color=Cyan>)</font> <font color=Red>=</font> f <font color=Cyan>$</font>
<a name="line-1667"></a>  <font color=Red>\</font>ws <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1668"></a>    comment_label s inv <font color=Red>[</font> <font color=Cyan>(</font>wire_of_endpoint e<font color=Cyan>,</font> s<font color=Cyan>)</font> <font color=Red>|</font> <font color=Cyan>(</font>e<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>&lt;-</font> ws <font color=Red>]</font>
<a name="line-1669"></a>    return ()
<a name="line-1670"></a>
<a name="line-1671"></a><a name="identity_dynamic_transformer_with_lift"></a><font color=Blue><i>-- | The identity transformer can be enriched with a dynamic lifting operation, so</i></font>
<a name="line-1672"></a><font color=Blue><i>-- as to define a DynamicTransformer</i></font>
<a name="line-1673"></a><font color=Blue>identity_dynamic_transformer_with_lift</font> <font color=Red>::</font> <font color=Cyan>(</font>Bit <font color=Red>-&gt;</font> Circ Bool<font color=Cyan>)</font> <font color=Red>-&gt;</font> DynamicTransformer Circ Qubit Bit
<a name="line-1674"></a><font color=Blue>identity_dynamic_transformer_with_lift</font> f <font color=Red>=</font> DT <font color=Cyan>{</font>
<a name="line-1675"></a>  transformer <font color=Red>=</font> identity_transformer<font color=Cyan>,</font>
<a name="line-1676"></a>  define_subroutine <font color=Red>=</font> <font color=Red>\</font>name typed_subroutine <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1677"></a>    s <font color=Red>&lt;-</font> get_namespace
<a name="line-1678"></a>    <font color=Green><u>let</u></font> s' <font color=Red>=</font> map_provide name typed_subroutine s
<a name="line-1679"></a>    set_namespace s'
<a name="line-1680"></a>    put_subroutine_definition name typed_subroutine<font color=Cyan>,</font>
<a name="line-1681"></a>  lifting_function <font color=Red>=</font> f
<a name="line-1682"></a> <font color=Cyan>}</font>
<a name="line-1683"></a>
<a name="line-1684"></a><a name="identity_dynamic_transformer"></a><font color=Blue><i>-- | The identity DynamicTransformer uses the built in do_read operation</i></font>
<a name="line-1685"></a><font color=Blue>identity_dynamic_transformer</font> <font color=Red>::</font> DynamicTransformer Circ Qubit Bit
<a name="line-1686"></a><font color=Blue>identity_dynamic_transformer</font> <font color=Red>=</font> 
<a name="line-1687"></a>  identity_dynamic_transformer_with_lift <font color=Cyan>(</font><font color=Red>\</font>b <font color=Red>-&gt;</font> do_read <font color=Cyan>(</font>wire_of_bit b<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1688"></a>
<a name="line-1689"></a><a name="identity_dynamic_transformer_constant"></a><font color=Blue><i>-- | We can define a dynamic transformer with a "constant" lifting function</i></font>
<a name="line-1690"></a><font color=Blue>identity_dynamic_transformer_constant</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> DynamicTransformer Circ Qubit Bit
<a name="line-1691"></a><font color=Blue>identity_dynamic_transformer_constant</font> b <font color=Red>=</font> identity_dynamic_transformer_with_lift <font color=Cyan>(</font><font color=Red>\</font><font color=Green><u>_</u></font> <font color=Red>-&gt;</font> return b<font color=Cyan>)</font> 
<a name="line-1692"></a>
<a name="line-1693"></a><a name="apply_circuit_with_bindings"></a><font color=Blue><i>-- | Append the entire circuit /c/ to the current circuit, using the</i></font>
<a name="line-1694"></a><font color=Blue><i>-- given bindings. Return the new bindings.</i></font>
<a name="line-1695"></a><font color=Blue>apply_circuit_with_bindings</font> <font color=Red>::</font> Circuit <font color=Red>-&gt;</font> <font color=Cyan>(</font>Bindings Qubit Bit<font color=Cyan>)</font> 
<a name="line-1696"></a>                            <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Bindings Qubit Bit<font color=Cyan>)</font>
<a name="line-1697"></a><font color=Blue>apply_circuit_with_bindings</font> c bindings <font color=Red>=</font>
<a name="line-1698"></a>  transform_circuit identity_transformer c bindings
<a name="line-1699"></a>
<a name="line-1700"></a><a name="apply_bcircuit_with_bindings"></a><font color=Blue><i>-- | Append the entire circuit /c/ to the current circuit, using the</i></font>
<a name="line-1701"></a><font color=Blue><i>-- given bindings, and return the new bindings.  </i></font>
<a name="line-1702"></a><font color=Blue><i>-- Also, add to the current namespace state any subroutines of /c/ </i></font>
<a name="line-1703"></a><font color=Blue><i>-- that are not already provided.</i></font>
<a name="line-1704"></a><font color=Blue>apply_bcircuit_with_bindings</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> <font color=Cyan>(</font>Bindings Qubit Bit<font color=Cyan>)</font> 
<a name="line-1705"></a>                             <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Bindings Qubit Bit<font color=Cyan>)</font>
<a name="line-1706"></a><font color=Blue>apply_bcircuit_with_bindings</font> <font color=Cyan>(</font>c<font color=Cyan>,</font>s<font color=Cyan>)</font> bindings <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1707"></a>  provide_subroutines s
<a name="line-1708"></a>  apply_circuit_with_bindings c bindings
<a name="line-1709"></a>
<a name="line-1710"></a><a name="apply_dbcircuit_with_bindings"></a><font color=Blue><i>-- | Append the entire dynamic circuit /c/ to the current circuit,</i></font>
<a name="line-1711"></a><font color=Blue><i>-- using the given bindings, and return the new bindings.  Also, add</i></font>
<a name="line-1712"></a><font color=Blue><i>-- to the current namespace state any subroutines of /c/ that are not</i></font>
<a name="line-1713"></a><font color=Blue><i>-- already provided.</i></font>
<a name="line-1714"></a><font color=Blue>apply_dbcircuit_with_bindings</font> <font color=Red>::</font> DBCircuit a <font color=Red>-&gt;</font> Bindings Qubit Bit
<a name="line-1715"></a>                                 <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>Bindings Qubit Bit<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1716"></a><font color=Blue>apply_dbcircuit_with_bindings</font> dbcircuit bindings <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1717"></a>  <font color=Blue><i>-- until the transformer interface is updated to work with dynamic</i></font>
<a name="line-1718"></a>  <font color=Blue><i>-- circuits, we have to go the route of converting to a static</i></font>
<a name="line-1719"></a>  <font color=Blue><i>-- circuit first. Unfortunately, this means that any dynamic</i></font>
<a name="line-1720"></a>  <font color=Blue><i>-- liftings will given an error.</i></font>
<a name="line-1721"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font>bcircuit<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> bcircuit_of_static_dbcircuit errmsg dbcircuit
<a name="line-1722"></a>  out_bindings <font color=Red>&lt;-</font> apply_bcircuit_with_bindings bcircuit bindings
<a name="line-1723"></a>  return <font color=Cyan>(</font>out_bindings<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1724"></a>  <font color=Green><u>where</u></font>
<a name="line-1725"></a>    errmsg x <font color=Red>=</font> <font color=Magenta>"apply_dbcircuit_with_bindings: operation unimplemented: "</font> <font color=Cyan>++</font> x
<a name="line-1726"></a>  
<a name="line-1727"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-1728"></a><font color=Blue><i>-- * Encapsulated circuits</i></font>
<a name="line-1729"></a>
<a name="line-1730"></a><a name="extract_in_context"></a><font color=Blue><i>-- | Similar to 'extract_simple', except we take the current output arity</i></font>
<a name="line-1731"></a><font color=Blue><i>-- of the /current/ circuit and make that the input arity of the</i></font>
<a name="line-1732"></a><font color=Blue><i>-- extracted circuit. Therefore, endpoints defined in the current</i></font>
<a name="line-1733"></a><font color=Blue><i>-- context can be used in /f/. This is a low-level operator, intended</i></font>
<a name="line-1734"></a><font color=Blue><i>-- for the construction of primitives, such as 'with_computed' or</i></font>
<a name="line-1735"></a><font color=Blue><i>-- 'with_basis_change', where the inner block can re-use some</i></font>
<a name="line-1736"></a><font color=Blue><i>-- variables without declaring them explicitly.</i></font>
<a name="line-1737"></a><font color=Blue><i>--</i></font>
<a name="line-1738"></a><font color=Blue><i>-- We also reuse the namespace of the current context, to avoid</i></font>
<a name="line-1739"></a><font color=Blue><i>-- recomputation of shared subroutines. </i></font>
<a name="line-1740"></a><font color=Blue><i>-- </i></font>
<a name="line-1741"></a><font color=Blue><i>-- As a special feature, also return the set of \"dirty\" wires, i.e.,</i></font>
<a name="line-1742"></a><font color=Blue><i>-- wires that were used during the execution of the body, but are free</i></font>
<a name="line-1743"></a><font color=Blue><i>-- at the end.</i></font>
<a name="line-1744"></a><font color=Blue>extract_in_context</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> Circ a <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>BCircuit<font color=Cyan>,</font> IntSet<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1745"></a><font color=Blue>extract_in_context</font> e f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1746"></a>  arity <font color=Red>&lt;-</font> get_arity
<a name="line-1747"></a>  cur_namespace <font color=Red>&lt;-</font> get_namespace
<a name="line-1748"></a>  <font color=Green><u>let</u></font> arity' <font color=Red>=</font> xintmap_makeclean arity
<a name="line-1749"></a>   <font color=Blue><i>-- f' :: Circ (a, ExtArity)</i></font>
<a name="line-1750"></a>      f' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1751"></a>        set_namespace cur_namespace
<a name="line-1752"></a>        a <font color=Red>&lt;-</font> f
<a name="line-1753"></a>        extarity <font color=Red>&lt;-</font> get_arity
<a name="line-1754"></a>        return <font color=Cyan>(</font>a<font color=Cyan>,</font> extarity<font color=Cyan>)</font>
<a name="line-1755"></a>      <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> <font color=Red>~</font><font color=Cyan>(</font>a<font color=Cyan>,</font> extarity<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> extract_simple e arity' f'
<a name="line-1756"></a>  return <font color=Cyan>(</font>bcirc<font color=Cyan>,</font> xintmap_dirty extarity<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1757"></a>
<a name="line-1758"></a><a name="extract_in_current_namespace"></a><font color=Blue><i>-- | Intermediate between 'extract_simple' and 'extract_in_context':</i></font>
<a name="line-1759"></a><font color=Blue><i>-- we build the circuit in the namespace of the current circuit, to </i></font>
<a name="line-1760"></a><font color=Blue><i>-- avoid recomputing any shared subroutines.</i></font>
<a name="line-1761"></a><font color=Blue>extract_in_current_namespace</font> <font color=Red>::</font> ErrMsg <font color=Red>-&gt;</font> ExtArity <font color=Red>-&gt;</font> Circ a <font color=Red>-&gt;</font> Circ <font color=Cyan>(</font>BCircuit<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-1762"></a><font color=Blue>extract_in_current_namespace</font> e arity f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1763"></a>  cur_namespace <font color=Red>&lt;-</font> get_namespace
<a name="line-1764"></a>  return <font color=Cyan>$</font> extract_simple e arity <font color=Cyan>$</font> <font color=Cyan>(</font>set_namespace cur_namespace<font color=Cyan>)</font> <font color=Cyan>&gt;&gt;</font> f
<a name="line-1765"></a>
<a name="line-1766"></a><a name="unextract_in_context"></a><font color=Blue><i>-- | Append the 'BCircuit' to the end of the current circuit, using</i></font>
<a name="line-1767"></a><font color=Blue><i>-- the identity binding. This means, the input wires of 'BCircuit'</i></font>
<a name="line-1768"></a><font color=Blue><i>-- /must/ be endpoints in the current circuits. This typically happens</i></font>
<a name="line-1769"></a><font color=Blue><i>-- when 'BCircuit' was obtained from 'extract_in_context' in the</i></font>
<a name="line-1770"></a><font color=Blue><i>-- current context, or when 'BCircuit' is the inverse of a circuit</i></font>
<a name="line-1771"></a><font color=Blue><i>-- that has just been applied using 'unextract_in_context'. </i></font>
<a name="line-1772"></a><font color=Blue><i>-- </i></font>
<a name="line-1773"></a><font color=Blue><i>-- Note that this is a low-level function, intended for the</i></font>
<a name="line-1774"></a><font color=Blue><i>-- construction of user-level primitives such as 'with_computed' and</i></font>
<a name="line-1775"></a><font color=Blue><i>-- 'with_basis_change', and 'classical_to_reversible'. </i></font>
<a name="line-1776"></a><font color=Blue><i>-- </i></font>
<a name="line-1777"></a><font color=Blue><i>-- 'unextract_in_context' uses 'apply_gate' to do the appending,</i></font>
<a name="line-1778"></a><font color=Blue><i>-- so the current 'ControlList' and 'NoControlFlag' are respected.</i></font>
<a name="line-1779"></a><font color=Blue><i>-- However, it does not pass through the transformer interface, and</i></font>
<a name="line-1780"></a><font color=Blue><i>-- therefore low-level wire id's will be exactly preserved.</i></font>
<a name="line-1781"></a><font color=Blue>unextract_in_context</font> <font color=Red>::</font> BCircuit <font color=Red>-&gt;</font> Circ ()
<a name="line-1782"></a><font color=Blue>unextract_in_context</font> <font color=Cyan>(</font>c<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1783"></a>  provide_subroutines s
<a name="line-1784"></a>  <font color=Green><u>let</u></font> <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font>gs<font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>,</font><font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> c
<a name="line-1785"></a>  mapM_ apply_gate gs
<a name="line-1786"></a>
<a name="line-1787"></a><a name="reverse_encapsulated"></a><font color=Blue><i>-- | Reverse an encapsulated circuit</i></font>
<a name="line-1788"></a><font color=Blue><i>-- </i></font>
<a name="line-1789"></a><font color=Blue><i>-- An encapsulated circuit is a circuit together with data structures</i></font>
<a name="line-1790"></a><font color=Blue><i>-- holding the input endpoints and output endpoints.  The type of the</i></font>
<a name="line-1791"></a><font color=Blue><i>-- encapsulated circuit depends on the type of data in the endpoints,</i></font>
<a name="line-1792"></a><font color=Blue><i>-- so functions to encapsulate and unencapsulate circuits are provided</i></font>
<a name="line-1793"></a><font color=Blue><i>-- in "Quipper.Generic".</i></font>
<a name="line-1794"></a><font color=Blue>reverse_encapsulated</font> <font color=Red>::</font> <font color=Cyan>(</font>i<font color=Cyan>,</font> BCircuit<font color=Cyan>,</font> o<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>o<font color=Cyan>,</font> BCircuit<font color=Cyan>,</font> i<font color=Cyan>)</font>
<a name="line-1795"></a><font color=Blue>reverse_encapsulated</font> <font color=Cyan>(</font>in_bind<font color=Cyan>,</font> c<font color=Cyan>,</font> out_bind<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1796"></a>  <font color=Cyan>(</font>out_bind<font color=Cyan>,</font> reverse_bcircuit c<font color=Cyan>,</font> in_bind<font color=Cyan>)</font>
<a name="line-1797"></a>
<a name="line-1798"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1799"></a><font color=Blue><i>-- * Temporarily reserving wires</i></font>
<a name="line-1800"></a>
<a name="line-1801"></a><a name="with_reserve"></a><font color=Blue><i>-- | Perform the computation in the body, but temporarily reserve a</i></font>
<a name="line-1802"></a><font color=Blue><i>-- set of wires. These wires must be initially free, and they must not</i></font>
<a name="line-1803"></a><font color=Blue><i>-- be used by the body (i.e., the body must respect reserved wires).</i></font>
<a name="line-1804"></a><font color=Blue>with_reserve</font> <font color=Red>::</font> IntSet <font color=Red>-&gt;</font> Circ a <font color=Red>-&gt;</font> Circ a
<a name="line-1805"></a><font color=Blue>with_reserve</font> ws body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1806"></a>  arity <font color=Red>&lt;-</font> get_arity
<a name="line-1807"></a>  <font color=Green><u>let</u></font> arity1 <font color=Red>=</font> xintmap_reserves ws arity
<a name="line-1808"></a>  set_arity arity1
<a name="line-1809"></a>  a <font color=Red>&lt;-</font> body
<a name="line-1810"></a>  arity2 <font color=Red>&lt;-</font> get_arity            <font color=Blue><i>-- they should still be reserved</i></font>
<a name="line-1811"></a>  <font color=Green><u>let</u></font> arity3 <font color=Red>=</font> xintmap_unreserves ws arity2
<a name="line-1812"></a>  set_arity arity3
<a name="line-1813"></a>  return a
</pre>
</body>
</html>