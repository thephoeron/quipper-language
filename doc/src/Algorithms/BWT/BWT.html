<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>-- | This module provides an implementation of the main binary welded</i></font>
<a name="line-2"></a><font color=Blue><i>-- tree algorithm and oracle, using a more-or-less imperative</i></font>
<a name="line-3"></a><font color=Blue><i>-- programming style. We abstract the oracle into a data type, so that</i></font>
<a name="line-4"></a><font color=Blue><i>-- different oracles can be plugged into the main algorithm.</i></font>
<a name="line-5"></a>
<a name="line-6"></a><font color=Green><u>module</u></font> Algorithms<font color=Cyan>.</font>BWT<font color=Cyan>.</font>BWT <font color=Green><u>where</u></font>
<a name="line-7"></a>
<a name="line-8"></a><font color=Blue><i>-- import other Quipper stuff</i></font>
<a name="line-9"></a><font color=Green><u>import</u></font> Quipper
<a name="line-10"></a><font color=Green><u>import</u></font> Algorithms<font color=Cyan>.</font>BWT<font color=Cyan>.</font>Definitions
<a name="line-11"></a>
<a name="line-12"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>Qureg
<a name="line-13"></a><font color=Green><u>import</u></font> QuipperLib<font color=Cyan>.</font>Decompose
<a name="line-14"></a>
<a name="line-15"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary
<a name="line-16"></a>
<a name="line-17"></a><font color=Green><u>import</u></font> Text<font color=Cyan>.</font>Printf
<a name="line-18"></a>
<a name="line-19"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-20"></a><font color=Blue><i>-- * Oracle abstraction</i></font>
<a name="line-21"></a>
<a name="line-22"></a><font color=Blue><i>-- | A data structure to hold an oracle. The binary welded tree</i></font>
<a name="line-23"></a><font color=Blue><i>-- algorithm is parametric on an oracle. An oracle encodes a graph,</i></font>
<a name="line-24"></a><font color=Blue><i>-- and provides the following information: the tree depth /n/ (in the</i></font>
<a name="line-25"></a><font color=Blue><i>-- above example: 3), the label length /m/ (in bits; 5 in the above</i></font>
<a name="line-26"></a><font color=Blue><i>-- example), the number of edge colors /k/, the entrance label</i></font>
<a name="line-27"></a><font color=Blue><i>-- /ENTRANCE/, and for each color 0 &#8804; /c/ &lt; /k/, a reversible circuit</i></font>
<a name="line-28"></a><font color=Blue><i>-- /ORACLE/[sub /c/](/a/,/b/,/r/). On basis vectors, this circuit</i></font>
<a name="line-29"></a><font color=Blue><i>-- encodes the edge information in the following sense:</i></font>
<a name="line-30"></a><font color=Blue><i>-- </i></font>
<a name="line-31"></a><font color=Blue><i>-- &gt; ORACLE[sub c](a, b, r) = (a, b &#8853; v[sub c](a), r &#8853; f[sub c](a)),</i></font>
<a name="line-32"></a><font color=Blue><i>-- </i></font>
<a name="line-33"></a><font color=Blue><i>-- where /f/[sub /c/](/a/) is 1 if the node /a/ is connected to an</i></font>
<a name="line-34"></a><font color=Blue><i>-- edge of color /c/, and 0 otherwise; and /v/[sub /c/](a) is the</i></font>
<a name="line-35"></a><font color=Blue><i>-- node label connected to node /a/ along an edge of color /c/ (if</i></font>
<a name="line-36"></a><font color=Blue><i>-- any), and arbitrary otherwise. </i></font>
<a name="line-37"></a><font color=Blue><i>-- </i></font>
<a name="line-38"></a><font color=Blue><i>-- Not all available node labels need to be used (for example, 0 and</i></font>
<a name="line-39"></a><font color=Blue><i>-- 16 are unused in the graph in the above illustration).</i></font>
<a name="line-40"></a>
<a name="line-41"></a><a name="Oracle"></a><font color=Green><u>data</u></font> Oracle <font color=Red>=</font> Oracle <font color=Cyan>{</font>
<a name="line-42"></a>    n <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-43"></a>    m <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-44"></a>    k <font color=Red>::</font> Int<font color=Cyan>,</font>
<a name="line-45"></a>    entrance <font color=Red>::</font> Boollist<font color=Cyan>,</font>
<a name="line-46"></a>    oraclefun <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-47"></a><font color=Cyan>}</font>
<a name="line-48"></a>
<a name="line-49"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-50"></a><font color=Blue><i>-- * Top-level algorithm</i></font>
<a name="line-51"></a>
<a name="line-52"></a><font color=Blue><i>-- | The main loop of the binary welded tree algorithm. </i></font>
<a name="line-53"></a><font color=Blue><i>-- </i></font>
<a name="line-54"></a><font color=Blue><i>-- @qrwbwt oracle s dt@: Do a quantum random walk on the binary welded</i></font>
<a name="line-55"></a><font color=Blue><i>-- tree given by the oracle /oracle/, for /s/ times steps of length</i></font>
<a name="line-56"></a><font color=Blue><i>-- /dt/. Returns a bit list corresponding to the computed exit node</i></font>
<a name="line-57"></a><font color=Blue><i>-- label.</i></font>
<a name="line-58"></a>
<a name="line-59"></a><a name="qrwbwt"></a><font color=Blue>qrwbwt</font> <font color=Red>::</font> Oracle <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> Timestep <font color=Red>-&gt;</font> Circ <font color=Red>[</font>Bit<font color=Red>]</font>
<a name="line-60"></a><font color=Blue>qrwbwt</font> oracle s dt <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-61"></a>  comment <font color=Cyan>(</font>printf <font color=Magenta>"ENTER: qrwbwt (s=%d, dt=%.3e)"</font> s dt<font color=Cyan>)</font>
<a name="line-62"></a>  <font color=Blue><i>-- initialize a to the entrance label</i></font>
<a name="line-63"></a>  a <font color=Red>&lt;-</font> qinit_register <font color=Cyan>(</font>entrance oracle<font color=Cyan>)</font>
<a name="line-64"></a>  with_ancilla_reg <font color=Cyan>(</font>m oracle<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>b <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-65"></a>    with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>r <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-66"></a>      loopM_boxed_if <font color=Cyan>(</font>s <font color=Cyan>&gt;</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>"qrwbwt_loop"</font> s <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-67"></a>        for <font color=Magenta>0</font> <font color=Cyan>(</font>k oracle<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-68"></a>          <font color=Cyan>(</font>oraclefun oracle<font color=Cyan>)</font> c <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>)</font>
<a name="line-69"></a>          timestep <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>,</font> dt<font color=Cyan>,</font> m oracle<font color=Cyan>)</font>
<a name="line-70"></a>          <font color=Cyan>(</font>oraclefun oracle<font color=Cyan>)</font> c <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>)</font>
<a name="line-71"></a>        endfor
<a name="line-72"></a>        return <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font>
<a name="line-73"></a>      endfor
<a name="line-74"></a>  exit <font color=Red>&lt;-</font> qmeasure_register a
<a name="line-75"></a>  comment_with_label <font color=Magenta>"EXIT: qrwbwt"</font> exit <font color=Magenta>"exit"</font>
<a name="line-76"></a>  return exit
<a name="line-77"></a>
<a name="line-78"></a><a name="timestep"></a><font color=Blue><i>-- | @timestep (a, b, r, dt, m)@: Perform a single time step /dt/ of</i></font>
<a name="line-79"></a><font color=Blue><i>-- the quantum walk. This is done by iterating through each of the</i></font>
<a name="line-80"></a><font color=Blue><i>-- available edge colors, and performing a diffusion step for each</i></font>
<a name="line-81"></a><font color=Blue><i>-- color. Here, /a/ is an /m/-qubit registers holding (a superposition</i></font>
<a name="line-82"></a><font color=Blue><i>-- of) the current node label. /b/ is an /m/-qubit ancilla register,</i></font>
<a name="line-83"></a><font color=Blue><i>-- and /r/ is an ancilla qubit. Both /b/ and /r/ are expected to be</i></font>
<a name="line-84"></a><font color=Blue><i>-- initialized to |0&#9002; by the caller, and will be returned in state</i></font>
<a name="line-85"></a><font color=Blue><i>-- |0&#9002;.</i></font>
<a name="line-86"></a><font color=Blue>timestep</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Timestep<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-87"></a><font color=Blue>timestep</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>,</font> dt<font color=Cyan>,</font> m<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-88"></a>  comment_with_label <font color=Magenta>"ENTER: timestep"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font><font color=Magenta>"b"</font><font color=Cyan>,</font><font color=Magenta>"r"</font><font color=Cyan>)</font>
<a name="line-89"></a>  with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>h <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-90"></a>    for <font color=Magenta>0</font> <font color=Cyan>(</font>m<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>i <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-91"></a>      wGate <font color=Cyan>(</font>a<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>,</font> b<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-92"></a>    endfor
<a name="line-93"></a>    for <font color=Magenta>0</font> <font color=Cyan>(</font>m<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>i <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-94"></a>      toffoliGate <font color=Cyan>(</font>a<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>,</font> b<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>,</font> h<font color=Cyan>)</font>
<a name="line-95"></a>    endfor
<a name="line-96"></a>    controlledExpGate <font color=Cyan>(</font>dt<font color=Cyan>,</font> r<font color=Cyan>,</font> h<font color=Cyan>)</font>
<a name="line-97"></a>    for <font color=Cyan>(</font>m<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>i <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-98"></a>      toffoliGate <font color=Cyan>(</font>a<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>,</font> b<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>,</font> h<font color=Cyan>)</font>
<a name="line-99"></a>    endfor
<a name="line-100"></a>    for <font color=Cyan>(</font>m<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>i <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-101"></a>      wGateInverse <font color=Cyan>(</font>a<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>,</font> b<font color=Cyan>.!</font><font color=Cyan>(</font>i<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-102"></a>    endfor
<a name="line-103"></a>  comment_with_label <font color=Magenta>"EXIT: timestep"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font><font color=Magenta>"b"</font><font color=Cyan>,</font><font color=Magenta>"r"</font><font color=Cyan>)</font>
<a name="line-104"></a>  return ()
<a name="line-105"></a>
<a name="line-106"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-107"></a><font color=Blue><i>-- * Oracle implementation</i></font>
<a name="line-108"></a>
<a name="line-109"></a><font color=Blue><i>-- $ The functions in this section implement a particular oracle for a</i></font>
<a name="line-110"></a><font color=Blue><i>-- binary welded tree. The oracle is parametric on:</i></font>
<a name="line-111"></a><font color=Blue><i>-- </i></font>
<a name="line-112"></a><font color=Blue><i>-- * the tree depth /n/;</i></font>
<a name="line-113"></a><font color=Blue><i>-- </i></font>
<a name="line-114"></a><font color=Blue><i>-- * two \"welding vectors\" /f/ and /g/, specifying how the leaves of</i></font>
<a name="line-115"></a><font color=Blue><i>-- the two binary trees are connected to each other. Specifically, /f/</i></font>
<a name="line-116"></a><font color=Blue><i>-- and /g/ encode the permutations of leaves given by a &#8614; a &#8853; f and </i></font>
<a name="line-117"></a><font color=Blue><i>-- a &#8614; a + g, respectively, where \"&#8853;\" denotes bitwise exclusive or,</i></font>
<a name="line-118"></a><font color=Blue><i>-- and \"+\" denotes binary addition.</i></font>
<a name="line-119"></a>
<a name="line-120"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-121"></a><font color=Blue><i>-- ** Oracle subroutines</i></font>
<a name="line-122"></a>
<a name="line-123"></a><a name="oracle"></a><font color=Blue><i>-- | The top-level oracle circuit. The arguments are of the form (/a/,</i></font>
<a name="line-124"></a><font color=Blue><i>-- /b/, /r/, /color/, /f/, /g/, /n/), where /a/, /b/ are quantum</i></font>
<a name="line-125"></a><font color=Blue><i>-- registers of length /n/+2, /color/ is a boolean register of length</i></font>
<a name="line-126"></a><font color=Blue><i>-- 2, and /f/ and /g/ are boolean registers of length /n/.</i></font>
<a name="line-127"></a><font color=Blue>oracle</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-128"></a><font color=Blue>oracle</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>,</font> color<font color=Cyan>,</font> f<font color=Cyan>,</font> g<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-129"></a>  <font color=Green><u>let</u></font> c <font color=Red>=</font> int_of_boolreg_unsigned_le color <font color=Red>::</font> Int
<a name="line-130"></a>  comment_with_label <font color=Cyan>(</font>printf <font color=Magenta>"ENTER: oracle (color=%d)"</font> c<font color=Cyan>)</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font><font color=Magenta>"b"</font><font color=Cyan>,</font><font color=Magenta>"r"</font><font color=Cyan>)</font>
<a name="line-131"></a>  with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>root <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-132"></a>    with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>even <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-133"></a>      with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>isparent <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-134"></a>        with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>ischild <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-135"></a>          with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>direction <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-136"></a>            with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>ismatch <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-137"></a>              parseNodeRoot <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-138"></a>              parseNodeEven <font color=Cyan>(</font>a<font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-139"></a>              testIsParent <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> color<font color=Cyan>,</font> n<font color=Cyan>,</font> <font color=Magenta>1</font><font color=Cyan>,</font> ismatch<font color=Cyan>)</font>
<a name="line-140"></a>              testIsChild <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> color<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-141"></a>              setParent <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> isparent<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-142"></a>              setChild <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> f<font color=Cyan>,</font> g<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-143"></a>              with_controls <font color=Cyan>(</font>isparent <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> ischild <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-144"></a>                qnot_at r
<a name="line-145"></a>              <font color=Cyan>}</font>
<a name="line-146"></a>              testIsChild <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> color<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-147"></a>              testIsParent <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> color<font color=Cyan>,</font> n<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>,</font> ismatch<font color=Cyan>)</font>
<a name="line-148"></a>              parseNodeEven <font color=Cyan>(</font>a<font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-149"></a>              parseNodeRoot <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-150"></a>  comment_with_label <font color=Cyan>(</font>printf <font color=Magenta>"EXIT: oracle (color=%d)"</font> c<font color=Cyan>)</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font><font color=Magenta>"b"</font><font color=Cyan>,</font><font color=Magenta>"r"</font><font color=Cyan>)</font>
<a name="line-151"></a>  return ()
<a name="line-152"></a>
<a name="line-153"></a><a name="parseNodeRoot"></a><font color=Blue><i>-- | Input a node label /a/ of length at least /n/+1. Negate both</i></font>
<a name="line-154"></a><font color=Blue><i>-- /root/ and /even/ if /a/ is a root node.</i></font>
<a name="line-155"></a><font color=Blue>parseNodeRoot</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-156"></a><font color=Blue>parseNodeRoot</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-157"></a>  comment_with_label <font color=Magenta>"ENTER: parseNodeRoot"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"root"</font><font color=Cyan>,</font> <font color=Magenta>"even"</font><font color=Cyan>)</font>
<a name="line-158"></a>  with_ancilla_reg <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>scratch <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-159"></a>    for n <font color=Magenta>1</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font> 
<a name="line-160"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-161"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-162"></a>      <font color=Cyan>}</font>
<a name="line-163"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-164"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-165"></a>      <font color=Cyan>}</font>
<a name="line-166"></a>    endfor
<a name="line-167"></a>    with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-168"></a>      qnot_at root<font color=Cyan>;</font>
<a name="line-169"></a>      qnot_at even
<a name="line-170"></a>    <font color=Cyan>}</font>
<a name="line-171"></a>    for <font color=Magenta>1</font> n <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>    
<a name="line-172"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-173"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index <font color=Blue><i>-</i></font> <font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-174"></a>      <font color=Cyan>}</font>
<a name="line-175"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-176"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-177"></a>      <font color=Cyan>}</font>
<a name="line-178"></a>    endfor
<a name="line-179"></a>  comment_with_label <font color=Magenta>"EXIT: parseNodeRoot"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"root"</font><font color=Cyan>,</font> <font color=Magenta>"even"</font><font color=Cyan>)</font>
<a name="line-180"></a>  return ()
<a name="line-181"></a>      
<a name="line-182"></a><a name="parseNodeEven"></a><font color=Blue><i>-- | Input a node label /a/ of length at least /n/+1. Negate /even/</i></font>
<a name="line-183"></a><font color=Blue><i>-- if the node /a/ occurs at an even height in the tree.</i></font>
<a name="line-184"></a><font color=Blue>parseNodeEven</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-185"></a><font color=Blue>parseNodeEven</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> even<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-186"></a>  comment_with_label <font color=Magenta>"ENTER: parseNodeEven"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"even"</font><font color=Cyan>)</font>
<a name="line-187"></a>  with_ancilla_reg <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>scratch <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-188"></a>    for n <font color=Magenta>1</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-189"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-190"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>;</font>
<a name="line-191"></a>        with_controls <font color=Cyan>(</font>Prelude<font color=Cyan>.</font>even index<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-192"></a>          qnot_at even
<a name="line-193"></a>        <font color=Cyan>}</font>
<a name="line-194"></a>      <font color=Cyan>}</font>
<a name="line-195"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-196"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-197"></a>      <font color=Cyan>}</font>
<a name="line-198"></a>    endfor
<a name="line-199"></a>    for <font color=Magenta>1</font> n <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-200"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-201"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-202"></a>      <font color=Cyan>}</font>            
<a name="line-203"></a>      with_controls <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-204"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-205"></a>      <font color=Cyan>}</font>
<a name="line-206"></a>    endfor
<a name="line-207"></a>  comment_with_label <font color=Magenta>"EXIT: parseNodeEven"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> even<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"even"</font><font color=Cyan>)</font>
<a name="line-208"></a>  return ()
<a name="line-209"></a>
<a name="line-210"></a><a name="testIsParent"></a><font color=Blue><i>-- | Input a node label /a/ of length at least 1, and flags /root/</i></font>
<a name="line-211"></a><font color=Blue><i>-- and /even/ describing whether /a/ is a root and at an even level,</i></font>
<a name="line-212"></a><font color=Blue><i>-- respectively. Negate /isparent/ if /a/ has a parent of color</i></font>
<a name="line-213"></a><font color=Blue><i>-- /color/ in the tree. </i></font>
<a name="line-214"></a><font color=Blue><i>-- </i></font>
<a name="line-215"></a><font color=Blue><i>-- The qubit /ismatch/ is an ancilla, and /really/ is either 0 or</i></font>
<a name="line-216"></a><font color=Blue><i>-- 1. They are jointly used to control uncomputation, so that the</i></font>
<a name="line-217"></a><font color=Blue><i>-- following sequence will compute and then uncompute 'testIsParent':</i></font>
<a name="line-218"></a><font color=Blue><i>-- </i></font>
<a name="line-219"></a><font color=Blue><i>-- &gt; ismatch &lt;- qinit 0</i></font>
<a name="line-220"></a><font color=Blue><i>-- &gt; testIsParent (a, root, even, isparent, color, n, 1, ismatch)</i></font>
<a name="line-221"></a><font color=Blue><i>-- &gt; testIsParent (a, root, even, isparent, color, n, 0, ismatch)</i></font>
<a name="line-222"></a><font color=Blue><i>-- &gt; qterm 0 ismatch</i></font>
<a name="line-223"></a><font color=Blue>testIsParent</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>,</font> Int<font color=Cyan>,</font> Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-224"></a><font color=Blue>testIsParent</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> color<font color=Cyan>,</font> n<font color=Cyan>,</font> really<font color=Cyan>,</font> ismatch<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-225"></a>    <font color=Green><u>let</u></font> c <font color=Red>=</font> int_of_boolreg_unsigned_le color <font color=Red>::</font> Int
<a name="line-226"></a>    comment_with_label <font color=Cyan>(</font>printf <font color=Magenta>"ENTER: testIsParent (color=%d really=%d)"</font> c really<font color=Cyan>)</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> ismatch<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"root"</font><font color=Cyan>,</font> <font color=Magenta>"even"</font><font color=Cyan>,</font> <font color=Magenta>"isparent"</font><font color=Cyan>,</font> <font color=Magenta>"ismatch"</font><font color=Cyan>)</font>
<a name="line-227"></a>    with_controls <font color=Cyan>(</font>really <font color=Cyan>==</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-228"></a>      with_controls <font color=Cyan>(</font>root <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> ismatch <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-229"></a>        qnot_at isparent
<a name="line-230"></a>      <font color=Cyan>}</font>
<a name="line-231"></a>    <font color=Cyan>}</font>
<a name="line-232"></a>    <font color=Green><u>if</u></font> color<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Green><u>then</u></font>
<a name="line-233"></a>      <font color=Green><u>if</u></font> color<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Green><u>then</u></font>
<a name="line-234"></a>        with_controls <font color=Cyan>(</font>even <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-235"></a>          qnot_at ismatch
<a name="line-236"></a>        <font color=Cyan>}</font>
<a name="line-237"></a>      <font color=Green><u>else</u></font>
<a name="line-238"></a>        with_controls <font color=Cyan>(</font>even <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-239"></a>          qnot_at ismatch
<a name="line-240"></a>        <font color=Cyan>}</font>
<a name="line-241"></a>    <font color=Green><u>else</u></font>
<a name="line-242"></a>      <font color=Green><u>if</u></font> color<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Green><u>then</u></font>
<a name="line-243"></a>        with_controls <font color=Cyan>(</font>even <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-244"></a>          qnot_at isparent
<a name="line-245"></a>        <font color=Cyan>}</font>
<a name="line-246"></a>      <font color=Green><u>else</u></font>
<a name="line-247"></a>        with_controls <font color=Cyan>(</font>even <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-248"></a>          qnot_at isparent
<a name="line-249"></a>        <font color=Cyan>}</font>
<a name="line-250"></a>    with_controls <font color=Cyan>(</font>root <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> ismatch <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-251"></a>      qnot_at isparent
<a name="line-252"></a>    <font color=Cyan>}</font>
<a name="line-253"></a>    comment_with_label <font color=Cyan>(</font>printf <font color=Magenta>"EXIT: testIsParent (color=%d really=%d)"</font> c really<font color=Cyan>)</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> root<font color=Cyan>,</font> even<font color=Cyan>,</font> isparent<font color=Cyan>,</font> ismatch<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"root"</font><font color=Cyan>,</font> <font color=Magenta>"even"</font><font color=Cyan>,</font> <font color=Magenta>"isparent"</font><font color=Cyan>,</font> <font color=Magenta>"ismatch"</font><font color=Cyan>)</font>
<a name="line-254"></a>    return ()
<a name="line-255"></a>
<a name="line-256"></a><a name="testIsChild"></a><font color=Blue><i>-- | Consider a node /a/, and negate /ischild/ if /a/ has a child</i></font>
<a name="line-257"></a><font color=Blue><i>-- node of color /color/. Also set /direction/ to indicate whether</i></font>
<a name="line-258"></a><font color=Blue><i>-- it is a \"left\" or \"right\" child. Here, /color/ is a boolean</i></font>
<a name="line-259"></a><font color=Blue><i>-- register of length 2, representing a color. This function is</i></font>
<a name="line-260"></a><font color=Blue><i>-- self-inverse.</i></font>
<a name="line-261"></a><font color=Blue>testIsChild</font> <font color=Red>::</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-262"></a><font color=Blue>testIsChild</font> <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> color<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-263"></a>  comment_with_label <font color=Magenta>"ENTER: testIsChild"</font> <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"even"</font><font color=Cyan>,</font> <font color=Magenta>"ischild"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-264"></a>  <font color=Green><u>if</u></font> color<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Green><u>then</u></font>
<a name="line-265"></a>    with_controls <font color=Cyan>(</font>even <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-266"></a>      qnot_at ischild
<a name="line-267"></a>    <font color=Cyan>}</font>
<a name="line-268"></a>  <font color=Green><u>else</u></font>
<a name="line-269"></a>    with_controls <font color=Cyan>(</font>even <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-270"></a>      qnot_at ischild
<a name="line-271"></a>    <font color=Cyan>}</font>
<a name="line-272"></a>  with_controls <font color=Cyan>(</font>color<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>==</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-273"></a>    qnot_at direction
<a name="line-274"></a>  <font color=Cyan>}</font>
<a name="line-275"></a>  comment_with_label <font color=Magenta>"EXIT: testIsChild"</font> <font color=Cyan>(</font>even<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"even"</font><font color=Cyan>,</font> <font color=Magenta>"ischild"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-276"></a>  return ()
<a name="line-277"></a>
<a name="line-278"></a><a name="setParent"></a><font color=Blue><i>-- | Input a node label /a/ of length at least /n/+2, and a flag</i></font>
<a name="line-279"></a><font color=Blue><i>-- /isparent/ that has been initialized accordingly. Also input a</i></font>
<a name="line-280"></a><font color=Blue><i>-- register /b/ of length at least /n/+2, initialized to |0&#9002;.  If</i></font>
<a name="line-281"></a><font color=Blue><i>-- /isparent/ is set, set /b/ to the node label of the parent of</i></font>
<a name="line-282"></a><font color=Blue><i>-- /a/. This is self-inverse.</i></font>
<a name="line-283"></a><font color=Blue>setParent</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-284"></a><font color=Blue>setParent</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> isparent<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-285"></a>  comment_with_label <font color=Magenta>"ENTER: setParent"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> isparent<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"isparent"</font><font color=Cyan>)</font>
<a name="line-286"></a>  for <font color=Magenta>0</font> <font color=Cyan>(</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-287"></a>    with_controls <font color=Cyan>(</font>isparent <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-288"></a>      qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-289"></a>    <font color=Cyan>}</font>
<a name="line-290"></a>  endfor
<a name="line-291"></a>  with_controls <font color=Cyan>(</font>isparent <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-292"></a>    qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-293"></a>  <font color=Cyan>}</font>
<a name="line-294"></a>  comment_with_label <font color=Magenta>"EXIT: setParent"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> isparent<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"isparent"</font><font color=Cyan>)</font>
<a name="line-295"></a>  return ()
<a name="line-296"></a>
<a name="line-297"></a><a name="setChild"></a><font color=Blue><i>-- | Similar to 'setParent', but set /b/ to the node label of the</i></font>
<a name="line-298"></a><font color=Blue><i>-- indicated child of /a/. Here /a/ and /b/ are quantum registers of</i></font>
<a name="line-299"></a><font color=Blue><i>-- length at least /n/+2, and /f/ and /g/ are boolean registers of</i></font>
<a name="line-300"></a><font color=Blue><i>-- length /n/.</i></font>
<a name="line-301"></a><font color=Blue>setChild</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-302"></a><font color=Blue>setChild</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>,</font> f<font color=Cyan>,</font> g<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-303"></a>  comment_with_label <font color=Magenta>"ENTER: setChild"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"ischild"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-304"></a>  with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>childctrl <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-305"></a>    with_controls <font color=Cyan>(</font>ischild <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-306"></a>      qnot_at childctrl
<a name="line-307"></a>    <font color=Cyan>}</font>
<a name="line-308"></a>    setWeld <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>,</font> f<font color=Cyan>,</font> g<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-309"></a>    with_controls <font color=Cyan>(</font>ischild <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-310"></a>      qnot_at childctrl
<a name="line-311"></a>    <font color=Cyan>}</font>
<a name="line-312"></a>    setChildInTree <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-313"></a>    with_controls <font color=Cyan>(</font>ischild <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-314"></a>      qnot_at childctrl
<a name="line-315"></a>    <font color=Cyan>}</font>
<a name="line-316"></a>  comment_with_label <font color=Magenta>"EXIT: setChild"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> ischild<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"ischild"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-317"></a>  return ()
<a name="line-318"></a>      
<a name="line-319"></a><a name="setChildInTree"></a><font color=Blue><i>-- | A special case of 'setChild', where the child is inside the same</i></font>
<a name="line-320"></a><font color=Blue><i>-- binary tree (i.e., not via the welding). </i></font>
<a name="line-321"></a><font color=Blue>setChildInTree</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-322"></a><font color=Blue>setChildInTree</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-323"></a>  comment_with_label <font color=Magenta>"ENTER: setChildInTree"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"childctrl"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-324"></a>  with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> direction <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-325"></a>    qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-326"></a>  <font color=Cyan>}</font>
<a name="line-327"></a>  for <font color=Magenta>1</font> n <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-328"></a>    with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-329"></a>      qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-330"></a>    <font color=Cyan>}</font>
<a name="line-331"></a>  endfor
<a name="line-332"></a>  with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-333"></a>    qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-334"></a>  <font color=Cyan>}</font>
<a name="line-335"></a>  comment_with_label <font color=Magenta>"EXIT: setChildInTree"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"childctrl"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-336"></a>  return ()
<a name="line-337"></a>
<a name="line-338"></a><a name="setWeld"></a><font color=Blue><i>-- | A special case of 'setChild', where the child is in the opposite</i></font>
<a name="line-339"></a><font color=Blue><i>-- binary tree, i.e., we follow one of the welding edges.</i></font>
<a name="line-340"></a><font color=Blue>setWeld</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-341"></a><font color=Blue>setWeld</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>,</font> f<font color=Cyan>,</font> g<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-342"></a>  comment_with_label <font color=Magenta>"ENTER: setWeld"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"childctrl"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-343"></a>  with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>weldctrl <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-344"></a>    with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> direction <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-345"></a>      qnot_at weldctrl
<a name="line-346"></a>    <font color=Cyan>}</font>
<a name="line-347"></a>    doWeld0 <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>,</font> f<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-348"></a>    with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-349"></a>      qnot_at weldctrl
<a name="line-350"></a>    <font color=Cyan>}</font>
<a name="line-351"></a>    doWeld1 <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>,</font> g<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-352"></a>    with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> direction <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-353"></a>      qnot_at weldctrl
<a name="line-354"></a>    <font color=Cyan>}</font>
<a name="line-355"></a>    with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-356"></a>      qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-357"></a>    <font color=Cyan>}</font>
<a name="line-358"></a>    with_controls <font color=Cyan>(</font>childctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-359"></a>      qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>)</font><font color=Cyan>)</font><font color=Cyan>;</font>
<a name="line-360"></a>      qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-361"></a>    <font color=Cyan>}</font>
<a name="line-362"></a>  comment_with_label <font color=Magenta>"EXIT: setWeld"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> childctrl<font color=Cyan>,</font> direction<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"childctrl"</font><font color=Cyan>,</font> <font color=Magenta>"direction"</font><font color=Cyan>)</font>
<a name="line-363"></a>  return ()
<a name="line-364"></a>
<a name="line-365"></a><a name="doWeld1"></a><font color=Blue><i>-- | Input a node label /a/, and a register /b/ initialized to</i></font>
<a name="line-366"></a><font color=Blue><i>-- |0&#9002;. If /weldctrl/ is set, set /b/ to the node connected to /a/</i></font>
<a name="line-367"></a><font color=Blue><i>-- by the welding function /f/. This is self-inverse. Here, /a/ and</i></font>
<a name="line-368"></a><font color=Blue><i>-- /b/ are quantum registers of length at least /n/+2, and /f/ is a</i></font>
<a name="line-369"></a><font color=Blue><i>-- boolean register of length /n/.</i></font>
<a name="line-370"></a><font color=Blue>doWeld1</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-371"></a><font color=Blue>doWeld1</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>,</font> f<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-372"></a>  comment_with_label <font color=Magenta>"ENTER: doWeld1"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"weldctrl"</font><font color=Cyan>)</font>
<a name="line-373"></a>  with_ancilla <font color=Cyan>$</font> <font color=Red>\</font>addsub <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-374"></a>    with_controls <font color=Cyan>(</font>weldctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-375"></a>      qnot_at addsub
<a name="line-376"></a>    <font color=Cyan>}</font>
<a name="line-377"></a>    cAddNum <font color=Cyan>(</font>addsub<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>,</font> f<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-378"></a>    with_controls <font color=Cyan>(</font>weldctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-379"></a>      qnot_at addsub
<a name="line-380"></a>    <font color=Cyan>}</font>
<a name="line-381"></a>    cSubNum <font color=Cyan>(</font>addsub<font color=Cyan>,</font> b<font color=Cyan>,</font> a<font color=Cyan>,</font> f<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-382"></a>    with_controls <font color=Cyan>(</font>weldctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-383"></a>      qnot_at addsub
<a name="line-384"></a>    <font color=Cyan>}</font>
<a name="line-385"></a>  comment_with_label <font color=Magenta>"EXIT: doWeld1"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"weldctrl"</font><font color=Cyan>)</font>
<a name="line-386"></a>  return ()
<a name="line-387"></a>
<a name="line-388"></a><a name="doWeld0"></a><font color=Blue><i>-- | Input a node label /a/, and a register /b/ initialized to</i></font>
<a name="line-389"></a><font color=Blue><i>-- |0&#9002;. If /weldctrl/ is set, set /b/ to the node connected to /a/</i></font>
<a name="line-390"></a><font color=Blue><i>-- by the welding function /g/. This is self-inverse. Here, /a/ and</i></font>
<a name="line-391"></a><font color=Blue><i>-- /b/ are quantum registers of length at least /n/+2, and /g/ is a</i></font>
<a name="line-392"></a><font color=Blue><i>-- boolean register of length /n/.</i></font>
<a name="line-393"></a><font color=Blue>doWeld0</font> <font color=Red>::</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-394"></a><font color=Blue>doWeld0</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>,</font> g<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-395"></a>  comment_with_label <font color=Magenta>"ENTER: doWeld0"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"weldctrl"</font><font color=Cyan>)</font>
<a name="line-396"></a>  for <font color=Magenta>0</font> <font color=Cyan>(</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-397"></a>    with_controls <font color=Cyan>(</font>weldctrl <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-398"></a>      qnot_at <font color=Cyan>(</font>b<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>`controlled`</font> a<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>./=.</font> g<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font>
<a name="line-399"></a>    <font color=Cyan>}</font>
<a name="line-400"></a>  endfor
<a name="line-401"></a>  comment_with_label <font color=Magenta>"EXIT: doWeld0"</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> weldctrl<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"a"</font><font color=Cyan>,</font> <font color=Magenta>"b"</font><font color=Cyan>,</font> <font color=Magenta>"weldctrl"</font><font color=Cyan>)</font>
<a name="line-402"></a>  return ()
<a name="line-403"></a>
<a name="line-404"></a><a name="cAddNum"></a><font color=Blue><i>-- | This function implements integer addition. Input a quantum</i></font>
<a name="line-405"></a><font color=Blue><i>-- register /input/ and a boolean register /num/, representing</i></font>
<a name="line-406"></a><font color=Blue><i>-- integers, and a quantum register /out/ initialized to |0&#9002;. If</i></font>
<a name="line-407"></a><font color=Blue><i>-- /control/ is set, set /out/ to /input/ + /num/, otherwise do</i></font>
<a name="line-408"></a><font color=Blue><i>-- nothing.  Here /input/ and /out/ are quantum registers of length at</i></font>
<a name="line-409"></a><font color=Blue><i>-- least /n/, /num/ is a boolean register of length /n/.</i></font>
<a name="line-410"></a><font color=Blue>cAddNum</font> <font color=Red>::</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-411"></a><font color=Blue>cAddNum</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> out<font color=Cyan>,</font> input<font color=Cyan>,</font> num<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-412"></a>  comment_with_label <font color=Magenta>"ENTER: cAddNum"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> out<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"out"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-413"></a>  <font color=Blue><i>-- we represent mask as 1 &lt;&lt; maskbit</i></font>
<a name="line-414"></a>  with_ancilla_reg n <font color=Cyan>$</font> <font color=Red>\</font>scratch <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-415"></a>    <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> <font color=Magenta>0</font>  <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-416"></a>    with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-417"></a>      qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-418"></a>    <font color=Cyan>}</font>
<a name="line-419"></a>    with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-420"></a>      with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-421"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-422"></a>      <font color=Cyan>}</font><font color=Cyan>;</font>
<a name="line-423"></a>      with_controls <font color=Cyan>(</font>input<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-424"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-425"></a>      <font color=Cyan>}</font>
<a name="line-426"></a>    <font color=Cyan>}</font>
<a name="line-427"></a>    for <font color=Magenta>1</font> <font color=Cyan>(</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-428"></a>      <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> index   <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-429"></a>      with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-430"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-431"></a>      <font color=Cyan>}</font>
<a name="line-432"></a>      with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> control <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-433"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-434"></a>      <font color=Cyan>}</font>
<a name="line-435"></a>      with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-436"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-437"></a>      <font color=Cyan>}</font>
<a name="line-438"></a>      with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-439"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-440"></a>      <font color=Cyan>}</font>
<a name="line-441"></a>      with_controls <font color=Cyan>(</font>input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-442"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-443"></a>      <font color=Cyan>}</font>
<a name="line-444"></a>      with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-445"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-446"></a>      <font color=Cyan>}</font>
<a name="line-447"></a>    endfor
<a name="line-448"></a>    cAddNumClear <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>,</font> num<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-449"></a>  comment_with_label <font color=Magenta>"EXIT: cAddNum"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> out<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"out"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-450"></a>  return ()
<a name="line-451"></a>
<a name="line-452"></a><a name="cAddNumClear"></a><font color=Blue><i>-- | A helper function for clearing the scratch space used by 'cAddNum'.</i></font>
<a name="line-453"></a><font color=Blue>cAddNumClear</font> <font color=Red>::</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-454"></a><font color=Blue>cAddNumClear</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>,</font> num<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-455"></a>  comment_with_label <font color=Magenta>"ENTER: cAddNumClear"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"scratch"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-456"></a>  <font color=Blue><i>-- we represent mask as 1 &lt;&lt; maskbit</i></font>
<a name="line-457"></a>  for <font color=Cyan>(</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-458"></a>    <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> index   <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-459"></a>    with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-460"></a>      qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-461"></a>    <font color=Cyan>}</font>
<a name="line-462"></a>    with_controls <font color=Cyan>(</font>input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-463"></a>      qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-464"></a>    <font color=Cyan>}</font>
<a name="line-465"></a>    with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-466"></a>      qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-467"></a>    <font color=Cyan>}</font>
<a name="line-468"></a>  endfor
<a name="line-469"></a>  <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> <font color=Magenta>0</font>  <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-470"></a>  with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-471"></a>    qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-472"></a>  <font color=Cyan>}</font>
<a name="line-473"></a>  comment_with_label <font color=Magenta>"EXIT: cAddNumClear"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"scratch"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-474"></a>  return ()
<a name="line-475"></a>
<a name="line-476"></a><a name="cSubNum"></a><font color=Blue><i>-- | Like 'cAddNum', except subtract instead of adding. </i></font>
<a name="line-477"></a><font color=Blue>cSubNum</font> <font color=Red>::</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-478"></a><font color=Blue>cSubNum</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> out<font color=Cyan>,</font> input<font color=Cyan>,</font> num<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-479"></a>  comment_with_label <font color=Magenta>"ENTER: cSubNum"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> out<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"out"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-480"></a>  <font color=Blue><i>-- we represent mask as 1 &lt;&lt; maskbit</i></font>
<a name="line-481"></a>  with_ancilla_reg n <font color=Cyan>$</font> <font color=Red>\</font>scratch <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-482"></a>    <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> <font color=Magenta>0</font>  <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-483"></a>    with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-484"></a>      qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-485"></a>    <font color=Cyan>}</font>
<a name="line-486"></a>    with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-487"></a>      with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-488"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-489"></a>      <font color=Cyan>}</font><font color=Cyan>;</font>
<a name="line-490"></a>      with_controls <font color=Cyan>(</font>input<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-491"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-492"></a>      <font color=Cyan>}</font>
<a name="line-493"></a>    <font color=Cyan>}</font>
<a name="line-494"></a>    for <font color=Magenta>1</font> <font color=Cyan>(</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-495"></a>      <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> index    <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-496"></a>      with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-497"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-498"></a>      <font color=Cyan>}</font>
<a name="line-499"></a>      with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> control <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-500"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-501"></a>      <font color=Cyan>}</font>
<a name="line-502"></a>      with_controls <font color=Cyan>(</font>control <font color=Cyan>.==.</font> <font color=Magenta>1</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-503"></a>        qnot_at <font color=Cyan>(</font>out<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-504"></a>      <font color=Cyan>}</font>
<a name="line-505"></a>      with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-506"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-507"></a>      <font color=Cyan>}</font>
<a name="line-508"></a>      with_controls <font color=Cyan>(</font>input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-509"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-510"></a>      <font color=Cyan>}</font>
<a name="line-511"></a>      with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-512"></a>        qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-513"></a>      <font color=Cyan>}</font>
<a name="line-514"></a>    endfor
<a name="line-515"></a>    cSubNumClear <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>,</font> num<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-516"></a>  comment_with_label <font color=Magenta>"EXIT: cSubNum"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> out<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"out"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-517"></a>  return ()
<a name="line-518"></a>
<a name="line-519"></a><a name="cSubNumClear"></a><font color=Blue><i>-- | A helper function for clearing the scratch space used by 'cSubNum'.</i></font>
<a name="line-520"></a><font color=Blue>cSubNumClear</font> <font color=Red>::</font> <font color=Cyan>(</font>Qubit<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Boolreg<font color=Cyan>,</font> Int<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-521"></a><font color=Blue>cSubNumClear</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>,</font> num<font color=Cyan>,</font> n<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-522"></a>  comment_with_label <font color=Magenta>"ENTER: cSubNumClear"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"scratch"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-523"></a>  <font color=Blue><i>-- we represent mask as 1 &lt;&lt; maskbit</i></font>
<a name="line-524"></a>  for <font color=Cyan>(</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Red>\</font>index <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-525"></a>    <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> index  <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-526"></a>    with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-527"></a>      qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-528"></a>    <font color=Cyan>}</font>
<a name="line-529"></a>    with_controls <font color=Cyan>(</font>input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-530"></a>      qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-531"></a>    <font color=Cyan>}</font>
<a name="line-532"></a>    with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-533"></a>      qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font>index<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-534"></a>    <font color=Cyan>}</font>
<a name="line-535"></a>  endfor
<a name="line-536"></a>  <font color=Green><u>let</u></font> maskbit <font color=Red>=</font> <font color=Magenta>0</font>  <font color=Blue><i>-- invariant: mask = 1 &lt;&lt; maskbit</i></font>
<a name="line-537"></a>  with_controls <font color=Cyan>(</font>num<font color=Cyan>.!</font><font color=Cyan>(</font>maskbit<font color=Cyan>)</font> <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Cyan>.&amp;&amp;.</font> input<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>.==.</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font> <font color=Cyan>{</font>
<a name="line-538"></a>    qnot_at <font color=Cyan>(</font>scratch<font color=Cyan>.!</font><font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-539"></a>  <font color=Cyan>}</font>
<a name="line-540"></a>  comment_with_label <font color=Magenta>"EXIT: cSubNumClear"</font> <font color=Cyan>(</font>control<font color=Cyan>,</font> scratch<font color=Cyan>,</font> input<font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>"control"</font><font color=Cyan>,</font> <font color=Magenta>"scratch"</font><font color=Cyan>,</font> <font color=Magenta>"input"</font><font color=Cyan>)</font>
<a name="line-541"></a>  return ()
<a name="line-542"></a>
<a name="line-543"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-544"></a><font color=Blue><i>-- ** The oracle data structure</i></font>
<a name="line-545"></a>
<a name="line-546"></a><a name="oracle_orthodox"></a><font color=Blue><i>-- | This function inputs two welding functions /f/ and /g/, and</i></font>
<a name="line-547"></a><font color=Blue><i>-- returns the oracle defined by the preceding functions. </i></font>
<a name="line-548"></a><font color=Blue><i>-- </i></font>
<a name="line-549"></a><font color=Blue><i>-- We call this the \"orthodox\" oracle, because the implementation</i></font>
<a name="line-550"></a><font color=Blue><i>-- follows its specification very closely. For example, it uses a very</i></font>
<a name="line-551"></a><font color=Blue><i>-- \"imperative\" programming style. For alternative implementations</i></font>
<a name="line-552"></a><font color=Blue><i>-- of this and other oracles, see the modules</i></font>
<a name="line-553"></a><font color=Blue><i>-- "Algorithms.BWT.Alternative" and "Algorithms.BWT.Template".</i></font>
<a name="line-554"></a><font color=Blue>oracle_orthodox</font> <font color=Red>::</font> Boollist <font color=Red>-&gt;</font> Boollist <font color=Red>-&gt;</font> Oracle
<a name="line-555"></a><font color=Blue>oracle_orthodox</font> f g <font color=Red>=</font>
<a name="line-556"></a>  Oracle <font color=Cyan>{</font> n <font color=Red>=</font> n<font color=Cyan>,</font>
<a name="line-557"></a>           m <font color=Red>=</font> m<font color=Cyan>,</font>
<a name="line-558"></a>           k <font color=Red>=</font> k<font color=Cyan>,</font>
<a name="line-559"></a>           entrance <font color=Red>=</font> entrance<font color=Cyan>,</font>
<a name="line-560"></a>           oraclefun <font color=Red>=</font> oraclefun
<a name="line-561"></a>         <font color=Cyan>}</font> <font color=Green><u>where</u></font>
<a name="line-562"></a>    n <font color=Red>=</font> length f
<a name="line-563"></a>    m <font color=Red>=</font> n<font color=Cyan>+</font><font color=Magenta>2</font>
<a name="line-564"></a>    k <font color=Red>=</font> <font color=Magenta>4</font>
<a name="line-565"></a>    entrance <font color=Red>=</font> boollist_of_int_bh m <font color=Magenta>1</font>
<a name="line-566"></a>    f_reg <font color=Red>=</font> boolreg_of_boollist_te f
<a name="line-567"></a>    g_reg <font color=Red>=</font> boolreg_of_boollist_te g
<a name="line-568"></a>    
<a name="line-569"></a>    oraclefun <font color=Red>::</font> Int <font color=Red>-&gt;</font> <font color=Cyan>(</font>Qureg<font color=Cyan>,</font> Qureg<font color=Cyan>,</font> Qubit<font color=Cyan>)</font> <font color=Red>-&gt;</font> Circ ()
<a name="line-570"></a>    oraclefun c <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-571"></a>      <font color=Green><u>let</u></font> color <font color=Red>=</font> boolreg_of_int_le <font color=Magenta>2</font> c
<a name="line-572"></a>      oracle <font color=Cyan>(</font>a<font color=Cyan>,</font> b<font color=Cyan>,</font> r<font color=Cyan>,</font> color<font color=Cyan>,</font> f_reg<font color=Cyan>,</font> g_reg<font color=Cyan>,</font> n<font color=Cyan>)</font>
<a name="line-573"></a>      return ()
<a name="line-574"></a>
<a name="line-575"></a><font color=Blue><i>-- ======================================================================</i></font>
<a name="line-576"></a><font color=Blue><i>-- * Main functions</i></font>
<a name="line-577"></a>
<a name="line-578"></a><font color=Blue><i>-- These functions are so that the user can output something.</i></font>
<a name="line-579"></a>
<a name="line-580"></a><a name="main_circuit"></a><font color=Blue><i>-- | Output the circuit for the quantum walk and a binary welded tree,</i></font>
<a name="line-581"></a><font color=Blue><i>-- for the given 'Oracle' in the specified 'Format' and using the</i></font>
<a name="line-582"></a><font color=Blue><i>-- specified 'GateBase'. Use /s/ time steps of length /dt/.</i></font>
<a name="line-583"></a><font color=Blue>main_circuit</font> <font color=Red>::</font> Format <font color=Red>-&gt;</font> GateBase <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> Timestep <font color=Red>-&gt;</font> IO()
<a name="line-584"></a><font color=Blue>main_circuit</font> format base oracle s dt <font color=Red>=</font>
<a name="line-585"></a>  print_generic format <font color=Cyan>(</font>decompose_generic base circuit<font color=Cyan>)</font>
<a name="line-586"></a>  <font color=Green><u>where</u></font>
<a name="line-587"></a>    circuit <font color=Red>=</font> qrwbwt oracle s dt
<a name="line-588"></a>
<a name="line-589"></a><a name="main_oracle"></a><font color=Blue><i>-- | Output the circuit for the given 'Oracle' and the given color</i></font>
<a name="line-590"></a><font color=Blue><i>-- (specified as an 'Int'). Use the specified output 'Format' and</i></font>
<a name="line-591"></a><font color=Blue><i>-- 'GateBase'.</i></font>
<a name="line-592"></a><font color=Blue>main_oracle</font> <font color=Red>::</font> Format <font color=Red>-&gt;</font> GateBase <font color=Red>-&gt;</font> Oracle <font color=Red>-&gt;</font> Int <font color=Red>-&gt;</font> IO()
<a name="line-593"></a><font color=Blue>main_oracle</font> format base oracle c <font color=Red>=</font>
<a name="line-594"></a>  <font color=Green><u>let</u></font> m' <font color=Red>=</font> m oracle 
<a name="line-595"></a>      ofun <font color=Red>=</font> oraclefun oracle
<a name="line-596"></a>      circuit <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>,</font>r<font color=Cyan>)</font> <font color=Red>-&gt;</font> ofun c <font color=Cyan>(</font>qureg_of_qulist_te a<font color=Cyan>,</font> qureg_of_qulist_te b<font color=Cyan>,</font> r<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-597"></a>  <font color=Green><u>in</u></font>
<a name="line-598"></a>   print_generic format <font color=Cyan>(</font>decompose_generic base circuit<font color=Cyan>)</font> <font color=Cyan>(</font>replicate m' qubit<font color=Cyan>,</font> replicate m' qubit<font color=Cyan>,</font> qubit<font color=Cyan>)</font>
</pre>
</body>
</html>